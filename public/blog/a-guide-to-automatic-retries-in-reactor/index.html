<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>A Guide to Automatic Retries in Reactor</title>
<meta
  name="description"
  content="The source code for this post is available on GitHub.
One of the nice things about a reactive programming model is there is a significantly lower risk of doomsday when things start getting latent all at once. You don&rsquo;t have threads upstream blocking and waiting for a response, therefore they won&rsquo;t all seize up and stop serving requests [or they won&rsquo;t short circuit if you&rsquo;re using a resiliency library like hystrix]."
/>
<link rel="canonical" href="http://localhost:1313/blog/a-guide-to-automatic-retries-in-reactor/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/img/nficon.png" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">A Guide to Automatic Retries in Reactor</h2>

    <div class="meta">
      
      <time datetime="2020-08-16 16:22:09 &#43;0000 UTC" title='Sun, Aug 16, 2020, 4:22 PM UTC'>
        16/08/2020 - Estimated reading time: 4 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>The source code for this post <a href="https://github.com/nfisher23/reactive-programming-webflux">is available on GitHub</a>.</p>
<p>One of the nice things about a reactive programming model is there is a significantly lower risk of doomsday when things start getting latent all at once. You don&rsquo;t have threads upstream blocking and waiting for a response, therefore they won&rsquo;t all seize up and stop serving requests [or they won&rsquo;t short circuit if you&rsquo;re using a resiliency library like hystrix].</p>
<p>Reactor has a lot of extension points to pretty easily retry in the case of failure. I&rsquo;ll go through a couple of the options and provide some sample code to help you get started in this tutorial.</p>
<h2 id="the-example-project">The Example Project</h2>
<p>I&rsquo;m going to extend some sample code from a previous blog post on <a href="https://nickolasfisher.com/blog/How-to-use-Mock-Server-to-End-to-End-Test-Any-WebClient-Calls-in-Spring-Boot-Webflux">testing WebClient using MockServer in Spring Boot Webflux</a> to bootstrap us here. Recall, in that post, we had a really simple service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Service
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MyService</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> WebClient webClient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">MyService</span>(WebClient webClient) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">webClient</span> <span style="color:#ff79c6">=</span> webClient;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Flux<span style="color:#ff79c6">&lt;</span>DownstreamResponseDTO<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">getAllPeople</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">webClient</span>.<span style="color:#50fa7b">get</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">uri</span>(<span style="color:#f1fa8c">&#34;/legacy/persons&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">retrieve</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">bodyToFlux</span>(DownstreamResponseDTO.<span style="color:#50fa7b">class</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We were using MockServer and binding our webclient to that mock server with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MyServiceTest</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> ClientAndServer mockServer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> MyService myService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> ObjectMapper serializer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectMapper();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @BeforeEach
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setupMockServer</span>() {
</span></span><span style="display:flex;"><span>        mockServer <span style="color:#ff79c6">=</span> ClientAndServer.<span style="color:#50fa7b">startClientAndServer</span>(2001);
</span></span><span style="display:flex;"><span>        myService <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> MyService(WebClient.<span style="color:#50fa7b">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">baseUrl</span>(<span style="color:#f1fa8c">&#34;http://localhost:&#34;</span> <span style="color:#ff79c6">+</span> mockServer.<span style="color:#50fa7b">getLocalPort</span>()).<span style="color:#50fa7b">build</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @AfterEach
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">tearDownServer</span>() {
</span></span><span style="display:flex;"><span>        mockServer.<span style="color:#50fa7b">stop</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...<span style="color:#50fa7b">the</span> tests...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So let&rsquo;s add a test case using this framework. The test should setup mock server such that it:</p>
<ul>
<li>
<p>Returns a 5xx internal server error the first two times that we call it, simulating [hopefully intermittent] failures</p>
</li>
<li>
<p>Recover and let a good request through on the third time we try it</p>
</li>
</ul>
<p>We can make this happen by implementing our own custom <a href="https://javadoc.io/static/org.mock-server/mockserver-core/5.6.1/org/mockserver/mock/action/ExpectationResponseCallback.html">ExpectationResponseCallback</a>. Because java does not let you modify variables which were declared outside of the closure inside the closure, I&rsquo;m also going to use an <strong>AtomicInteger</strong> because it has some convenience methods like <strong>incrementAndGet</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        AtomicInteger counter <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> AtomicInteger(0);
</span></span><span style="display:flex;"><span>        mockServer.<span style="color:#50fa7b">when</span>(
</span></span><span style="display:flex;"><span>                request()
</span></span><span style="display:flex;"><span>                    .<span style="color:#50fa7b">withMethod</span>(HttpMethod.<span style="color:#50fa7b">GET</span>.<span style="color:#50fa7b">name</span>())
</span></span><span style="display:flex;"><span>                    .<span style="color:#50fa7b">withPath</span>(<span style="color:#f1fa8c">&#34;/legacy/persons&#34;</span>)
</span></span><span style="display:flex;"><span>        ).<span style="color:#50fa7b">respond</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">new</span> ExpectationResponseCallback() {
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">public</span> HttpResponse <span style="color:#50fa7b">handle</span>(HttpRequest httpRequest) <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        <span style="color:#8be9fd">int</span> attempt <span style="color:#ff79c6">=</span> counter.<span style="color:#50fa7b">incrementAndGet</span>();
</span></span><span style="display:flex;"><span>                        <span style="color:#ff79c6">if</span> (attempt <span style="color:#ff79c6">&gt;=</span> 2) {
</span></span><span style="display:flex;"><span>                            <span style="color:#ff79c6">return</span> response().
</span></span><span style="display:flex;"><span>                                    withBody(responseBody)
</span></span><span style="display:flex;"><span>                                    .<span style="color:#50fa7b">withContentType</span>(MediaType.<span style="color:#50fa7b">APPLICATION_JSON</span>)
</span></span><span style="display:flex;"><span>                                    .<span style="color:#50fa7b">withStatusCode</span>(HttpStatus.<span style="color:#50fa7b">OK</span>.<span style="color:#50fa7b">value</span>());
</span></span><span style="display:flex;"><span>                        } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#ff79c6">return</span> response().<span style="color:#50fa7b">withStatusCode</span>(HttpStatus.<span style="color:#50fa7b">INTERNAL_SERVER_ERROR</span>.<span style="color:#50fa7b">value</span>());
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>        );
</span></span></code></pre></div><p>Every time <strong>GET &ldquo;/legacy/persons&rdquo;</strong> is called, mock server will invoke our <strong>ExpectationResponseCallback</strong>, which is this case is looking for our <strong>AtomicInteger</strong> to increment past 2. Until it does, we will return a 500 Internal Server Error, and once it does we will return our response body.</p>
<p>All of the relevant code for this test can now be laid out like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> String <span style="color:#50fa7b">getDownstreamResponseDTOAsString</span>() <span style="color:#8be9fd;font-style:italic">throws</span> JsonProcessingException {
</span></span><span style="display:flex;"><span>        DownstreamResponseDTO downstreamResponseDTO <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DownstreamResponseDTO();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        downstreamResponseDTO.<span style="color:#50fa7b">setLastName</span>(<span style="color:#f1fa8c">&#34;last&#34;</span>);
</span></span><span style="display:flex;"><span>        downstreamResponseDTO.<span style="color:#50fa7b">setFirstName</span>(<span style="color:#f1fa8c">&#34;first&#34;</span>);
</span></span><span style="display:flex;"><span>        downstreamResponseDTO.<span style="color:#50fa7b">setSsn</span>(<span style="color:#f1fa8c">&#34;123-12-1231&#34;</span>);
</span></span><span style="display:flex;"><span>        downstreamResponseDTO.<span style="color:#50fa7b">setDeepesetFear</span>(<span style="color:#f1fa8c">&#34;alligators&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> serializer.<span style="color:#50fa7b">writeValueAsString</span>(Arrays.<span style="color:#50fa7b">asList</span>(downstreamResponseDTO));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">retriesOnFailure</span>() <span style="color:#8be9fd;font-style:italic">throws</span> JsonProcessingException {
</span></span><span style="display:flex;"><span>        String responseBody <span style="color:#ff79c6">=</span> getDownstreamResponseDTOAsString();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        AtomicInteger counter <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> AtomicInteger(0);
</span></span><span style="display:flex;"><span>        mockServer.<span style="color:#50fa7b">when</span>(
</span></span><span style="display:flex;"><span>                request()
</span></span><span style="display:flex;"><span>                    .<span style="color:#50fa7b">withMethod</span>(HttpMethod.<span style="color:#50fa7b">GET</span>.<span style="color:#50fa7b">name</span>())
</span></span><span style="display:flex;"><span>                    .<span style="color:#50fa7b">withPath</span>(<span style="color:#f1fa8c">&#34;/legacy/persons&#34;</span>)
</span></span><span style="display:flex;"><span>        ).<span style="color:#50fa7b">respond</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">new</span> ExpectationResponseCallback() {
</span></span><span style="display:flex;"><span>                    @Override
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">public</span> HttpResponse <span style="color:#50fa7b">handle</span>(HttpRequest httpRequest) <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>                        <span style="color:#8be9fd">int</span> attempt <span style="color:#ff79c6">=</span> counter.<span style="color:#50fa7b">incrementAndGet</span>();
</span></span><span style="display:flex;"><span>                        <span style="color:#ff79c6">if</span> (attempt <span style="color:#ff79c6">&gt;=</span> 2) {
</span></span><span style="display:flex;"><span>                            <span style="color:#ff79c6">return</span> response().
</span></span><span style="display:flex;"><span>                                    withBody(responseBody)
</span></span><span style="display:flex;"><span>                                    .<span style="color:#50fa7b">withContentType</span>(MediaType.<span style="color:#50fa7b">APPLICATION_JSON</span>)
</span></span><span style="display:flex;"><span>                                    .<span style="color:#50fa7b">withStatusCode</span>(HttpStatus.<span style="color:#50fa7b">OK</span>.<span style="color:#50fa7b">value</span>());
</span></span><span style="display:flex;"><span>                        } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#ff79c6">return</span> response().<span style="color:#50fa7b">withStatusCode</span>(HttpStatus.<span style="color:#50fa7b">INTERNAL_SERVER_ERROR</span>.<span style="color:#50fa7b">value</span>());
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        List<span style="color:#ff79c6">&lt;</span>DownstreamResponseDTO<span style="color:#ff79c6">&gt;</span> responses <span style="color:#ff79c6">=</span> myService.<span style="color:#50fa7b">getAllPeople</span>().<span style="color:#50fa7b">collectList</span>().<span style="color:#50fa7b">block</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        assertEquals(1, responses.<span style="color:#50fa7b">size</span>());
</span></span><span style="display:flex;"><span>        assertEquals(<span style="color:#f1fa8c">&#34;first&#34;</span>, responses.<span style="color:#50fa7b">get</span>(0).<span style="color:#50fa7b">getFirstName</span>());
</span></span><span style="display:flex;"><span>        assertEquals(<span style="color:#f1fa8c">&#34;last&#34;</span>, responses.<span style="color:#50fa7b">get</span>(0).<span style="color:#50fa7b">getLastName</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        mockServer.<span style="color:#50fa7b">verify</span>(
</span></span><span style="display:flex;"><span>                request().<span style="color:#50fa7b">withMethod</span>(HttpMethod.<span style="color:#50fa7b">GET</span>.<span style="color:#50fa7b">name</span>())
</span></span><span style="display:flex;"><span>                        .<span style="color:#50fa7b">withPath</span>(<span style="color:#f1fa8c">&#34;/legacy/persons&#34;</span>)
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>If you run this with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mvn clean install
</span></span></code></pre></div><p>You will see the test fail, which makes sense because we have not yet created the code that actually retries.</p>
<h2 id="doing-retries-now">Doing Retries Now</h2>
<p>A naive implementation of retrying could use some of the <a href="https://projectreactor.io/docs/core/release/api/reactor/util/retry/Retry.html">built in Retry methods that ship with Reactor</a>. We can get a passing test by instructing the <strong>Flux</strong> to retry up to three times:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">webClient</span>.<span style="color:#50fa7b">get</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">uri</span>(<span style="color:#f1fa8c">&#34;/legacy/persons&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">retrieve</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">bodyToFlux</span>(DownstreamResponseDTO.<span style="color:#50fa7b">class</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">retryWhen</span>(Retry.<span style="color:#50fa7b">max</span>(3));
</span></span></code></pre></div><p>While this is, err, fine, we should also want a bit more control over the backoff strategy so that we are not overwhelming the downstream service. This can be done with something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">webClient</span>.<span style="color:#50fa7b">get</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">uri</span>(<span style="color:#f1fa8c">&#34;/legacy/persons&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">retrieve</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">bodyToFlux</span>(DownstreamResponseDTO.<span style="color:#50fa7b">class</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">retryWhen</span>(Retry.<span style="color:#50fa7b">backoff</span>(3, Duration.<span style="color:#50fa7b">ofMillis</span>(250)));
</span></span></code></pre></div><p>This backoff strategy will automatically include a jitter for us so that a thundering herd of retries is unlikely to happen.</p>
<p>By invoking <strong>backoff</strong> we can then enter into a fluent API [a <a href="https://projectreactor.io/docs/core/release/api/reactor/util/retry/RetryBackoffSpec.html">RetryBackoffSpec</a>], and can further customize it with something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">webClient</span>.<span style="color:#50fa7b">get</span>()
</span></span><span style="display:flex;"><span>.<span style="color:#50fa7b">uri</span>(<span style="color:#f1fa8c">&#34;/legacy/persons&#34;</span>)
</span></span><span style="display:flex;"><span>.<span style="color:#50fa7b">retrieve</span>()
</span></span><span style="display:flex;"><span>.<span style="color:#50fa7b">bodyToFlux</span>(DownstreamResponseDTO.<span style="color:#50fa7b">class</span>)
</span></span><span style="display:flex;"><span>.<span style="color:#50fa7b">retryWhen</span>(
</span></span><span style="display:flex;"><span>    Retry.<span style="color:#50fa7b">backoff</span>(3, Duration.<span style="color:#50fa7b">ofMillis</span>(250))
</span></span><span style="display:flex;"><span>        .<span style="color:#50fa7b">minBackoff</span>(Duration.<span style="color:#50fa7b">ofMillis</span>(100))
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>It&rsquo;s important to note that there is also <a href="https://projectreactor.io/docs/extra/snapshot/api/reactor/retry/Retry.html">a Retry in reactor-extra</a>, but this has now been deprecated in favor of the Retry functionality listed above, which ships with Reactor Core as of this article. You should use the library that ships with reactor core and save yourself a dependency.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/java/" alt="Java">
          Java
        </a>
      
        <a href="/tags/spring/" alt="Spring">
          Spring
        </a>
      
        <a href="/tags/reactive/" alt="Reactive">
          Reactive
        </a>
      
        <a href="/tags/testing/" alt="Testing">
          Testing
        </a>
      
        <a href="/tags/webflux/" alt="Webflux">
          Webflux
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
