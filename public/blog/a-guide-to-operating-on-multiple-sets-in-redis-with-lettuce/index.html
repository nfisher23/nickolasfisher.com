<!doctype html><html lang=en-US class="scroll-smooth dark"><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>A Guide to Operating on Multiple Sets in Redis with Lettuce</title>
<meta name=description content="In the last article, we showed how to do some of the most common single set operations against redis, this article will focus on operating on multiple sets using a lettuce client against redis. Specifically, we&rsquo;ll focus on subtracting, intersecting, and adding sets. The source code for what follows can be found on Github."><link rel=canonical href=https://www.nickolasfisher.com/blog/a-guide-to-operating-on-multiple-sets-in-redis-with-lettuce/><link rel=robots href=/robots.txt><link rel=icon type=image/x-icon href=/img/nficon.png><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><link rel=stylesheet href="https://www.nickolasfisher.com/css/app.min.dee9c4afb37cb95c5d39c976614ef6f95398bcba4b6e73066c44de2a3a6543ed.css"></head><body class="max-w-screen-md mx-auto px-2.5"><div class=header><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12"><div class="flex-none w-20 h-20 rounded-full overflow-hidden"><a href=https://www.nickolasfisher.com/><img srcset="/img/profile-picture_hu4241499301404582006.jpg 80w" src=/img/profile-picture.jpg width=386 height=345 alt="Nick Fisher's tech blog"></a></div><div class="flex flex-col gap-5"><a href=https://www.nickolasfisher.com/><h1 id=site-title>Nick Fisher's tech blog</h1></a><nav><ul><li><a href=/>home</a></li><li><a href=/blog>blog</a></li><li><a href=/about>about</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></header><button class=toggle-theme aria-label="Toggle Theme" title="Toggle Theme" onclick=toggleTheme()>
<span class="theme-icon light"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75.0 11-7.5.0 3.75 3.75.0 017.5.0z"/></svg> </span><span class="theme-icon dark"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718.0 0118 15.75c-5.385.0-9.75-4.365-9.75-9.75.0-1.33.266-2.597.748-3.752A9.753 9.753.0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753.0 009.002-5.998z"/></svg> </span></button>
<script>document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("theme");setTheme(!e||e==="light"?"light":e)});function setTheme(e){const t=document.querySelector("html");localStorage.setItem("theme",e),e==="light"?(t.classList.contains("dark")&&document.querySelector("html").classList.remove("dark"),document.querySelector(".theme-icon.light").style.display="none",document.querySelector(".theme-icon.dark").style.display="block"):(t.classList.contains("dark")||document.querySelector("html").classList.add("dark"),document.querySelector(".theme-icon.dark").style.display="none",document.querySelector(".theme-icon.light").style.display="block")}function toggleTheme(){const e=localStorage.getItem("theme");setTheme(e==="light"?"dark":"light")}</script></div><main id=content><article class="flex flex-col gap-10"><header class="flex flex-col gap-2"><h2 class=title-large>A Guide to Operating on Multiple Sets in Redis with Lettuce</h2><div class=meta><time datetime="2021-04-17 08:12:31 +0000 UTC" title='Sat, Apr 17, 2021, 8:12 AM UTC'>17/04/2021 - Estimated reading time: 2 minutes</time></div></header><section><p>In the last article, we showed how to do some of the most common single set operations against redis, this article will focus on operating on multiple sets using a lettuce client against redis. Specifically, we&rsquo;ll focus on subtracting, intersecting, and adding sets. The source code for what follows <a href=https://github.com/nfisher23/reactive-programming-webflux>can be found on Github</a>.</p><h3 id=subtracting-sets>Subtracting Sets</h3><p>Subtracting sets work similarly to subtracting numbers.</p><p>You take the first set, and when there are elements in the second set that match the element in the first set, you take those out of the set that you return. Both the set you&rsquo;re subtracting from and the set you&rsquo;re using to subtract will remain unchanged.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    @Test
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>subtractingMultipleSets</span>() {
</span></span><span style=display:flex><span>        String firstSetKey <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;first-set-key&#34;</span>;
</span></span><span style=display:flex><span>        String secondSetKey <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;second-set-key&#34;</span>;
</span></span><span style=display:flex><span>        Mono<span style=color:#ff79c6>&lt;</span>Long<span style=color:#ff79c6>&gt;</span> setupFirstSetMono <span style=color:#ff79c6>=</span> redisReactiveCommands.<span style=color:#50fa7b>sadd</span>(firstSetKey, <span style=color:#f1fa8c>&#34;value-1&#34;</span>, <span style=color:#f1fa8c>&#34;value-2&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        StepVerifier.<span style=color:#50fa7b>create</span>(setupFirstSetMono).<span style=color:#50fa7b>expectNext</span>(2L).<span style=color:#50fa7b>verifyComplete</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Mono<span style=color:#ff79c6>&lt;</span>Long<span style=color:#ff79c6>&gt;</span> setupSecondSetMono <span style=color:#ff79c6>=</span> redisReactiveCommands.<span style=color:#50fa7b>sadd</span>(secondSetKey, <span style=color:#f1fa8c>&#34;value-1&#34;</span>, <span style=color:#f1fa8c>&#34;value-3&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        StepVerifier.<span style=color:#50fa7b>create</span>(setupSecondSetMono).<span style=color:#50fa7b>expectNext</span>(2L).<span style=color:#50fa7b>verifyComplete</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Mono<span style=color:#ff79c6>&lt;</span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;&gt;</span> subtractSecondFromFirstCollection <span style=color:#ff79c6>=</span> redisReactiveCommands.<span style=color:#50fa7b>sdiff</span>(firstSetKey, secondSetKey).<span style=color:#50fa7b>collectList</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        StepVerifier.<span style=color:#50fa7b>create</span>(subtractSecondFromFirstCollection)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>expectNextMatches</span>(collection <span style=color:#ff79c6>-&gt;</span>
</span></span><span style=display:flex><span>                        collection.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>==</span> 1
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>&amp;</span>amp;<span style=color:#ff79c6>&amp;</span>amp; collection.<span style=color:#50fa7b>contains</span>(<span style=color:#f1fa8c>&#34;value-2&#34;</span>))
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>verifyComplete</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Mono<span style=color:#ff79c6>&lt;</span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;&gt;</span> subtractFirstFromSecondCollection <span style=color:#ff79c6>=</span> redisReactiveCommands.<span style=color:#50fa7b>sdiff</span>(secondSetKey, firstSetKey).<span style=color:#50fa7b>collectList</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        StepVerifier.<span style=color:#50fa7b>create</span>(subtractFirstFromSecondCollection)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>expectNextMatches</span>(collection <span style=color:#ff79c6>-&gt;</span>
</span></span><span style=display:flex><span>                        collection.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>==</span> 1
</span></span><span style=display:flex><span>                                <span style=color:#ff79c6>&amp;</span>amp;<span style=color:#ff79c6>&amp;</span>amp; collection.<span style=color:#50fa7b>contains</span>(<span style=color:#f1fa8c>&#34;value-3&#34;</span>))
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>verifyComplete</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Mono<span style=color:#ff79c6>&lt;</span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;&gt;</span> originalSetUnchangedMono <span style=color:#ff79c6>=</span> redisReactiveCommands.<span style=color:#50fa7b>smembers</span>(firstSetKey).<span style=color:#50fa7b>collectList</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        StepVerifier.<span style=color:#50fa7b>create</span>(originalSetUnchangedMono)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>expectNextMatches</span>(firstSetMembers <span style=color:#ff79c6>-&gt;</span>
</span></span><span style=display:flex><span>                        firstSetMembers.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>==</span> 2
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>&amp;</span>amp;<span style=color:#ff79c6>&amp;</span>amp; firstSetMembers.<span style=color:#50fa7b>contains</span>(<span style=color:#f1fa8c>&#34;value-1&#34;</span>)
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>&amp;</span>amp;<span style=color:#ff79c6>&amp;</span>amp; firstSetMembers.<span style=color:#50fa7b>contains</span>(<span style=color:#f1fa8c>&#34;value-2&#34;</span>)
</span></span><span style=display:flex><span>                ).<span style=color:#50fa7b>verifyComplete</span>();
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Here, we create two sets, subtract them in both directions, then verify the original set was unchanged. This test passes.</p><h3 id=intersecting-sets>Intersecting Sets</h3><p>Intersecting sets in redis means that only elements that are in both sets make it into the resulting set. You use <strong>sinter</strong> to intersect two different sets:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    @Test
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>intersectingMultipleSets</span>() {
</span></span><span style=display:flex><span>        String firstSetKey <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;first-set-key&#34;</span>;
</span></span><span style=display:flex><span>        String secondSetKey <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;second-set-key&#34;</span>;
</span></span><span style=display:flex><span>        Mono<span style=color:#ff79c6>&lt;</span>Long<span style=color:#ff79c6>&gt;</span> setupFirstSetMono <span style=color:#ff79c6>=</span> redisReactiveCommands
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>sadd</span>(firstSetKey, <span style=color:#f1fa8c>&#34;value-1&#34;</span>, <span style=color:#f1fa8c>&#34;value-2&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        StepVerifier.<span style=color:#50fa7b>create</span>(setupFirstSetMono).<span style=color:#50fa7b>expectNext</span>(2L).<span style=color:#50fa7b>verifyComplete</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Mono<span style=color:#ff79c6>&lt;</span>Long<span style=color:#ff79c6>&gt;</span> setupSecondSetMono <span style=color:#ff79c6>=</span> redisReactiveCommands
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>sadd</span>(secondSetKey, <span style=color:#f1fa8c>&#34;value-1&#34;</span>, <span style=color:#f1fa8c>&#34;value-3&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        StepVerifier.<span style=color:#50fa7b>create</span>(setupSecondSetMono).<span style=color:#50fa7b>expectNext</span>(2L).<span style=color:#50fa7b>verifyComplete</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Mono<span style=color:#ff79c6>&lt;</span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;&gt;</span> intersectedSets <span style=color:#ff79c6>=</span> redisReactiveCommands
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>sinter</span>(firstSetKey, secondSetKey).<span style=color:#50fa7b>collectList</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        StepVerifier.<span style=color:#50fa7b>create</span>(intersectedSets)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>expectNextMatches</span>(collection <span style=color:#ff79c6>-&gt;</span>
</span></span><span style=display:flex><span>                    collection.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>==</span> 1
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>&amp;</span>amp;<span style=color:#ff79c6>&amp;</span>amp; collection.<span style=color:#50fa7b>contains</span>(<span style=color:#f1fa8c>&#34;value-1&#34;</span>)
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>&amp;</span>amp;<span style=color:#ff79c6>&amp;</span>amp; <span style=color:#ff79c6>!</span>collection.<span style=color:#50fa7b>contains</span>(<span style=color:#f1fa8c>&#34;value-2&#34;</span>)
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>verifyComplete</span>();
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>&ldquo;first-set-key&rdquo; and &ldquo;second-set-key&rdquo; only share &ldquo;value-1&rdquo; as a common element, so the intersected set contains only one element [&ldquo;value-1&rdquo;].</p><h3 id=adding-sets>Adding Sets</h3><p>Adding sets [also called a <strong>union</strong>] is basically the same as if you were to get all the members of both sets, then run <strong>sadd</strong> over and over again. Common elements only show up once because that&rsquo;s how sets work:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    @Test
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>addingMultipleSetsTogether</span>() {
</span></span><span style=display:flex><span>        String firstSetKey <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;first-set-key&#34;</span>;
</span></span><span style=display:flex><span>        String secondSetKey <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;second-set-key&#34;</span>;
</span></span><span style=display:flex><span>        Mono<span style=color:#ff79c6>&lt;</span>Long<span style=color:#ff79c6>&gt;</span> setupFirstSetMono <span style=color:#ff79c6>=</span> redisReactiveCommands
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>sadd</span>(firstSetKey, <span style=color:#f1fa8c>&#34;value-1&#34;</span>, <span style=color:#f1fa8c>&#34;value-2&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        StepVerifier.<span style=color:#50fa7b>create</span>(setupFirstSetMono).<span style=color:#50fa7b>expectNext</span>(2L).<span style=color:#50fa7b>verifyComplete</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Mono<span style=color:#ff79c6>&lt;</span>Long<span style=color:#ff79c6>&gt;</span> setupSecondSetMono <span style=color:#ff79c6>=</span> redisReactiveCommands
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>sadd</span>(secondSetKey, <span style=color:#f1fa8c>&#34;value-1&#34;</span>, <span style=color:#f1fa8c>&#34;value-3&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        StepVerifier.<span style=color:#50fa7b>create</span>(setupSecondSetMono).<span style=color:#50fa7b>expectNext</span>(2L).<span style=color:#50fa7b>verifyComplete</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Mono<span style=color:#ff79c6>&lt;</span>List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;&gt;</span> unionedSets <span style=color:#ff79c6>=</span> redisReactiveCommands
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>sunion</span>(firstSetKey, secondSetKey).<span style=color:#50fa7b>collectList</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        StepVerifier.<span style=color:#50fa7b>create</span>(unionedSets)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>expectNextMatches</span>(collection <span style=color:#ff79c6>-&gt;</span>
</span></span><span style=display:flex><span>                    collection.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>==</span> 3
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>&amp;</span>amp;<span style=color:#ff79c6>&amp;</span>amp; collection.<span style=color:#50fa7b>contains</span>(<span style=color:#f1fa8c>&#34;value-1&#34;</span>)
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>&amp;</span>amp;<span style=color:#ff79c6>&amp;</span>amp; collection.<span style=color:#50fa7b>contains</span>(<span style=color:#f1fa8c>&#34;value-2&#34;</span>)
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>&amp;</span>amp;<span style=color:#ff79c6>&amp;</span>amp; collection.<span style=color:#50fa7b>contains</span>(<span style=color:#f1fa8c>&#34;value-3&#34;</span>)
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>verifyComplete</span>();
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>The identical sets we&rsquo;ve been creating for every test so far are here added together, which leads to a three element set of &ldquo;value-1&rdquo;, &ldquo;value-2&rdquo;, and &ldquo;value-3&rdquo;.</p><p>And with that, you should be good to go.</p></section><footer><div class="pb-14 taxonomy-list tags-list"><a href=/tags/java/ alt=Java>Java
</a><a href=/tags/spring/ alt=Spring>Spring
</a><a href=/tags/reactive/ alt=Reactive>Reactive
</a><a href=/tags/webflux/ alt=Webflux>Webflux
</a><a href=/tags/lettuce/ alt=Lettuce>Lettuce
</a><a href=/tags/redis/ alt=Redis>Redis</a></div></footer></article></main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2"><div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">© 2018-2025 —
<a href=https://www.nickolasfisher.com/>Nick Fisher's tech blog</a></div><div class="order-1 sm:order-2"><ul class="flex sm:justify-end gap-5"><li><a href=https://www.linkedin.com/in/nick-fisher-software/ target=_blank rel="noopener noreferrer">LinkedIn</a></li><li><a href=https://github.com/nfisher23 target=_blank rel="noopener noreferrer">GitHub</a></li></ul></div></footer></body></html>