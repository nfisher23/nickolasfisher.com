<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>A Simple Zero Downtime Continuous Integration Pipeline for Spring MVC</title>
<meta
  name="description"
  content="The sample code associated with what follows can be found on GitHub.
One of the biggest paradigm shifts in software engineering, since the invention of the computer and software that would run on it, was the idea of a MVR (minimum viable release) or MVP (minimum viable product). With the lack of internet access becoming the exception in developed countries, it becomes more and more powerful to put your product out there on display, and to design a way to continuously make improvements to it. In the most aggressive of circumstances, you want to be able to push something up to a source control server, then let an automated process perform the various steps required to actually deploy it in the real world. In the best case, you can achieve all of this with zero downtime&ndash;basically, the users of your service are never inconvenienced by your decision to make a change. Setting up one very simple example of that is the subject of this post."
/>
<link rel="canonical" href="http://localhost:1313/blog/a-simple-zero-downtime-continuous-integration-pipeline-for-spring-mvc/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/img/nficon.png" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">A Simple Zero Downtime Continuous Integration Pipeline for Spring MVC</h2>

    <div class="meta">
      
      <time datetime="2018-11-25 15:53:22 &#43;0000 UTC" title='Sun, Nov 25, 2018, 3:53 PM UTC'>
        25/11/2018 - Estimated reading time: 6 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>The sample code associated with what follows can be found <a href="https://github.com/nfisher23/simple-cicd-pipeline-with-spring">on GitHub</a>.</p>
<p>One of the biggest paradigm shifts in software engineering, since the invention of the computer and software that would run on it, was the idea of a MVR (minimum viable release) or MVP (minimum viable product). With the lack of internet access becoming the exception in developed countries, it becomes more and more powerful to put your product out there on display, and to design a way to continuously make improvements to it. In the most aggressive of circumstances, you want to be able to push something up to a source control server, then let an automated process perform the various steps required to actually deploy it in the real world. In the best case, you can achieve all of this with zero downtime&ndash;basically, the users of your service are never inconvenienced by your decision to make a change. Setting up one very simple example of that is the subject of this post.</p>
<p>I'll start with a skeleton Spring MVC project. You can use the <a href="https://start.spring.io/">Spring Initializer</a> with the Web option to get started quickly and easily. All I'll do, to keep the focus on DevOps, is add a simple entry controller that will accept requests to the root directory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Controller
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">HelloWorldController</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @GetMapping(value <span style="color:#ff79c6">=</span> {<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">/&amp;</span>#34;, <span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">&amp;</span>#34;})
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> ResponseEntity<span style="color:#ff79c6">&amp;</span>lt;String<span style="color:#ff79c6">&amp;</span>gt; notAnotherHelloWorld() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> ResponseEntity<span style="color:#ff79c6">&amp;</span>lt;<span style="color:#ff79c6">&amp;</span>gt;(<span style="color:#ff79c6">&amp;</span>#34;okay, I guess we<span style="color:#ff79c6">&amp;</span>#39;ll call <span style="color:#ff79c6">this</span> a hello world<span style="color:#ff79c6">&amp;</span>#34;, HttpStatus.<span style="color:#50fa7b">OK</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As you can see, I'm reluctantly calling this a &quot;hello world.&quot; Yuck.</p>
<p>And that's it for the Spring MVC project. What we need on the server is:</p>
<ol>
<li>
<p>Dependencies (e.g. java)</p>
</li>
<li>
<p>A source control server (to checkout the code and perform the steps on commit)</p>
</li>
<li>
<p>A way to build the solution in a way that is separate from running our solution</p>
</li>
<li>
<p>A way for the web application to run continuously, and to restart automatically if it crashes</p>
</li>
<li>
<p>A reverse proxy server to balance requests between two active
applications. When one is stopped for upgrades, the second can continue
to run, and vice versa.</p>
</li>
</ol>
<p>I will start with #4: we can <a href="https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units">create a systemctl service</a> (call this <strong>site-node1.service</strong>):</p>
<pre tabindex="0"><code>[Unit]
Description=Site Node 1

[Service]
ExecStart=/usr/bin/java -jar -Xmx64m /opt/site-node1/target/simplecicd-0.0.1-SNAPSHOT.jar
Restart=always
RestartSec=10
SyslogIdentifier=site-node1
Environment=SERVER_PORT=9000

[Install]
WantedBy=multi-user.target
</code></pre><p>This runs with the environment variable SERVER_PORT equal to 9000, which tells Spring to run our application on <a href="localhost:9000">localhost:9000</a> (which will be the local host on the server). We can create another service file for another port (9001, here) like so (call this <strong>site-node2.service</strong>):</p>
<pre tabindex="0"><code>[Unit]
Description=Site Node 2

[Service]
ExecStart=/usr/bin/java -jar -Xmx64m /opt/site-node2/target/simplecicd-0.0.1-SNAPSHOT.jar
Restart=always
RestartSec=10
SyslogIdentifier=site-node2
Environment=SERVER_PORT=9001

[Install]
WantedBy=multi-user.target
</code></pre><p>By choosing to use the local host to bind these systemctl service files to, we are capable of using a <a href="https://www.nginx.com/resources/glossary/reverse-proxy-server/">reverse proxy</a>. Typically, a lightweight server application gets the job done from here. I will choose <a href="https://www.nginx.com/">Nginx</a>, and create a dead simple configuration file like so:</p>
<pre tabindex="0"><code>upstream nodes {
        server localhost:9000;
        server localhost:9001;
}

server {
        # balance between nodes
        location / {
                proxy_pass http://nodes;
        }
}
</code></pre><p>Here, we use the load balancing feature to go between the two nodes defined in our service files above. Nginx will automatically detect if a port is not in use, and will not forward to that port if there is nothing to forward it to. For example, if both nodes are running and we decide to kill the one running on <a href="localhost:9000,">localhost:9000,</a> Nginx will route all requests to <a href="localhost:9001.">localhost:9001.</a></p>
<p>I will use Git for source control, and will use <a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">git's hooks feature</a>, particularly the post-receive file, to run a bash script on check in. The bash script will build the solution (including running any tests) and, if successful, will copy the directory with the built solution into our predetermined folder, then restart each service. Before starting the second service it will validate that the first one came up successfully, thus never shutting down both services at the same time:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># checkout changes to release branch</span>
</span></span><span style="display:flex;"><span>git --work-tree<span style="color:#ff79c6">=</span>/opt/build --git-dir<span style="color:#ff79c6">=</span>/srv/git/site.git checkout -f release
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># build the solution with maven and ensure it passes all the tests. If it fails, abort</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">cd</span> /opt/build
</span></span><span style="display:flex;"><span>mvn clean install
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> <span style="color:#ff79c6">[[</span> &amp;<span style="color:#6272a4">#34;$?&amp;#34; -ne 0 ]]; then</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">echo</span> &amp;<span style="color:#6272a4">#34;build failed, stopping deployment&amp;#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">exit</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rm -r /opt/site-node1/*
</span></span><span style="display:flex;"><span>cp -r /opt/build/target /opt/site-node1/
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> &amp;<span style="color:#6272a4">#34;restarting the first service&amp;#34;</span>
</span></span><span style="display:flex;"><span>systemctl start site-node1.service
</span></span><span style="display:flex;"><span>systemctl <span style="color:#8be9fd;font-style:italic">enable</span> site-node1.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">START_TIME</span><span style="color:#ff79c6">=</span>&amp;<span style="color:#6272a4">#34;$(date &amp;#43;%s)&amp;#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">while</span> <span style="color:#ff79c6">[[</span> <span style="color:#f1fa8c">`</span>curl -s -o /dev/null -w &amp;<span style="color:#6272a4">#34;%{http_code}&amp;#34; localhost:9000` -ne 200 ]]; do</span>
</span></span><span style="display:flex;"><span>  sleep 2s
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">[[</span> <span style="color:#f1fa8c">`</span>expr <span style="color:#ff79c6">$(</span>date &amp;<span style="color:#6272a4">#43;%s) - $START_TIME` -ge 60 ]]; then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">echo</span> &amp;<span style="color:#6272a4">#34;timed out--something is wrong. Aborting...&amp;#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">exit</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> &amp;<span style="color:#6272a4">#34;first service up, restarting second service&amp;#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># stop the second service</span>
</span></span><span style="display:flex;"><span>systemctl stop site-node2.service
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># copy the target directory from the build into the second node directory</span>
</span></span><span style="display:flex;"><span>rm -r /opt/site-node2/*
</span></span><span style="display:flex;"><span>cp -r /opt/build/target /opt/site-node2/
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># restart the second service</span>
</span></span><span style="display:flex;"><span>systemctl start site-node2.service
</span></span><span style="display:flex;"><span>systemctl <span style="color:#8be9fd;font-style:italic">enable</span> site-node2.service
</span></span></code></pre></div><p>To stitch all of this together, I will use an ansible playbook to provision our server, and I will use Vagrant as a proof of concept. Here's the playbook, which sets up the environment we need to make all of this work:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff79c6">hosts</span>: all
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">become</span>: <span style="color:#ff79c6">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">gather_facts</span>: <span style="color:#ff79c6">no</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">pre_tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: <span style="color:#ff79c6">&amp;#39;install</span> python2 on ubuntu 18&amp;#39;
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">raw</span>: test -e /usr/bin/python || (apt-get -y update &amp;amp;&amp;amp; apt-get install -y python-minimal)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: Gathering facts
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">setup</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: Get Java tarball
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">get_url</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">url</span>: https://download.java.net/java/GA/jdk10/10.0.1/fb4372174a714e6b8c52526dc134031e/10/openjdk-10.0.1_linux-x64_bin.tar.gz
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">dest</span>: /etc/open-jdk10.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: make java 10 directory
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">file</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">path</span>: /usr/lib/java10
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">state</span>: directory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: unpack tarball
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">unarchive</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">dest</span>: /usr/lib/java10/
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">src</span>: /etc/open-jdk10.tar.gz
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">remote_src</span>: <span style="color:#ff79c6">yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: update alternatives for java
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">alternatives</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">name</span>: java
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">path</span>: /usr/lib/java10/jdk-10.0.1/bin/java
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">link</span>: /usr/bin/java
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">priority</span>: <span style="color:#bd93f9">2000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: set java environment variable
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">blockinfile</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">insertafter</span>: EOF
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">path</span>: /etc/environment
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">block</span>: export JAVA_HOME=/usr/lib/java10/jdk-10.0.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: re-source env variables
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">shell</span>: . /etc/environment
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: install packages
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">apt</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">name</span>: <span style="color:#ff79c6">&amp;#39;{{</span> item }}&amp;#39;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">state</span>: present
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">update_cache</span>: <span style="color:#ff79c6">yes</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">with_items</span>:
</span></span><span style="display:flex;"><span>        - nginx
</span></span><span style="display:flex;"><span>        - maven
</span></span><span style="display:flex;"><span>        - git
</span></span><span style="display:flex;"><span>        - python-psycopg2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: allow ssh
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">ufw</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">rule</span>: allow
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">name</span>: OpenSSH
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: allow http/https
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">ufw</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">rule</span>: allow
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">port</span>: <span style="color:#ff79c6">&amp;#39;{{</span> item }}&amp;#39;
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">with_items</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#bd93f9">443</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#bd93f9">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: setup rate limit over ssh
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">ufw</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">rule</span>: limit
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">port</span>: ssh
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">proto</span>: tcp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">ufw</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">state</span>: enabled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: create git directory and node directories
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">file</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">path</span>: <span style="color:#ff79c6">&amp;#39;{{</span> item }}&amp;#39;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">state</span>: directory
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">mode</span>: <span style="color:#bd93f9">0777</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">with_items</span>:
</span></span><span style="display:flex;"><span>        - /srv/git/site.git
</span></span><span style="display:flex;"><span>        - /opt/site-node1
</span></span><span style="display:flex;"><span>        - /opt/site-node2
</span></span><span style="display:flex;"><span>        - /opt/build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: create git repo to push to
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">command</span>: git init --bare /srv/git/site.git
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">args</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">creates</span>: /srv/git/site.git/HEAD
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: copy node service files
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">copy</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">src</span>: <span style="color:#ff79c6">&amp;#39;{{</span> item }}&amp;#39;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">dest</span>: /etc/systemd/system
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">mode</span>: <span style="color:#bd93f9">0755</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">with_items</span>:
</span></span><span style="display:flex;"><span>        - ./site-node1.service
</span></span><span style="display:flex;"><span>        - ./site-node2.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: copy nginx config file
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">copy</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">src</span>: ./nginx_site_conf
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">dest</span>: /etc/nginx/sites-available
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: make link to sites-enabled
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">file</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">src</span>: /etc/nginx/sites-available/nginx_site_conf
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">dest</span>: /etc/nginx/sites-enabled/nginx_site_conf
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">state</span>: link
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: remove default configuration
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">file</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">path</span>: /etc/nginx/sites-enabled/default
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">state</span>: absent
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">register</span>: nginxconf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: reload nginx
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">command</span>: nginx -s reload
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">when</span>: nginxconf.changed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: ensure nginx runs on boot
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">service</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">name</span>: nginx
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">enabled</span>: <span style="color:#ff79c6">yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: create post-receive file to deploy solution on check in
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">copy</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">src</span>: ./post-receive.sh
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">dest</span>: /srv/git/site.git/hooks/post-receive
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">mode</span>: <span style="color:#bd93f9">0777</span>
</span></span></code></pre></div><p>If you go <a href="https://github.com/nfisher23/simple-cicd-pipeline-with-spring">get the source code and install the prerequisites</a>, you can validate that this works by running:</p>
<pre tabindex="0"><code>$ vagrant up
</code></pre><p>Then, once the VM is provisioned:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ git remote add local_vagrant root@192.168.56.121:/srv/git/site.git
</span></span></code></pre></div><p>Finally:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ git push local_vagrant release
</span></span></code></pre></div><p>And watch the magic happen.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/java/" alt="Java">
          Java
        </a>
      
        <a href="/tags/ngnix/" alt="Ngnix">
          Ngnix
        </a>
      
        <a href="/tags/distributed-systems/" alt="Distributed Systems">
          Distributed Systems
        </a>
      
        <a href="/tags/vagrant/" alt="Vagrant">
          Vagrant
        </a>
      
        <a href="/tags/bash/" alt="Bash">
          Bash
        </a>
      
        <a href="/tags/ansible/" alt="Ansible">
          Ansible
        </a>
      
        <a href="/tags/devops/" alt="DevOps">
          DevOps
        </a>
      
        <a href="/tags/maven/" alt="Maven">
          Maven
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
