<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>An Example Upgrade and Rollback of a Deployment image in Kubernetes</title>
<meta
  name="description"
  content="In this article, I&#39;m going to show you how to bootstrap a local kubernetes cluster with a custom image, debug it, deploy a new image, then rollback to the old image."
/>
<link rel="canonical" href="http://localhost:1313/blog/an-example-upgrade-and-rollback-of-a-deployment-image-in-kubernetes/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        Home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        Blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        About me
      </a>
    </li>
    
    <li>
      <a href="/categories" class="">
        Categories
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">An Example Upgrade and Rollback of a Deployment image in Kubernetes</h2>

    <div class="meta">
      
      <time datetime="2020-06-01 00:00:00 &#43;0000 UTC" title='Mon, Jun 1, 2020, 12:00 AM UTC'>
        01/06/2020 - Estimated reading time: 4 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>In this article, I'm going to show you how to bootstrap a local kubernetes cluster with a custom image, debug it, deploy a new image, then rollback to the old image.</p>
<p>If you don't have a good way to get a local kubernetes cluster, you should check out: <a href="https://nickolasfisher.com/blog/How-to-Setup-and-Use-Kubernetes-in-Docker-kind">how to setup and use kind locally</a>. Big fan.</p>
<h2 id="create-cluster-make-base-resources">Create Cluster, Make Base Resources</h2>
<p>Start by creating a local kubernetes cluster using <a href="https://kind.sigs.k8s.io/">kind</a>:</p>
<pre tabindex="0"><code>kind create cluster
</code></pre><p>This will automatically configure your <strong>kubectl</strong> cli to communicate to your local cluster (called &quot;kind&quot; by default).</p>
<p>I have created <a href="https://hub.docker.com/repository/docker/nfisher23/simplesb">a sample repository in Docker Hub</a> with a few different versions that we'll use for this demo. Specifically, there are two versions (both tags):</p>
<ul>
<li><strong>v2</strong>: has just an <strong>/actuator/health</strong> endpoint</li>
<li><strong>v3</strong>: added a GET <strong>/hello</strong> endpoint</li>
</ul>
<p>Once we have our cluster, we can first create a namespace with this yaml:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Namespace
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: nick-sample-sb
</span></span></code></pre></div><p>You can apply this with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f namespace.yaml
</span></span></code></pre></div><p>We can then add a deployment, which will live in that created namespace, and will start with version 2:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: apps/v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Deployment
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: nick-sample-sb
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: nick-sample-sb
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">replicas</span>: <span style="color:#bd93f9">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">app</span>: nick-sample-sb
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">app</span>: nick-sample-sb
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ff79c6">name</span>: nick-sample-sb
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">image</span>: nfisher23/simplesb:v2
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">imagePullPolicy</span>: Always
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ff79c6">containerPort</span>: <span style="color:#bd93f9">8080</span>
</span></span></code></pre></div><p>Pretty much the same command to get this up there:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f deployment.yaml
</span></span></code></pre></div><p>Finally, we'll expose a way for other pods in the cluster to communicate with the pods managed by the deployment (actually, the deployment manages ReplicaSets, which in turn ensure we have enough pods) with one more yaml for cluster ip:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">apiVersion</span>: v1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">kind</span>: Service
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">namespace</span>: nick-sample-sb
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">name</span>: nick-sample-sb-clusterip
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: nick-sample-sb
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">targetPort</span>: <span style="color:#bd93f9">8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">protocol</span>: TCP
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">app</span>: nick-sample-sb
</span></span></code></pre></div><p>And apply that change:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f service.yaml
</span></span></code></pre></div><p>Note that, while I have shown these examples as being in three different yaml files, they could technically all be in one. It's usually easier to keep them more isolated, but if you're just proving things out/sandboxing, you can do so by separating them with <strong>&ndash;</strong>.</p>
<h2 id="debugging">Debugging</h2>
<p>Okay, we have our namespace:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl get namespaces | grep nick-sample-sb
</span></span><span style="display:flex;"><span>nick-sample-sb       Active   29m
</span></span></code></pre></div><p>We also have a deployment with two pods, hopefully ready by now:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl get deployment --namespace nick-sample-sb nick-sample-sb
</span></span><span style="display:flex;"><span>NAME             READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>nick-sample-sb   2/2     <span style="color:#bd93f9">2</span>            <span style="color:#bd93f9">2</span>           30m
</span></span></code></pre></div><p>We can see some more details about those pods specifically with something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl get pods --namespace nick-sample-sb -o wide
</span></span><span style="display:flex;"><span>NAME                              READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>nick-sample-sb-7f65cbf9fc-bc4pw   1/1     Running   <span style="color:#bd93f9">0</span>          16m   10.244.1.5   kind-worker
</span></span><span style="display:flex;"><span>nick-sample-sb-7f65cbf9fc-kd95d   1/1     Running   <span style="color:#bd93f9">0</span>          17m   10.244.1.5   kind-worker
</span></span></code></pre></div><p>Because CoreDNS is included with this version of kubernetes and it is a cluster aware DNS service, our cluster ip will automatically allow us to communicate via a DNS entry <strong>nick-sample-sb-clusterip</strong> if we are in the same namespace. Let's prove that&ndash;we can exec onto one of the pods and send a curl to the health endpoint:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">POD</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>kubectl get pods -n nick-sample-sb | grep nick-sample | awk &amp;<span style="color:#6272a4">#39;{print $1}&amp;#39; | head -1)</span>
</span></span><span style="display:flex;"><span>$ kubectl <span style="color:#8be9fd;font-style:italic">exec</span> --namespace nick-sample-sb <span style="color:#8be9fd;font-style:italic">$POD</span> -- curl nick-sample-sb-clusterip/actuator/health
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>&amp;<span style="color:#6272a4">#34;status&amp;#34;:&amp;#34;UP&amp;#34;,&amp;#34;components&amp;#34;:{&amp;#34;diskSpace&amp;#34;:{&amp;#34;status&amp;#34;:&amp;#34;UP&amp;#34;,&amp;#34;details&amp;#34;:{&amp;#34;total&amp;#34;:117610516480,&amp;#34;free&amp;#34;:57556758528,&amp;#34;threshold&amp;#34;:10485760}},&amp;#34;ping&amp;#34;:{&amp;#34;status&amp;#34;:&amp;#34;UP&amp;#34;}}}</span>
</span></span></code></pre></div><p>We can also notice that our <strong>/hello</strong> endpoint is not available:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl <span style="color:#8be9fd;font-style:italic">exec</span> --namespace nick-sample-sb <span style="color:#8be9fd;font-style:italic">$POD</span> -- curl nick-sample-sb-clusterip/hello
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>&amp;<span style="color:#6272a4">#34;timestamp&amp;#34;:&amp;#34;2020-06-27T23:38:46.663&amp;#43;0000&amp;#34;,&amp;#34;status&amp;#34;:404,&amp;#34;error&amp;#34;:&amp;#34;Not Found&amp;#34;,&amp;#34;message&amp;#34;:&amp;#34;No message available&amp;#34;,&amp;#34;path&amp;#34;:&amp;#34;/hello&amp;#34;}</span>
</span></span></code></pre></div><p>Now, we are ready to ship our code, version 3&ndash;we can do so from the cli with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl <span style="color:#8be9fd;font-style:italic">set</span> image -n nick-sample-sb deployments/nick-sample-sb nick-sample-sb<span style="color:#ff79c6">=</span>nfisher23/simplesb:v3 --record
</span></span><span style="display:flex;"><span>deployment.apps/nick-sample-sb image updated
</span></span></code></pre></div><p>This command will update to the latest version and after all the pods come up, we can see that our <strong>/hello</strong> endpoint exists:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">POD</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>kubectl get pods -n nick-sample-sb | grep nick-sample | awk &amp;<span style="color:#6272a4">#39;{print $1}&amp;#39; | head -1)</span>
</span></span><span style="display:flex;"><span>$ kubectl <span style="color:#8be9fd;font-style:italic">exec</span> --namespace nick-sample-sb <span style="color:#8be9fd;font-style:italic">$POD</span> -- curl nick-sample-sb-clusterip/hello
</span></span><span style="display:flex;"><span>hello
</span></span></code></pre></div><p>I hope this provided you with enough information to get you started bridging the gap between applications and infra when it comes to kubernetes.</p>
</section>

  
    
  

    
  


  <footer>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
