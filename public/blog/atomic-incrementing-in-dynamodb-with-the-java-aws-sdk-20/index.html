<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Atomic Incrementing in DynamoDB with the Java AWS SDK 2.0</title>
<meta
  name="description"
  content="The source code for this post can be found on Github.
When you update an item in DynamoDB, you can optionally update the item in place. That is, instead of read-increment-write, you can just issue a command that says increment this value in place. This behavior is detailed in the AWS documentation, and I will provide an example for how to do so with the Java AWS SDK 2.0, which has full reactive support."
/>
<link rel="canonical" href="http://localhost:1313/blog/atomic-incrementing-in-dynamodb-with-the-java-aws-sdk-20/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        Home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        Blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        About me
      </a>
    </li>
    
    <li>
      <a href="/categories" class="">
        Categories
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">Atomic Incrementing in DynamoDB with the Java AWS SDK 2.0</h2>

    <div class="meta">
      
      <time datetime="2021-03-28 02:00:30 &#43;0000 UTC" title='Sun, Mar 28, 2021, 2:00 AM UTC'>
        28/03/2021 - Estimated reading time: 2 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>The source code for this post <a href="https://github.com/nfisher23/webflux-and-dynamo">can be found on Github</a>.</p>
<p>When you update an item in DynamoDB, you can optionally update the item in place. That is, instead of <strong>read-increment-write</strong>, you can just issue a command that says <strong>increment this value in place</strong>. This behavior is detailed in the <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/WorkingWithItems.html#WorkingWithItems.AtomicCounters">AWS documentation</a>, and I will provide an example for how to do so with the Java AWS SDK 2.0, which has full reactive support.</p>
<p>We will start by building off work done on a previous post where we <a href="https://nickolasfisher.com/blog/Configuring-an-In-Memory-DynamoDB-instance-with-Java-for-Integration-Testing">set up an embedded DynamoDB instance and integrated it with the AWS SDK 2.0</a>. With that in place, we can create a test table and add an item to work with [we obviously will need an item to increment in order to prove this out]:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">atomicCounting</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>        String currentTableName <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>#34;PhonesAtomicCounting<span style="color:#ff79c6">&amp;</span>#34;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        createTableAndWaitForComplete(currentTableName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        String stubCompanyName <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>#34;Nokia<span style="color:#ff79c6">&amp;</span>#34;;
</span></span><span style="display:flex;"><span>        String stubPhoneName <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>#34;flip<span style="color:#ff79c6">-</span>phone<span style="color:#ff79c6">-</span>1<span style="color:#ff79c6">&amp;</span>#34;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#ff79c6">&amp;</span>lt;String, AttributeValue<span style="color:#ff79c6">&amp;</span>gt; itemAttributes <span style="color:#ff79c6">=</span> getMapWith(stubCompanyName, stubPhoneName);
</span></span><span style="display:flex;"><span>        itemAttributes.<span style="color:#50fa7b">put</span>(<span style="color:#ff79c6">&amp;</span>#34;Color<span style="color:#ff79c6">&amp;</span>#34;, AttributeValue.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">s</span>(<span style="color:#ff79c6">&amp;</span>#34;Orange<span style="color:#ff79c6">&amp;</span>#34;).<span style="color:#50fa7b">build</span>());
</span></span><span style="display:flex;"><span>        itemAttributes.<span style="color:#50fa7b">put</span>(<span style="color:#ff79c6">&amp;</span>#34;Version<span style="color:#ff79c6">&amp;</span>#34;, AttributeValue.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">n</span>(Long.<span style="color:#50fa7b">valueOf</span>(1L).<span style="color:#50fa7b">toString</span>()).<span style="color:#50fa7b">build</span>());
</span></span><span style="display:flex;"><span>        itemAttributes.<span style="color:#50fa7b">put</span>(<span style="color:#ff79c6">&amp;</span>#34;NumberSold<span style="color:#ff79c6">&amp;</span>#34;, AttributeValue.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">n</span>(Long.<span style="color:#50fa7b">valueOf</span>(1L).<span style="color:#50fa7b">toString</span>()).<span style="color:#50fa7b">build</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        PutItemRequest populateDataItemRequest <span style="color:#ff79c6">=</span> PutItemRequest.<span style="color:#50fa7b">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">tableName</span>(currentTableName)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">item</span>(itemAttributes)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">build</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// populate initial data</span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(Mono.<span style="color:#50fa7b">fromFuture</span>(dynamoDbAsyncClient.<span style="color:#50fa7b">putItem</span>(populateDataItemRequest)))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">expectNextCount</span>(1)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">verifyComplete</span>();
</span></span></code></pre></div><p>We create a partition and sort key on a table called <strong>PhonesAtomicCounting</strong>. This table stores phones, so we put a phone in there where the company that creates the phone is named &quot;Nokia&quot; and the phone name is &quot;flip-phone-1&quot;. Other item attributes include &quot;Color&quot;, &quot;Version&quot;, and &quot;NumberSold&quot;.</p>
<p>Now let's say that we want to blindly increment <strong>NumberSold</strong>, and we're okay with the consequences/caveat that it's not idempotent [it will increment every time it's called, if you want idempotency you will want to look into Optimistic Locking]. If that's our game, this is how it can be done:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        UpdateItemRequest updateItemRequest <span style="color:#ff79c6">=</span> UpdateItemRequest.<span style="color:#50fa7b">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">tableName</span>(currentTableName)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">key</span>(getMapWith(stubCompanyName, stubPhoneName))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">updateExpression</span>(<span style="color:#ff79c6">&amp;</span>#34;SET Version <span style="color:#ff79c6">=</span> Version <span style="color:#ff79c6">&amp;</span>#43; :incr_amt, NumberSold <span style="color:#ff79c6">=</span> NumberSold <span style="color:#ff79c6">&amp;</span>#43; :num_sold_incr_amt<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">expressionAttributeValues</span>(Map.<span style="color:#50fa7b">of</span>(
</span></span><span style="display:flex;"><span>                        <span style="color:#ff79c6">&amp;</span>#34;:incr_amt<span style="color:#ff79c6">&amp;</span>#34;,
</span></span><span style="display:flex;"><span>                        AttributeValue.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">n</span>(<span style="color:#ff79c6">&amp;</span>#34;1<span style="color:#ff79c6">&amp;</span>#34;).<span style="color:#50fa7b">build</span>(),
</span></span><span style="display:flex;"><span>                        <span style="color:#ff79c6">&amp;</span>#34;:num_sold_incr_amt<span style="color:#ff79c6">&amp;</span>#34;,
</span></span><span style="display:flex;"><span>                        AttributeValue.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">n</span>(<span style="color:#ff79c6">&amp;</span>#34;2<span style="color:#ff79c6">&amp;</span>#34;).<span style="color:#50fa7b">build</span>()
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">build</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(Mono.<span style="color:#50fa7b">fromFuture</span>(() <span style="color:#ff79c6">-&amp;</span>gt; dynamoDbAsyncClient.<span style="color:#50fa7b">updateItem</span>(updateItemRequest)))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">expectNextMatches</span>(updateItemResponse <span style="color:#ff79c6">-&amp;</span>gt; {
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span>;
</span></span><span style="display:flex;"><span>                }).<span style="color:#50fa7b">verifyComplete</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(Mono.<span style="color:#50fa7b">fromFuture</span>(dynamoDbAsyncClient.<span style="color:#50fa7b">getItem</span>(
</span></span><span style="display:flex;"><span>                GetItemRequest.<span style="color:#50fa7b">builder</span>()
</span></span><span style="display:flex;"><span>                        .<span style="color:#50fa7b">tableName</span>(currentTableName)
</span></span><span style="display:flex;"><span>                        .<span style="color:#50fa7b">key</span>(getMapWith(stubCompanyName, stubPhoneName))
</span></span><span style="display:flex;"><span>                        .<span style="color:#50fa7b">build</span>())
</span></span><span style="display:flex;"><span>            ))
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">expectNextMatches</span>(getItemResponse <span style="color:#ff79c6">-&amp;</span>gt; getItemResponse.<span style="color:#50fa7b">item</span>().<span style="color:#50fa7b">get</span>(<span style="color:#ff79c6">&amp;</span>#34;NumberSold<span style="color:#ff79c6">&amp;</span>#34;).<span style="color:#50fa7b">n</span>().<span style="color:#50fa7b">equals</span>(<span style="color:#ff79c6">&amp;</span>#34;3<span style="color:#ff79c6">&amp;</span>#34;))
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">verifyComplete</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Here, we update the item we created previously by incrementing <strong>Version</strong> by 1 and <strong>NumberSold</strong> by 2. We then verify that our changes applied by getting the item out of the table and verifying that the <strong>NumberSold</strong> did indeed increment by two.</p>
</section>

  
    
  

    
  


  <footer>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
