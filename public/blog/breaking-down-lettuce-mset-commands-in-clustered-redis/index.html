<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Breaking down Lettuce MSET Commands in Clustered Redis</title>
<meta
  name="description"
  content="To follow along with this post, it would be best if you have already set up your local redis cluster and know how to connect to a redis cluster and interact with it via Lettuce. And the source code for what follows can be found on Github."
/>
<link rel="canonical" href="http://localhost:1313/blog/breaking-down-lettuce-mset-commands-in-clustered-redis/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">Breaking down Lettuce MSET Commands in Clustered Redis</h2>

    <div class="meta">
      
      <time datetime="2021-04-10 23:26:07 &#43;0000 UTC" title='Sat, Apr 10, 2021, 11:26 PM UTC'>
        10/04/2021 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>To follow along with this post, it would be best if you have already <a href="https://nickolasfisher.com/blog/Bootstrap-a-Local-Sharded-Redis-Cluster-in-Five-Minutes">set up your local redis cluster</a> and know how to <a href="https://nickolasfisher.com/blog/Configuring-Lettuce-to-work-with-Clustered-Redis">connect to a redis cluster and interact with it via Lettuce</a>. And the source code for what follows <a href="https://github.com/nfisher23/reactive-programming-webflux">can be found on Github</a>.</p>
<p>If you are interacting with clustered redis, and you issue an MSET or MGET command directly against a node without a hash tag, you are very likely going to get rejected from the redis node that you're interacting with unless you get lucky and the hash slot that the keys go into just happen to all go into that single redis node. For example [assuming you have clustered redis running locally, and one port is 30001]:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ redis-cli -p <span style="color:#bd93f9">30001</span> -c
</span></span><span style="display:flex;"><span>127.0.0.1:30001&amp;gt; MSET &amp;<span style="color:#6272a4">#34;one&amp;#34; 1 &amp;#34;two&amp;#34; 2 &amp;#34;three&amp;#34; 3</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">(</span>error<span style="color:#ff79c6">)</span> CROSSSLOT Keys in request don&amp;<span style="color:#6272a4">#39;t hash to the same slot</span>
</span></span></code></pre></div><p>To solve this problem when you're interacting using the cli, you typically have to provide a hash tag that prefixes your key. If these are all the same, then redis will use that in the hash slot calculation and put them all on one node:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ redis-cli -p <span style="color:#bd93f9">30001</span> -c
</span></span><span style="display:flex;"><span>127.0.0.1:30001&amp;gt; mset <span style="color:#ff79c6">{</span>one<span style="color:#ff79c6">}</span>first <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">{</span>one<span style="color:#ff79c6">}</span>second <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">{</span>one<span style="color:#ff79c6">}</span>third <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>-&amp;gt; Redirected to slot <span style="color:#ff79c6">[</span>9084<span style="color:#ff79c6">]</span> located at 127.0.0.1:30002
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:30002&amp;gt; KEYS *
</span></span><span style="display:flex;"><span>1<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;{one}third&amp;#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;{one}second&amp;#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;{one}first&amp;#34;</span>
</span></span></code></pre></div><p>If you're using lettuce, you might initially think that you have to do the same thing. However, that doesn't turn out to be the case&ndash;lettuce is smart enough to do the hash slot calculation for you before issuing the MSET commands. For example, building off of the configuration we used in our last article:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Service
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">PostConstructExecutor</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> Logger LOG <span style="color:#ff79c6">=</span> Loggers.<span style="color:#50fa7b">getLogger</span>(PostConstructExecutor.<span style="color:#50fa7b">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> RedisClusterReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisClusterReactiveCommands;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">PostConstructExecutor</span>(RedisClusterReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisClusterReactiveCommands) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">redisClusterReactiveCommands</span> <span style="color:#ff79c6">=</span> redisClusterReactiveCommands;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @PostConstruct
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">doStuffOnClusteredRedis</span>() {
</span></span><span style="display:flex;"><span>        showMsetAcrossCluster();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">showMsetAcrossCluster</span>() {
</span></span><span style="display:flex;"><span>        LOG.<span style="color:#50fa7b">info</span>(<span style="color:#ff79c6">&amp;</span>#34;starting mset<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; map <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">&amp;</span>lt;<span style="color:#ff79c6">&amp;</span>gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0; i <span style="color:#ff79c6">&amp;</span>lt; 10; i<span style="color:#ff79c6">&amp;</span>#43;<span style="color:#ff79c6">&amp;</span>#43;) {
</span></span><span style="display:flex;"><span>            map.<span style="color:#50fa7b">put</span>(<span style="color:#ff79c6">&amp;</span>#34;key<span style="color:#ff79c6">&amp;</span>#34; <span style="color:#ff79c6">&amp;</span>#43; i, <span style="color:#ff79c6">&amp;</span>#34;value<span style="color:#ff79c6">&amp;</span>#34; <span style="color:#ff79c6">&amp;</span>#43; i);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// can follow with MONITOR to see the MSETs for just that node written, under the hood lettuce breaks</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// up the map, gets the hash slot and sends it to that node for you.</span>
</span></span><span style="display:flex;"><span>        redisClusterReactiveCommands
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">mset</span>(map)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">block</span>();
</span></span><span style="display:flex;"><span>        LOG.<span style="color:#50fa7b">info</span>(<span style="color:#ff79c6">&amp;</span>#34;done with mset<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>With this code, we don't see the same error message. We can further verify that the key/value pairs are actually getting set correctly with a tiny script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#ff79c6">for</span> port in <span style="color:#bd93f9">30001</span> <span style="color:#bd93f9">30002</span> 30003; <span style="color:#ff79c6">do</span> redis-cli -p <span style="color:#8be9fd;font-style:italic">$port</span> -c keys &amp;<span style="color:#6272a4">#39;*&amp;#39;; done</span>
</span></span><span style="display:flex;"><span>1<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;key7&amp;#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;key3&amp;#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;key2&amp;#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;key6&amp;#34;</span>
</span></span><span style="display:flex;"><span>1<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;key5&amp;#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;key1&amp;#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;key9&amp;#34;</span>
</span></span><span style="display:flex;"><span>1<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;key4&amp;#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;key8&amp;#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;key0&amp;#34;</span>
</span></span></code></pre></div><p>So what's happening? Well there are two pretty quick ways to try and find out. The first is to get on a node and run MONITOR:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>✗ redis-cli -p <span style="color:#bd93f9">30001</span> -c
</span></span><span style="display:flex;"><span>127.0.0.1:30001&amp;gt; MONITOR
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div><p>This will hold and send changes to the cluster until you send a SIGINT signal. If I fire up that java/lettuce code from above I see:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>1618703092.639258 <span style="color:#ff79c6">[</span><span style="color:#bd93f9">0</span> 127.0.0.1:45198<span style="color:#ff79c6">]</span> &amp;<span style="color:#6272a4">#34;MSET&amp;#34; &amp;#34;key6&amp;#34; &amp;#34;value6&amp;#34;</span>
</span></span><span style="display:flex;"><span>1618703092.646877 <span style="color:#ff79c6">[</span><span style="color:#bd93f9">0</span> 127.0.0.1:45198<span style="color:#ff79c6">]</span> &amp;<span style="color:#6272a4">#34;MSET&amp;#34; &amp;#34;key7&amp;#34; &amp;#34;value7&amp;#34;</span>
</span></span><span style="display:flex;"><span>1618703092.666848 <span style="color:#ff79c6">[</span><span style="color:#bd93f9">0</span> 127.0.0.1:45198<span style="color:#ff79c6">]</span> &amp;<span style="color:#6272a4">#34;MSET&amp;#34; &amp;#34;key2&amp;#34; &amp;#34;value2&amp;#34;</span>
</span></span><span style="display:flex;"><span>1618703092.678183 <span style="color:#ff79c6">[</span><span style="color:#bd93f9">0</span> 127.0.0.1:45198<span style="color:#ff79c6">]</span> &amp;<span style="color:#6272a4">#34;MSET&amp;#34; &amp;#34;key3&amp;#34; &amp;#34;value3&amp;#34;</span>
</span></span></code></pre></div><p>If you then set a debugger on the <strong>mset</strong> command above, you can see that lettuce is actually calculating the hash slot on your behalf [information it periodically collects from the cluster], and batches them against the appropriate node on your behalf using pipelining. Pretty cool stuff.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/spring/" alt="Spring">
          Spring
        </a>
      
        <a href="/tags/reactive/" alt="Reactive">
          Reactive
        </a>
      
        <a href="/tags/webflux/" alt="Webflux">
          Webflux
        </a>
      
        <a href="/tags/lettuce/" alt="Lettuce">
          Lettuce
        </a>
      
        <a href="/tags/redis/" alt="Redis">
          Redis
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
