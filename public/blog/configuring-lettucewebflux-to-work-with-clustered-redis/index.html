<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Configuring Lettuce/Webflux to work with Clustered Redis</title>
<meta
  name="description"
  content="Lettuce has some pretty nice out of the box support for working with clustered redis. This combination&ndash;a reactive client and application along with clustered redis&ndash;is about as scalable, performant, and resilient as things can get in distributed systems [though there are other tradeoffs which are not the subject of this post]."
/>
<link rel="canonical" href="http://localhost:1313/blog/configuring-lettucewebflux-to-work-with-clustered-redis/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/img/nficon.png" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">Configuring Lettuce/Webflux to work with Clustered Redis</h2>

    <div class="meta">
      
      <time datetime="2021-04-10 22:27:54 &#43;0000 UTC" title='Sat, Apr 10, 2021, 10:27 PM UTC'>
        10/04/2021 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>Lettuce has some pretty nice out of the box support for working with clustered redis. This combination&ndash;a reactive client and application along with clustered redis&ndash;is about as scalable, performant, and resilient as things can get in distributed systems [though there are other tradeoffs which are not the subject of this post].</p>
<p>Demonstrating some basic configuration to make these two systems play nice will be the subject of this post.</p>
<p>To follow along here, you're going to want to make sure you have <a href="https://nickolasfisher.com/blog/Bootstrap-a-Local-Sharded-Redis-Cluster-in-Five-Minutes">set up a locally running sharded redis cluster</a>. With that in place, steps to get lettuce working against it in a pretty seamless way are as follows.</p>
<p>First, add lettuce to your <strong>pom.xml</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        &amp;lt;dependency&amp;gt;
</span></span><span style="display:flex;"><span>            &amp;lt;groupId&amp;gt;io.lettuce&amp;lt;/groupId&amp;gt;
</span></span><span style="display:flex;"><span>            &amp;lt;artifactId&amp;gt;lettuce-core&amp;lt;/artifactId&amp;gt;
</span></span><span style="display:flex;"><span>            &amp;lt;version&amp;gt;6.1.0.RELEASE&amp;lt;/version&amp;gt;
</span></span><span style="display:flex;"><span>        &amp;lt;/dependency&amp;gt;
</span></span></code></pre></div><p>Then add some configuration that sets up a <strong>RedisClusterClient</strong> and <strong>RedisClusterReactiveCommands</strong>: bean</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@ConfigurationProperties(<span style="color:#ff79c6">&amp;</span>#34;redis<span style="color:#ff79c6">-</span>cluster<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">LettuceConfig</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> String host;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">int</span> port;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">getHost</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> host;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setHost</span>(String host) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">host</span> <span style="color:#ff79c6">=</span> host;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">getPort</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> port;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setPort</span>(<span style="color:#8be9fd">int</span> port) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">port</span> <span style="color:#ff79c6">=</span> port;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> RedisClusterReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisPrimaryReactiveCommands(RedisClusterClient redisClusterClient) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> redisClusterClient.<span style="color:#50fa7b">connect</span>().<span style="color:#50fa7b">reactive</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> RedisClusterClient <span style="color:#50fa7b">redisClient</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> RedisClusterClient.<span style="color:#50fa7b">create</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// adjust things like thread pool size with client resources</span>
</span></span><span style="display:flex;"><span>                ClientResources.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">build</span>(),
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&amp;</span>#34;redis:<span style="color:#6272a4">//&amp;#34; &amp;#43; this.getHost() &amp;#43; &amp;#34;:&amp;#34; &amp;#43; this.getPort()</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And change your <strong>application.yml</strong> so that this config can actually work:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">redis-cluster</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">host</span>: <span style="color:#bd93f9">127.0.0.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">30001</span>
</span></span></code></pre></div><p>Note that I've chosen port <strong>30001</strong> because that's a primary node in my clustered redis configuration that was started up via the last post. Be sure to make sure that this config matches up with at least one of the nodes in your cluster [it doesn't matter which one, for the sake of this tutorial]</p>
<p>Now let's actually use this to write some data to our redis cluster:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Service
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">PostConstructExecutor</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> RedisClusterReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisClusterReactiveCommands;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">PostConstructExecutor</span>(RedisClusterReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisClusterReactiveCommands) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">redisClusterReactiveCommands</span> <span style="color:#ff79c6">=</span> redisClusterReactiveCommands;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @PostConstruct
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">doStuffOnClusteredRedis</span>() {
</span></span><span style="display:flex;"><span>        SetArgs setArgs <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> SetArgs();
</span></span><span style="display:flex;"><span>        setArgs.<span style="color:#50fa7b">ex</span>(Duration.<span style="color:#50fa7b">ofSeconds</span>(10));
</span></span><span style="display:flex;"><span>        Mono<span style="color:#ff79c6">&amp;</span>lt;String<span style="color:#ff79c6">&amp;</span>gt; command <span style="color:#ff79c6">=</span> Mono.<span style="color:#50fa7b">empty</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0; i <span style="color:#ff79c6">&amp;</span>lt; 10; i<span style="color:#ff79c6">&amp;</span>#43;<span style="color:#ff79c6">&amp;</span>#43;) {
</span></span><span style="display:flex;"><span>            command <span style="color:#ff79c6">=</span> command.<span style="color:#50fa7b">then</span>(redisClusterReactiveCommands.<span style="color:#50fa7b">set</span>(<span style="color:#ff79c6">&amp;</span>#34;hello<span style="color:#ff79c6">-&amp;</span>#34; <span style="color:#ff79c6">&amp;</span>#43; i, <span style="color:#ff79c6">&amp;</span>#34;no <span style="color:#ff79c6">&amp;</span>#34; <span style="color:#ff79c6">&amp;</span>#43; i, setArgs));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        command.<span style="color:#50fa7b">block</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>When you start up this application, our chained set of commands will create 10 redis key/value pairs which are just strings, for example &quot; <strong>hello-1&quot; -&gt; &quot;no 1&quot;</strong>. It also, critically, sets the expiry of each of the items that we add in there to 10 seconds. If you start up this application, the <strong>@PostConstruct</strong> method will run and add those key/value pairs to the cluster.</p>
<p>We can verify that with a simple script that iterates through each primary instance in our cluster and runs a &quot;KEYS *&quot;, like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#ff79c6">for</span> port in <span style="color:#bd93f9">30001</span> <span style="color:#bd93f9">30002</span> 30003; <span style="color:#ff79c6">do</span> redis-cli -p <span style="color:#8be9fd;font-style:italic">$port</span> -c keys &amp;<span style="color:#6272a4">#39;*&amp;#39;; done</span>
</span></span><span style="display:flex;"><span>1<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;hello-0&amp;#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;hello-8&amp;#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;hello-4&amp;#34;</span>
</span></span><span style="display:flex;"><span>1<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;hello-1&amp;#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;hello-5&amp;#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;hello-2&amp;#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;hello-6&amp;#34;</span>
</span></span><span style="display:flex;"><span>5<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;hello-9&amp;#34;</span>
</span></span><span style="display:flex;"><span>1<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;hello-7&amp;#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ff79c6">)</span> &amp;<span style="color:#6272a4">#34;hello-3&amp;#34;</span>
</span></span></code></pre></div><p>Again, if your port numbers for your local clustered redis are different, then you should use those instead of <strong>30001 30002 30003</strong>. And with this, you should be good to go.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/spring/" alt="Spring">
          Spring
        </a>
      
        <a href="/tags/reactive/" alt="Reactive">
          Reactive
        </a>
      
        <a href="/tags/webflux/" alt="Webflux">
          Webflux
        </a>
      
        <a href="/tags/lettuce/" alt="Lettuce">
          Lettuce
        </a>
      
        <a href="/tags/redis/" alt="Redis">
          Redis
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
