<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How to Benchmark Java Code Using JUnit and JMH</title>
<meta
  name="description"
  content="You can view the sample code associated with this post on GitHub.
JMH is a lightweight code generator that can benchmark Java code. While many of the performance bottlenecks in today&#39;s world are related to network calls and/or database queries, it&#39;s still a good idea to understand the performance of our code at a lower level. In particular, by automating performance tests on our code, we can usually at least ensure that the performance was not accidentally made worse by some refactoring effort."
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-benchmark-java-code-using-junit-and-jmh/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        Home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        Blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        About me
      </a>
    </li>
    
    <li>
      <a href="/categories" class="">
        Categories
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How to Benchmark Java Code Using JUnit and JMH</h2>

    <div class="meta">
      
      <time datetime="2018-11-01 00:00:00 &#43;0000 UTC" title='Thu, Nov 1, 2018, 12:00 AM UTC'>
        01/11/2018 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>You can view the sample code associated with this post <a href="https://github.com/nfisher23/jmh-junit-intro">on GitHub</a>.</p>
<p><a href="https://openjdk.java.net/projects/code-tools/jmh/">JMH</a> is a lightweight code generator that can benchmark Java code. While many of the performance bottlenecks in today's world are related to network calls and/or database queries, it's still a good idea to understand the performance of our code at a lower level. In particular, by automating performance tests on our code, we can usually at least ensure that the performance was not accidentally made worse by some refactoring effort.</p>
<p>By insisting on running our JMH benchmarks in JUnit code, we can quickly and easily set up continuous integration. While this is not the &quot;recommended&quot; approach, in my experience it has been consistent in its results. Especially since this is best used as a learning tool, let's just get from zero to one as quickly as possible.</p>
<p>First, you'll need the maven dependency:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>&amp;lt;dependency&amp;gt;
</span></span><span style="display:flex;"><span>    &amp;lt;groupId&amp;gt;org.openjdk.jmh&amp;lt;/groupId&amp;gt;
</span></span><span style="display:flex;"><span>    &amp;lt;artifactId&amp;gt;jmh-generator-annprocess&amp;lt;/artifactId&amp;gt;
</span></span><span style="display:flex;"><span>    &amp;lt;version&amp;gt;1.21&amp;lt;/version&amp;gt;
</span></span><span style="display:flex;"><span>    &amp;lt;scope&amp;gt;test&amp;lt;/scope&amp;gt;
</span></span><span style="display:flex;"><span>&amp;lt;/dependency&amp;gt;
</span></span></code></pre></div><p>All you need is one JUnit test case, which will be the entry point for all of the benchmarks in your file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">runBenchmarks</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    Options options <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> OptionsBuilder()
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">include</span>(<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">getClass</span>().<span style="color:#50fa7b">getName</span>() <span style="color:#ff79c6">&amp;</span>#43; <span style="color:#ff79c6">&amp;</span>#34;.<span style="color:#ff79c6">*&amp;</span>#34;)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">mode</span>(Mode.<span style="color:#50fa7b">AverageTime</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">warmupTime</span>(TimeValue.<span style="color:#50fa7b">seconds</span>(1))
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">warmupIterations</span>(6)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">threads</span>(1)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">measurementIterations</span>(6)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">forks</span>(1)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">shouldFailOnError</span>(<span style="color:#ff79c6">true</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">shouldDoGC</span>(<span style="color:#ff79c6">true</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">build</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">new</span> Runner(options).<span style="color:#50fa7b">run</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Be sure to configure the options as you see fit. The fluent API makes it all pretty intuitive. Do be careful if you're using OS resources, however, because if you have multiple threads running at the same time, then you will likely see inconsistent results as all the threads battle for the same resources.</p>
<p>Then, each benchmark case you want to run will be annotated with <code>@Benchmark</code>. For these examples, we are going to compare the performance difference between using a <code>StringBuilder</code> and concatenating Strings. Since Strings are immutable, when we choose to concatenate them, the runtime engine reinitializes another String and populates it with each character that came before it. That is, something like <code>str1 = str1 &amp;#43; &amp;#34;something&amp;#34;;</code> would create a new string by iterating through each character in <code>str1</code> and &quot;something&quot;.</p>
<p>A <code>StringBuilder</code> fixes all of this, because it creates an ArrayList that takes existing strings and populates them into the ArrayList. When we are done, it concatenates everything in the data structure one time, which is much less costly. Here we will run the sub-optimal version described above:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> String hello <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>#34;not another hello world<span style="color:#ff79c6">&amp;</span>#34;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Benchmark
</span></span><span style="display:flex;"><span>@OutputTimeUnit(TimeUnit.<span style="color:#50fa7b">MILLISECONDS</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">stringsWithoutStringBuilder</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    String hellos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">&amp;</span>#34;;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0; i <span style="color:#ff79c6">&amp;</span>lt; 1000; i<span style="color:#ff79c6">&amp;</span>#43;<span style="color:#ff79c6">&amp;</span>#43;) {
</span></span><span style="display:flex;"><span>        hellos <span style="color:#ff79c6">&amp;</span>#43;<span style="color:#ff79c6">=</span> hello;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (i <span style="color:#ff79c6">!=</span> 999) {
</span></span><span style="display:flex;"><span>            hellos <span style="color:#ff79c6">&amp;</span>#43;<span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>#34;\n<span style="color:#ff79c6">&amp;</span>#34;;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    assertTrue(hellos.<span style="color:#50fa7b">startsWith</span>((hello <span style="color:#ff79c6">&amp;</span>#43; <span style="color:#ff79c6">&amp;</span>#34;\n<span style="color:#ff79c6">&amp;</span>#34;)));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And here, we show the method that uses <code>StringBuilder</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Benchmark
</span></span><span style="display:flex;"><span>@OutputTimeUnit(TimeUnit.<span style="color:#50fa7b">MILLISECONDS</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">stringsWithStringBuilder</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    StringBuilder hellosBuilder <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0; i <span style="color:#ff79c6">&amp;</span>lt; 1000; i<span style="color:#ff79c6">&amp;</span>#43;<span style="color:#ff79c6">&amp;</span>#43;) {
</span></span><span style="display:flex;"><span>        hellosBuilder.<span style="color:#50fa7b">append</span>(hello);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (i <span style="color:#ff79c6">!=</span> 999) {
</span></span><span style="display:flex;"><span>            hellosBuilder.<span style="color:#50fa7b">append</span>(<span style="color:#ff79c6">&amp;</span>#34;\n<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    assertTrue(hellosBuilder.<span style="color:#50fa7b">toString</span>().<span style="color:#50fa7b">startsWith</span>((hello <span style="color:#ff79c6">&amp;</span>#43; <span style="color:#ff79c6">&amp;</span>#34;\n<span style="color:#ff79c6">&amp;</span>#34;)));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The JMH benchmarks output the following on my machine (be sure to get the code and try them yourself):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Benchmark                                                   Mode  Cnt  Score   Error  Units
</span></span><span style="display:flex;"><span>JmhJunitSampleApplicationTests.stringsWithStringBuilder     avgt    <span style="color:#bd93f9">6</span>  0.031 ± 0.005  ms/op
</span></span><span style="display:flex;"><span>JmhJunitSampleApplicationTests.stringsWithoutStringBuilder  avgt    <span style="color:#bd93f9">6</span>  3.738 ± 0.614  ms/op
</span></span></code></pre></div><p>As expected, concatenating the strings each time was much more costly, and in this case was ~120 times slower.</p>
<p>For details on how to take full advantage of the JMH framework, be sure to read through the <a href="https://hg.openjdk.java.net/code-tools/jmh/file/tip/jmh-samples/src/main/java/org/openjdk/jmh/samples/">samples</a>, which double as well explained tutorials.</p>
</section>

  
    
  

    
  


  <footer>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
