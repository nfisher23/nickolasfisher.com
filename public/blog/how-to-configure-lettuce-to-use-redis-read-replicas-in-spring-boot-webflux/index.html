<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How to Configure Lettuce to use Redis Read Replicas in Spring Boot Webflux</title>
<meta
  name="description"
  content="The source code for this post can be found on Github.
Lettuce supports reading from redis replicas, but with the caveat that it doesn&#39;t [out of the box] provide you with the fine-grained control over when to read from the replicas that you&#39;re likely to want."
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-configure-lettuce-to-use-redis-read-replicas-in-spring-boot-webflux/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/img/nficon.png" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How to Configure Lettuce to use Redis Read Replicas in Spring Boot Webflux</h2>

    <div class="meta">
      
      <time datetime="2021-03-28 19:22:27 &#43;0000 UTC" title='Sun, Mar 28, 2021, 7:22 PM UTC'>
        28/03/2021 - Estimated reading time: 6 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>The source code for this post <a href="https://github.com/nfisher23/reactive-programming-webflux">can be found on Github</a>.</p>
<p>Lettuce supports reading from redis replicas, but with the caveat that it doesn't [out of the box] provide you with the fine-grained control over <em>when</em> to read from the replicas that you're likely to want.</p>
<p>You can, as the documentation states, just set up your redis client like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> RedisStringReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisReplicaReactiveCommands(RedisConfig redisConfig) {
</span></span><span style="display:flex;"><span>        RedisURI redisPrimaryURI <span style="color:#ff79c6">=</span> RedisURI.<span style="color:#50fa7b">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">withHost</span>(redisConfig.<span style="color:#50fa7b">getHost</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">withPort</span>(redisConfig.<span style="color:#50fa7b">getPort</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">build</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        RedisClient redisClient <span style="color:#ff79c6">=</span> RedisClient.<span style="color:#50fa7b">create</span>(
</span></span><span style="display:flex;"><span>                redisPrimaryURI
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StatefulRedisMasterReplicaConnection<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; primaryAndReplicaConnection <span style="color:#ff79c6">=</span> MasterReplica.<span style="color:#50fa7b">connect</span>(
</span></span><span style="display:flex;"><span>                redisClient,
</span></span><span style="display:flex;"><span>                StringCodec.<span style="color:#50fa7b">UTF8</span>,
</span></span><span style="display:flex;"><span>                redisPrimaryURI
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        primaryAndReplicaConnection.<span style="color:#50fa7b">setReadFrom</span>(ReadFrom.<span style="color:#50fa7b">REPLICA</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> primaryAndReplicaConnection.<span style="color:#50fa7b">reactive</span>();
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>But what if you have parts of your application where eventual consistency can be tolerated, but parts of your application require strong consistency? If you have no call-by-call control over whether you're reading from the primary or replica, this is going to be impossible. We will walk through the extra steps you'll need to do to get that fine grained consistency in this article</p>
<h3 id="local-leaderfollower-redis">Local Leader/Follower Redis</h3>
<p>Let's start by reusing work from a previous post where we set up a redis leader/follower setup. We leveraged docker/docker compose, where our <strong>docker-compose.yaml</strong> looked like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">version</span>: <span style="color:#ff79c6">&amp;#39;3.8&amp;#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">leader</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">image</span>: redis
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">&amp;#34;6379:6379&amp;#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#bd93f9">6379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">networks</span>:
</span></span><span style="display:flex;"><span>      - local
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">follower</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">image</span>: redis
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">&amp;#34;6380:6379&amp;#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#bd93f9">6379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">networks</span>:
</span></span><span style="display:flex;"><span>      - local
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">command</span>: [<span style="color:#ff79c6">&amp;#34;--replicaof&amp;#34;,</span> <span style="color:#ff79c6">&amp;#34;leader&amp;#34;,</span> <span style="color:#ff79c6">&amp;#34;6379&amp;#34;]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">networks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">driver</span>: bridge
</span></span></code></pre></div><p>Running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker-compose up -d
</span></span></code></pre></div><p>Sets this up, and you can refer to the previous post for how to run some basic sanity checks on that</p>
<h3 id="configuring-lettuce">Configuring Lettuce</h3>
<p><em>Be sure to check out the &quot;caveat&quot; section below if you planning on running the sample code locally.</em></p>
<p>To get lettuce to play ball, we can leverage spring qualifiers to pass in a different <strong>RedisStringReactiveCommands</strong> service into our data service.
The basic idea is that we will configure two different clients: one that connects to the primary for everything, and one that uses the read replicas. Here's the config class:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RedisConfig</span> {
</span></span><span style="display:flex;"><span>    @Bean(<span style="color:#ff79c6">&amp;</span>#34;redis<span style="color:#ff79c6">-</span>primary<span style="color:#ff79c6">-</span>commands<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> RedisStringReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisPrimaryReactiveCommands(RedisClient redisClient) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> redisClient.<span style="color:#50fa7b">connect</span>().<span style="color:#50fa7b">reactive</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean(<span style="color:#ff79c6">&amp;</span>#34;redis<span style="color:#ff79c6">-</span>primary<span style="color:#ff79c6">-</span>client<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> RedisClient <span style="color:#50fa7b">redisClient</span>(RedisPrimaryConfig redisPrimaryConfig) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> RedisClient.<span style="color:#50fa7b">create</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// adjust things like thread pool size with client resources</span>
</span></span><span style="display:flex;"><span>                ClientResources.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">build</span>(),
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&amp;</span>#34;redis:<span style="color:#6272a4">//&amp;#34; &amp;#43; redisPrimaryConfig.getHost() &amp;#43; &amp;#34;:&amp;#34; &amp;#43; redisPrimaryConfig.getPort()</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean(<span style="color:#ff79c6">&amp;</span>#34;redis<span style="color:#ff79c6">-</span>replica<span style="color:#ff79c6">-</span>commands<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> RedisStringReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisReplicaReactiveCommands(RedisPrimaryConfig redisPrimaryConfig) {
</span></span><span style="display:flex;"><span>        RedisURI redisPrimaryURI <span style="color:#ff79c6">=</span> RedisURI.<span style="color:#50fa7b">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">withHost</span>(redisPrimaryConfig.<span style="color:#50fa7b">getHost</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">withPort</span>(redisPrimaryConfig.<span style="color:#50fa7b">getPort</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">build</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        RedisClient redisClient <span style="color:#ff79c6">=</span> RedisClient.<span style="color:#50fa7b">create</span>(
</span></span><span style="display:flex;"><span>                redisPrimaryURI
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StatefulRedisMasterReplicaConnection<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; primaryAndReplicaConnection <span style="color:#ff79c6">=</span> MasterReplica.<span style="color:#50fa7b">connect</span>(
</span></span><span style="display:flex;"><span>                redisClient,
</span></span><span style="display:flex;"><span>                StringCodec.<span style="color:#50fa7b">UTF8</span>,
</span></span><span style="display:flex;"><span>                redisPrimaryURI
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        primaryAndReplicaConnection.<span style="color:#50fa7b">setReadFrom</span>(ReadFrom.<span style="color:#50fa7b">REPLICA</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> primaryAndReplicaConnection.<span style="color:#50fa7b">reactive</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>With this, we can modify our service to use it properly like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Service
</span></span><span style="display:flex;"><span>@Log4j2
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RedisDataService</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> RedisStringReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisPrimaryCommands;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> RedisStringReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisReplicaCommands;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">RedisDataService</span>(
</span></span><span style="display:flex;"><span>            @Qualifier(<span style="color:#ff79c6">&amp;</span>#34;redis<span style="color:#ff79c6">-</span>primary<span style="color:#ff79c6">-</span>commands<span style="color:#ff79c6">&amp;</span>#34;) RedisStringReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisPrimaryCommands,
</span></span><span style="display:flex;"><span>            @Qualifier(<span style="color:#ff79c6">&amp;</span>#34;redis<span style="color:#ff79c6">-</span>replica<span style="color:#ff79c6">-</span>commands<span style="color:#ff79c6">&amp;</span>#34;) RedisStringReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisReplicaCommands
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">redisPrimaryCommands</span> <span style="color:#ff79c6">=</span> redisPrimaryCommands;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">redisReplicaCommands</span> <span style="color:#ff79c6">=</span> redisReplicaCommands;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;Void<span style="color:#ff79c6">&amp;</span>gt; writeThing(Thing thing) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">redisPrimaryCommands</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">set</span>(thing.<span style="color:#50fa7b">getId</span>().<span style="color:#50fa7b">toString</span>(), thing.<span style="color:#50fa7b">getValue</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">then</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;Thing<span style="color:#ff79c6">&amp;</span>gt; getThing(Integer id) {
</span></span><span style="display:flex;"><span>        log.<span style="color:#50fa7b">info</span>(<span style="color:#ff79c6">&amp;</span>#34;getting {} from replica<span style="color:#ff79c6">&amp;</span>#34;, id);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">redisReplicaCommands</span>.<span style="color:#50fa7b">get</span>(id.<span style="color:#50fa7b">toString</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">map</span>(response <span style="color:#ff79c6">-&amp;</span>gt; Thing.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">id</span>(id).<span style="color:#50fa7b">value</span>(response).<span style="color:#50fa7b">build</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;Thing<span style="color:#ff79c6">&amp;</span>gt; getThingPrimary(Integer id) {
</span></span><span style="display:flex;"><span>        log.<span style="color:#50fa7b">info</span>(<span style="color:#ff79c6">&amp;</span>#34;getting {} from primary<span style="color:#ff79c6">&amp;</span>#34;, id);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">redisPrimaryCommands</span>.<span style="color:#50fa7b">get</span>(id.<span style="color:#50fa7b">toString</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">map</span>(response <span style="color:#ff79c6">-&amp;</span>gt; Thing.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">id</span>(id).<span style="color:#50fa7b">value</span>(response).<span style="color:#50fa7b">build</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here, anytime you call <strong>getThingPrimary</strong>, it will use a client connection pool that only communicates with the primary node. When you call <strong>getThing</strong>, it will pick one of the replicas to execute the <strong>get</strong> command against.</p>
<p>Let's set up a controller to do some sanity testing that our configuration does what it's supposed to:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@RestController
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">SampleController</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> RedisDataService redisDataService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">SampleController</span>(RedisDataService redisDataService) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">redisDataService</span> <span style="color:#ff79c6">=</span> redisDataService;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">/</span>redis<span style="color:#ff79c6">/</span>{key}<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;ResponseEntity<span style="color:#ff79c6">&amp;</span>lt;Thing<span style="color:#ff79c6">&amp;</span>gt;<span style="color:#ff79c6">&amp;</span>gt; getRedisValue(@PathVariable(<span style="color:#ff79c6">&amp;</span>#34;key<span style="color:#ff79c6">&amp;</span>#34;) Integer key) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> redisDataService.<span style="color:#50fa7b">getThing</span>(key)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">flatMap</span>(thing <span style="color:#ff79c6">-&amp;</span>gt; Mono.<span style="color:#50fa7b">just</span>(ResponseEntity.<span style="color:#50fa7b">ok</span>(thing)))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">defaultIfEmpty</span>(ResponseEntity.<span style="color:#50fa7b">notFound</span>().<span style="color:#50fa7b">build</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">/</span>primary<span style="color:#ff79c6">-</span>redis<span style="color:#ff79c6">/</span>{key}<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;ResponseEntity<span style="color:#ff79c6">&amp;</span>lt;Thing<span style="color:#ff79c6">&amp;</span>gt;<span style="color:#ff79c6">&amp;</span>gt; getPrimaryRedisValue(@PathVariable(<span style="color:#ff79c6">&amp;</span>#34;key<span style="color:#ff79c6">&amp;</span>#34;) Integer key) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> redisDataService.<span style="color:#50fa7b">getThingPrimary</span>(key)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">flatMap</span>(thing <span style="color:#ff79c6">-&amp;</span>gt; Mono.<span style="color:#50fa7b">just</span>(ResponseEntity.<span style="color:#50fa7b">ok</span>(thing)))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">defaultIfEmpty</span>(ResponseEntity.<span style="color:#50fa7b">notFound</span>().<span style="color:#50fa7b">build</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>One more thing we can do is add a package level debug log for lettuce, so we can inspect the output and see what commands are being executed where:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">redis-primary</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">host</span>: <span style="color:#bd93f9">127.0.0.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">6379</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">logging.level.io.lettuce.core</span>: DEBUG
</span></span></code></pre></div><p>When I start up the app locally, I can curl to invoke the endpoints:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ redis-cli <span style="color:#8be9fd;font-style:italic">set</span> <span style="color:#bd93f9">3</span> &amp;<span style="color:#6272a4">#34;something&amp;#34;</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>$ curl localhost:8080/redis/3 | json_pp
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>   &amp;<span style="color:#6272a4">#34;value&amp;#34; : &amp;#34;something&amp;#34;,</span>
</span></span><span style="display:flex;"><span>   &amp;<span style="color:#6272a4">#34;id&amp;#34; : 3</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>$ curl localhost:8080/primary-redis/3 | json_pp
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>   &amp;<span style="color:#6272a4">#34;id&amp;#34; : 3,</span>
</span></span><span style="display:flex;"><span>   &amp;<span style="color:#6272a4">#34;value&amp;#34; : &amp;#34;something&amp;#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>And with debug logging working as expected, I can see in the logs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> INFO <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>or-http-epoll-1<span style="color:#ff79c6">]</span> c.n.r.service.RedisDataService           : getting <span style="color:#bd93f9">3</span> from replica
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>or-http-epoll-1<span style="color:#ff79c6">]</span> io.lettuce.core.RedisChannelHandler      : dispatching <span style="color:#8be9fd;font-style:italic">command</span> SubscriptionCommand <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span>GET, <span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>ValueOutput <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>null, <span style="color:#8be9fd;font-style:italic">error</span><span style="color:#ff79c6">=</span>&amp;<span style="color:#6272a4">#39;null&amp;#39;], commandType=io.lettuce.core.protocol.Command]</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>or-http-epoll-1<span style="color:#ff79c6">]</span> i.l.c.m.MasterReplicaConnectionProvider  : getConnectionAsync<span style="color:#ff79c6">(</span>READ<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>or-http-epoll-1<span style="color:#ff79c6">]</span> io.lettuce.core.RedisChannelHandler      : dispatching <span style="color:#8be9fd;font-style:italic">command</span> SubscriptionCommand <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span>GET, <span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>ValueOutput <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>null, <span style="color:#8be9fd;font-style:italic">error</span><span style="color:#ff79c6">=</span>&amp;<span style="color:#6272a4">#39;null&amp;#39;], commandType=io.lettuce.core.protocol.Command]</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>or-http-epoll-1<span style="color:#ff79c6">]</span> i.lettuce.core.protocol.DefaultEndpoint  : <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">channel</span><span style="color:#ff79c6">=</span>0x049fafcf, /172.22.0.1:50614 -&amp;gt; 172.22.0.3/172.22.0.3:6379, <span style="color:#8be9fd;font-style:italic">epid</span><span style="color:#ff79c6">=</span>0x5<span style="color:#ff79c6">]</span> write<span style="color:#ff79c6">()</span> writeAndFlush <span style="color:#8be9fd;font-style:italic">command</span> SubscriptionCommand <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span>GET, <span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>ValueOutput <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>null, <span style="color:#8be9fd;font-style:italic">error</span><span style="color:#ff79c6">=</span>&amp;<span style="color:#6272a4">#39;null&amp;#39;], commandType=io.lettuce.core.protocol.Command]</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>or-http-epoll-1<span style="color:#ff79c6">]</span> i.lettuce.core.protocol.DefaultEndpoint  : <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">channel</span><span style="color:#ff79c6">=</span>0x049fafcf, /172.22.0.1:50614 -&amp;gt; 172.22.0.3/172.22.0.3:6379, <span style="color:#8be9fd;font-style:italic">epid</span><span style="color:#ff79c6">=</span>0x5<span style="color:#ff79c6">]</span> write<span style="color:#ff79c6">()</span> <span style="color:#ff79c6">done</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>llEventLoop-8-4<span style="color:#ff79c6">]</span> io.lettuce.core.protocol.CommandHandler  : <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">channel</span><span style="color:#ff79c6">=</span>0x049fafcf, /172.22.0.1:50614 -&amp;gt; 172.22.0.3/172.22.0.3:6379, <span style="color:#8be9fd;font-style:italic">epid</span><span style="color:#ff79c6">=</span>0x5, <span style="color:#8be9fd;font-style:italic">chid</span><span style="color:#ff79c6">=</span>0x5<span style="color:#ff79c6">]</span> write<span style="color:#ff79c6">(</span>ctx, SubscriptionCommand <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span>GET, <span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>ValueOutput <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>null, <span style="color:#8be9fd;font-style:italic">error</span><span style="color:#ff79c6">=</span>&amp;<span style="color:#6272a4">#39;null&amp;#39;], commandType=io.lettuce.core.protocol.Command], promise)</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>llEventLoop-8-4<span style="color:#ff79c6">]</span> io.lettuce.core.protocol.CommandEncoder  : <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">channel</span><span style="color:#ff79c6">=</span>0x049fafcf, /172.22.0.1:50614 -&amp;gt; 172.22.0.3/172.22.0.3:6379<span style="color:#ff79c6">]</span> writing <span style="color:#8be9fd;font-style:italic">command</span> SubscriptionCommand <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span>GET, <span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>ValueOutput <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>null, <span style="color:#8be9fd;font-style:italic">error</span><span style="color:#ff79c6">=</span>&amp;<span style="color:#6272a4">#39;null&amp;#39;], commandType=io.lettuce.core.protocol.Command]</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>llEventLoop-8-4<span style="color:#ff79c6">]</span> io.lettuce.core.protocol.CommandHandler  : <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">channel</span><span style="color:#ff79c6">=</span>0x049fafcf, /172.22.0.1:50614 -&amp;gt; 172.22.0.3/172.22.0.3:6379, <span style="color:#8be9fd;font-style:italic">epid</span><span style="color:#ff79c6">=</span>0x5, <span style="color:#8be9fd;font-style:italic">chid</span><span style="color:#ff79c6">=</span>0x5<span style="color:#ff79c6">]</span> Received: <span style="color:#bd93f9">15</span> bytes, <span style="color:#bd93f9">1</span> commands in the stack
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>llEventLoop-8-4<span style="color:#ff79c6">]</span> io.lettuce.core.protocol.CommandHandler  : <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">channel</span><span style="color:#ff79c6">=</span>0x049fafcf, /172.22.0.1:50614 -&amp;gt; 172.22.0.3/172.22.0.3:6379, <span style="color:#8be9fd;font-style:italic">epid</span><span style="color:#ff79c6">=</span>0x5, <span style="color:#8be9fd;font-style:italic">chid</span><span style="color:#ff79c6">=</span>0x5<span style="color:#ff79c6">]</span> Stack contains: <span style="color:#bd93f9">1</span> commands
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>llEventLoop-8-4<span style="color:#ff79c6">]</span> i.l.core.protocol.RedisStateMachine      : Decode <span style="color:#ff79c6">done</span>, empty stack: <span style="color:#8be9fd;font-style:italic">true</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>llEventLoop-8-4<span style="color:#ff79c6">]</span> io.lettuce.core.protocol.CommandHandler  : <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">channel</span><span style="color:#ff79c6">=</span>0x049fafcf, /172.22.0.1:50614 -&amp;gt; 172.22.0.3/172.22.0.3:6379, <span style="color:#8be9fd;font-style:italic">epid</span><span style="color:#ff79c6">=</span>0x5, <span style="color:#8be9fd;font-style:italic">chid</span><span style="color:#ff79c6">=</span>0x5<span style="color:#ff79c6">]</span> Completing <span style="color:#8be9fd;font-style:italic">command</span> SubscriptionCommand <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span>GET, <span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>ValueOutput <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>something, <span style="color:#8be9fd;font-style:italic">error</span><span style="color:#ff79c6">=</span>&amp;<span style="color:#6272a4">#39;null&amp;#39;], commandType=io.lettuce.core.protocol.Command]</span>
</span></span><span style="display:flex;"><span> INFO <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>or-http-epoll-2<span style="color:#ff79c6">]</span> c.n.r.service.RedisDataService           : getting <span style="color:#bd93f9">3</span> from primary
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>or-http-epoll-2<span style="color:#ff79c6">]</span> io.lettuce.core.RedisChannelHandler      : dispatching <span style="color:#8be9fd;font-style:italic">command</span> SubscriptionCommand <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span>GET, <span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>ValueOutput <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>null, <span style="color:#8be9fd;font-style:italic">error</span><span style="color:#ff79c6">=</span>&amp;<span style="color:#6272a4">#39;null&amp;#39;], commandType=io.lettuce.core.protocol.Command]</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>or-http-epoll-2<span style="color:#ff79c6">]</span> i.lettuce.core.protocol.DefaultEndpoint  : <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">channel</span><span style="color:#ff79c6">=</span>0xaf43d87d, /127.0.0.1:41600 -&amp;gt; 127.0.0.1/127.0.0.1:6379, <span style="color:#8be9fd;font-style:italic">epid</span><span style="color:#ff79c6">=</span>0x1<span style="color:#ff79c6">]</span> write<span style="color:#ff79c6">()</span> writeAndFlush <span style="color:#8be9fd;font-style:italic">command</span> SubscriptionCommand <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span>GET, <span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>ValueOutput <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>null, <span style="color:#8be9fd;font-style:italic">error</span><span style="color:#ff79c6">=</span>&amp;<span style="color:#6272a4">#39;null&amp;#39;], commandType=io.lettuce.core.protocol.Command]</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>or-http-epoll-2<span style="color:#ff79c6">]</span> i.lettuce.core.protocol.DefaultEndpoint  : <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">channel</span><span style="color:#ff79c6">=</span>0xaf43d87d, /127.0.0.1:41600 -&amp;gt; 127.0.0.1/127.0.0.1:6379, <span style="color:#8be9fd;font-style:italic">epid</span><span style="color:#ff79c6">=</span>0x1<span style="color:#ff79c6">]</span> write<span style="color:#ff79c6">()</span> <span style="color:#ff79c6">done</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>llEventLoop-5-1<span style="color:#ff79c6">]</span> io.lettuce.core.protocol.CommandHandler  : <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">channel</span><span style="color:#ff79c6">=</span>0xaf43d87d, /127.0.0.1:41600 -&amp;gt; 127.0.0.1/127.0.0.1:6379, <span style="color:#8be9fd;font-style:italic">epid</span><span style="color:#ff79c6">=</span>0x1, <span style="color:#8be9fd;font-style:italic">chid</span><span style="color:#ff79c6">=</span>0x1<span style="color:#ff79c6">]</span> write<span style="color:#ff79c6">(</span>ctx, SubscriptionCommand <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span>GET, <span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>ValueOutput <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>null, <span style="color:#8be9fd;font-style:italic">error</span><span style="color:#ff79c6">=</span>&amp;<span style="color:#6272a4">#39;null&amp;#39;], commandType=io.lettuce.core.protocol.Command], promise)</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>llEventLoop-5-1<span style="color:#ff79c6">]</span> io.lettuce.core.protocol.CommandEncoder  : <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">channel</span><span style="color:#ff79c6">=</span>0xaf43d87d, /127.0.0.1:41600 -&amp;gt; 127.0.0.1/127.0.0.1:6379<span style="color:#ff79c6">]</span> writing <span style="color:#8be9fd;font-style:italic">command</span> SubscriptionCommand <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span>GET, <span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>ValueOutput <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>null, <span style="color:#8be9fd;font-style:italic">error</span><span style="color:#ff79c6">=</span>&amp;<span style="color:#6272a4">#39;null&amp;#39;], commandType=io.lettuce.core.protocol.Command]</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>llEventLoop-5-1<span style="color:#ff79c6">]</span> io.lettuce.core.protocol.CommandHandler  : <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">channel</span><span style="color:#ff79c6">=</span>0xaf43d87d, /127.0.0.1:41600 -&amp;gt; 127.0.0.1/127.0.0.1:6379, <span style="color:#8be9fd;font-style:italic">epid</span><span style="color:#ff79c6">=</span>0x1, <span style="color:#8be9fd;font-style:italic">chid</span><span style="color:#ff79c6">=</span>0x1<span style="color:#ff79c6">]</span> Received: <span style="color:#bd93f9">15</span> bytes, <span style="color:#bd93f9">1</span> commands in the stack
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>llEventLoop-5-1<span style="color:#ff79c6">]</span> io.lettuce.core.protocol.CommandHandler  : <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">channel</span><span style="color:#ff79c6">=</span>0xaf43d87d, /127.0.0.1:41600 -&amp;gt; 127.0.0.1/127.0.0.1:6379, <span style="color:#8be9fd;font-style:italic">epid</span><span style="color:#ff79c6">=</span>0x1, <span style="color:#8be9fd;font-style:italic">chid</span><span style="color:#ff79c6">=</span>0x1<span style="color:#ff79c6">]</span> Stack contains: <span style="color:#bd93f9">1</span> commands
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>llEventLoop-5-1<span style="color:#ff79c6">]</span> i.l.core.protocol.RedisStateMachine      : Decode <span style="color:#ff79c6">done</span>, empty stack: <span style="color:#8be9fd;font-style:italic">true</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#bd93f9">19336</span> --- <span style="color:#ff79c6">[</span>llEventLoop-5-1<span style="color:#ff79c6">]</span> io.lettuce.core.protocol.CommandHandler  : <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">channel</span><span style="color:#ff79c6">=</span>0xaf43d87d, /127.0.0.1:41600 -&amp;gt; 127.0.0.1/127.0.0.1:6379, <span style="color:#8be9fd;font-style:italic">epid</span><span style="color:#ff79c6">=</span>0x1, <span style="color:#8be9fd;font-style:italic">chid</span><span style="color:#ff79c6">=</span>0x1<span style="color:#ff79c6">]</span> Completing <span style="color:#8be9fd;font-style:italic">command</span> SubscriptionCommand <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">type</span><span style="color:#ff79c6">=</span>GET, <span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>ValueOutput <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">output</span><span style="color:#ff79c6">=</span>something, <span style="color:#8be9fd;font-style:italic">error</span><span style="color:#ff79c6">=</span>&amp;<span style="color:#6272a4">#39;null&amp;#39;], commandType=io.lettuce.core.protocol.Command]</span>
</span></span></code></pre></div><p>Digging in there, you can see that when we hit the replica, we are connecting to the ip address <strong>172.22.0.3</strong> and when we hit the primary, we are connecting to <strong>127.0.0.1</strong> [the value in our config, loopback]. Which is the desired behavior.</p>
<h3 id="an-important-caveat-for-local">An Important Caveat for Local</h3>
<p>There's an important note for what follows here: because I'm running these tests on a computer running Linux, I can actually access the containers running by their bridge IP address. Therefore, if the IP address for a redis node inside the docker network is <strong>127.22.0.2</strong>, I can actually run this redis-cli command and it works:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ redis-cli -p <span style="color:#bd93f9">6379</span> -h 172.22.0.2 info
</span></span><span style="display:flex;"><span>...bunch of stuff...
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Replication</span>
</span></span><span style="display:flex;"><span>role:master
</span></span><span style="display:flex;"><span>connected_slaves:1
</span></span><span style="display:flex;"><span>slave0:ip<span style="color:#ff79c6">=</span>172.22.0.3,port<span style="color:#ff79c6">=</span>6379,state<span style="color:#ff79c6">=</span>online,offset<span style="color:#ff79c6">=</span>2828,lag<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p><strong>You can't do this on mac</strong> [or, I'm pretty sure, Windows].</p>
<p>Because lettuce is getting the replica IP address from the primary [by running INFO, as I did here], starting up this example on a non-Linux box won't &quot;just work&quot; as long as the application is running on your host machine, and not in the docker compose network. You will likely have to create a special configuration for local only to get around this issue for now, but this will work in a &quot;real&quot; environment or if you configure redis in a non-docker environment.</p>
<p>Do remember to <a href="https://github.com/nfisher23/reactive-programming-webflux">check out the sample code on Github</a>, which even if you're developing on a non Linux box should be a good place to start for higher environments</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/java/" alt="Java">
          Java
        </a>
      
        <a href="/tags/spring/" alt="Spring">
          Spring
        </a>
      
        <a href="/tags/reactive/" alt="Reactive">
          Reactive
        </a>
      
        <a href="/tags/webflux/" alt="Webflux">
          Webflux
        </a>
      
        <a href="/tags/lettuce/" alt="Lettuce">
          Lettuce
        </a>
      
        <a href="/tags/redis/" alt="Redis">
          Redis
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
