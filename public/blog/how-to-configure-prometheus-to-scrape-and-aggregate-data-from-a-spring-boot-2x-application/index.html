<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How to Configure Prometheus to Scrape and Aggregate Data From a Spring Boot 2.x Application</title>
<meta
  name="description"
  content="You can see the source code for this post on Github.
Following up on the last post [ How to Expose Meaningful Prometheus Metrics In a Spring Boot 2.x Application], if we have metrics exposed but they don&#39;t go anywhere, are there metrics exposed at all?"
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-configure-prometheus-to-scrape-and-aggregate-data-from-a-spring-boot-2x-application/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        Home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        Blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        About me
      </a>
    </li>
    
    <li>
      <a href="/categories" class="">
        Categories
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How to Configure Prometheus to Scrape and Aggregate Data From a Spring Boot 2.x Application</h2>

    <div class="meta">
      
      <time datetime="2020-05-30 20:33:50 &#43;0000 UTC" title='Sat, May 30, 2020, 8:33 PM UTC'>
        30/05/2020 - Estimated reading time: 4 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>You can see the source code for this post <a href="https://github.com/nfisher23/prometheus-metrics-ex">on Github</a>.</p>
<p>Following up on the last post [ <a href="https://nickolasfisher.com/blog/How-to-Expose-Meaningful-Prometheus-Metrics-In-a-Spring-Boot-2x-Application">How to Expose Meaningful Prometheus Metrics In a Spring Boot 2.x Application</a>], if we have metrics exposed but they don't go anywhere, are there metrics exposed at all?</p>
<p>Yes, there are metrics exposed, they're just not very useful. What we really want is to aggregate them and ship them to a data store so that we can view their evolution over time.</p>
<p>I'm going to use docker compose as a simple way to illustrate what you would need to do here. While you can run docker compose in a production environment, it has clearly lost (at this point - mid 2020) to kubernetes. I would recommend you either learn kubernetes or use virtual machines if you are planning on moving this to production.</p>
<h3 id="get-the-app-running">Get the app running</h3>
<p>We'll have to get the application running in our little docker compose network first. So we need to set up a <a href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a> and throw it in the root directory:</p>
<pre tabindex="0"><code>FROM maven

RUN mkdir -p /app

COPY ./ /app/

ENTRYPOINT cd /app &amp;amp;&amp;amp; mvn spring-boot:run
</code></pre><p>At this point, we can set up the <strong>docker-compose.yml</strong>, which will represent a production like environment on our local machine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">version</span>: <span style="color:#ff79c6">&amp;#39;3&amp;#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># `docker-compose build` to rebuild</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">app</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">context</span>: ../
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>      - /home/nick/.m2:/root/.m2
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">environment</span>:
</span></span><span style="display:flex;"><span>      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/local
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">depends_on</span>:
</span></span><span style="display:flex;"><span>      - db
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#bd93f9">9000</span>:<span style="color:#bd93f9">8080</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">db</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">image</span>: postgres
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#bd93f9">5432</span>:<span style="color:#bd93f9">5432</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">env_file</span>:
</span></span><span style="display:flex;"><span>      - database.env
</span></span></code></pre></div><p>We are leveraging the isolated network that docker compose creates for us in this process and we are also leveraging spring configuration override. <strong>SPRING_DATASOURCE_URL</strong> is the same as if we
would have specified a property in our <strong>application.yml</strong> that had something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">spring.datasource.url</span>: jdbc:postgresql://db:5432/local
</span></span></code></pre></div><p>When we tell spring boot to look up the datasource with the name <strong>db</strong>, we are deferring to that docker compose network, where <strong>db</strong> resolves to the ip address where the postgres container is set up. This will by default build the application as determined by the Dockerfile, then start it up. You should be able to run:</p>
<pre tabindex="0"><code>$ docker-compose up -d
$ curl localhost:9000/actuator/prometheus
</code></pre><p>And see some prometheus metrics output.</p>
<p>To wire up prometheus, we will want to <a href="https://hub.docker.com/r/prom/prometheus/">use a built in prometheus image</a> available on docker hub. We can add that to the <strong>services</strong> section in our docker compose file like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#ff79c6">prom</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">image</span>: prom/prometheus
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#bd93f9">9090</span>:<span style="color:#bd93f9">9090</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>      - ./prometheus.yml:/etc/prometheus/prometheus.yml
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">depends_on</span>:
</span></span><span style="display:flex;"><span>      - app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">graf</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">image</span>: grafana/grafana
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">privileged</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#bd93f9">3000</span>:<span style="color:#bd93f9">3000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">depends_on</span>:
</span></span><span style="display:flex;"><span>      - prom
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">./graf-data:/var/lib/grafana # note</span>: need `chmod 777 graf-data` to do this
</span></span></code></pre></div><p><a href="https://grafana.com/">Grafana</a> is an open source graphing solution, commonly used with prometheus. I've included it here because it makes it much easier to digest and analyze the data once it gets in there. It's also just very commonly used with prometheus.</p>
<p>You will also need to set up your <strong>prometheus.yml</strong> file to find and scrape your application:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">scrape_interval</span>:     15s <span style="color:#6272a4"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">evaluation_interval</span>: 15s <span style="color:#6272a4"># Evaluate rules every 15 seconds. The default is every 1 minute.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># scrape_timeout is set to the global default (10s).</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Load rules once and periodically evaluate them according to the global &amp;#39;evaluation_interval&amp;#39;.</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">rule_files</span>:
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># - &amp;#34;first_rules.yml&amp;#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># - &amp;#34;second_rules.yml&amp;#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># A scrape configuration containing exactly one endpoint to scrape:</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Here it&amp;#39;s Prometheus itself.</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4"># The job name is added as a label `job=` to any timeseries scraped from this config.</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">job_name</span>: <span style="color:#ff79c6">&amp;#39;prometheus&amp;#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># metrics_path defaults to &amp;#39;/metrics&amp;#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># scheme defaults to &amp;#39;http&amp;#39;.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">targets</span>: [<span style="color:#ff79c6">&amp;#39;127.0.0.1:9090&amp;#39;]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">job_name</span>: <span style="color:#ff79c6">&amp;#39;spring-actuator&amp;#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metrics_path</span>: <span style="color:#ff79c6">&amp;#39;/actuator/prometheus&amp;#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">scrape_interval</span>: 5s
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">targets</span>: [<span style="color:#ff79c6">&amp;#39;app:8080&amp;#39;]</span> <span style="color:#6272a4"># run ifconfig and get host ip</span>
</span></span></code></pre></div><p>The really important part of this config, once again leveraging the DNS in the docker compose file, is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  - <span style="color:#ff79c6">job_name</span>: <span style="color:#ff79c6">&amp;#39;spring-actuator&amp;#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">metrics_path</span>: <span style="color:#ff79c6">&amp;#39;/actuator/prometheus&amp;#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">scrape_interval</span>: 5s
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ff79c6">targets</span>: [<span style="color:#ff79c6">&amp;#39;app:8080&amp;#39;]</span> <span style="color:#6272a4"># run ifconfig and get host ip</span>
</span></span></code></pre></div><p>This tells prometheus to scrape our application every five seconds, and the URL to resolve to is our exposed <strong>/actuator/prometheus</strong>. To run the example <a href="https://github.com/nfisher23/prometheus-metrics-ex">provided in the source code</a>, you will have to first create and modify a file to have the right permissions, then you can start it up:</p>
<pre tabindex="0"><code>$ mkdir graf-data &amp;amp;&amp;amp; chmod 777 graf-data
$ docker-compose up -d
</code></pre><p>After everything downloads and comes up properly, you can get to grafana at port 3000 or prometheus on port 9090, and you should see the data flowing from our application to make it so.</p>
</section>

  
    
  

    
  


  <footer>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
