<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How to Create Multiple Digital Ocean Droplets and Provision Them Using Ansible</title>
<meta
  name="description"
  content="In a previous post, we saw how to create a digital ocean droplet and provision it with Ansible. Creating multiple droplets is very similar, you mostly just have to pay attention to the response object that you get back, which is different in the single vs. the many case."
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-create-multiple-digital-ocean-droplets-and-provision-them-using-ansible/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/img/nficon.png" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How to Create Multiple Digital Ocean Droplets and Provision Them Using Ansible</h2>

    <div class="meta">
      
      <time datetime="2019-06-16 17:14:49 &#43;0000 UTC" title='Sun, Jun 16, 2019, 5:14 PM UTC'>
        16/06/2019 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>In a previous post, we saw <a href="https://nickolasfisher.com/blog/How-To-Create-a-Digital-Ocean-Droplet-and-Provision-It-Using-Ansible">how to create a digital ocean droplet and provision it with Ansible</a>. Creating multiple droplets is very similar, you mostly just have to pay attention to the response object that you get back, which is different in the single vs. the many case.</p>
<h3 id="creating-multiple-droplets">Creating Multiple Droplets</h3>
<p>If you're using Ansible &lt; 2.8, to create multiple droplets you will first have to set your digital ocean api token as an environment variable:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">DO_API_TOKEN</span><span style="color:#ff79c6">=</span>1234YourTokenHere4321
</span></span></code></pre></div><p>We can then structure our droplet creation playbook like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff79c6">hosts</span>: localhost
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">connection</span>: local
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">gather_facts</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: create two droplets
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">digital_ocean</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">unique_name</span>: <span style="color:#ff79c6">yes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">region_id</span>: ams3
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">image_id</span>: ubuntu-18-10-x64
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">wait_timeout</span>: <span style="color:#bd93f9">100</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">wait</span>: <span style="color:#ff79c6">yes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">name</span>: <span style="color:#ff79c6">&amp;#34;{{</span> item }}&amp;#34;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">size_id</span>: s-1vcpu-1gb
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">state</span>: present
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">command</span>: droplet
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">ssh_key_ids</span>: [ <span style="color:#ff79c6">&amp;#39;&amp;#39;</span> ] <span style="color:#6272a4"># &amp;lt;---- put your numeric ssh key in here</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">register</span>: created_droplets
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">with_items</span>:
</span></span><span style="display:flex;"><span>        - tmp-droplet-1
</span></span><span style="display:flex;"><span>        - tmp-droplet-2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: add to dynamic inventory
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">add_host</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">name</span>: <span style="color:#ff79c6">&amp;#34;{{</span> item.droplet.ip_address }}&amp;#34;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">group</span>: do
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">with_items</span>: <span style="color:#ff79c6">&amp;#34;{{</span> created_droplets.results }}&amp;#34;
</span></span></code></pre></div><p>If you're using ansible 2.8 or greater, that playbook beginning can instead look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- <span style="color:#ff79c6">hosts</span>: localhost
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">connection</span>: local
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">gather_facts</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: create two droplets
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">digital_ocean_droplet</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">unique_name</span>: <span style="color:#ff79c6">yes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">region</span>: ams3
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">image</span>: ubuntu-18-10-x64
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">wait_timeout</span>: <span style="color:#bd93f9">100</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">name</span>: <span style="color:#ff79c6">&amp;#34;{{</span> item }}&amp;#34;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">size_id</span>: s-1vcpu-1gb
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">state</span>: present
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">ssh_keys</span>: [ <span style="color:#ff79c6">&amp;#39;&amp;#39;</span> ] <span style="color:#6272a4"># &amp;lt;---- put your numeric ssh key in here</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">register</span>: created_droplets
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">with_items</span>:
</span></span><span style="display:flex;"><span>        - tmp-droplet-1
</span></span><span style="display:flex;"><span>        - tmp-droplet-2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: add to dynamic inventory
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">add_host</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">name</span>: <span style="color:#ff79c6">&amp;#34;{{</span> item.data.ip_address }}&amp;#34;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">group</span>: do
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">with_items</span>: <span style="color:#ff79c6">&amp;#34;{{</span> created_droplets.results }}&amp;#34;
</span></span></code></pre></div><p>Before you run this, you'll want to make sure to include an <strong>ansible.cfg</strong> file that looks like this:</p>
<pre tabindex="0"><code>[defaults]
host_key_checking = False
</code></pre><p>This will not prompt you before connecting via SSH to your newly created droplets. In a development environment where servers are ephemeral, this is preferred, and can further aid automation so that new droplets can be created without human intervention.</p>
<p>To prove this out, as we did in the last post, we can provision each server with nginx and a custom index page.
Create an <strong>index.html.j2</strong> Jinja2 template in the same directory as your playbook and fill it with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&amp;lt;h1&amp;gt; On a digital ocean droplet now &amp;lt;/h1&amp;gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&amp;lt;p&amp;gt; The ip address where we&amp;#39;re at is: {{ ansible_default_ipv4.address }} &amp;lt;/p&amp;gt;
</span></span></code></pre></div><p>And round out the playbook with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff79c6">hosts</span>: do
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">remote_user</span>: root
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">gather_facts</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">vars</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">ansible_python_interpreter</span>: /usr/bin/python3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">tasks</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: wait for port 22 to become available
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">wait_for</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">host</span>: <span style="color:#ff79c6">&amp;#34;{{</span> inventory_hostname }}&amp;#34;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">22</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">delegate_to</span>: localhost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: Gather Facts
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">setup</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: install nginx
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">apt</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">name</span>: nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">name</span>: modify html file
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">src</span>: ./index.html.j2
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">dest</span>: /var/www/html/index.html
</span></span></code></pre></div><p>You should now be able to navigate to your IP addresses and see the home page with the IP address displayed. Go get 'em, tiger.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/ansible/" alt="Ansible">
          Ansible
        </a>
      
        <a href="/tags/devops/" alt="DevOps">
          DevOps
        </a>
      
        <a href="/tags/digital-ocean/" alt="Digital Ocean">
          Digital Ocean
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
