<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How to do Test Driven Development on Your Ansible Roles Using Molecule</title>
<meta
  name="description"
  content="You can see the sample code for this tutorial on GitHub.
﻿ Molecule is primarily a way to manage the testing of infrastructure automation code. At its core, it wraps around various providers like Vagrant, Docker, or VMWare, and provides relatively simple integration with testing providers, notably TestInfra. Molecule is a great tool, but in my opinion there are not enough resources, by way of examples, to provide an adequate getting started guide. This post is meant to help fill that void."
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-do-test-driven-development-on-your-ansible-roles-using-molecule/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/img/nficon.png" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How to do Test Driven Development on Your Ansible Roles Using Molecule</h2>

    <div class="meta">
      
      <time datetime="2019-03-03 20:18:22 &#43;0000 UTC" title='Sun, Mar 3, 2019, 8:18 PM UTC'>
        03/03/2019 - Estimated reading time: 6 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>You can see the sample code for this tutorial <a href="https://github.com/nfisher23/some-ansible-examples">on GitHub.</a></p>
<p>﻿ <a href="https://molecule.readthedocs.io/en/latest/">Molecule</a> is primarily a way to manage the testing of infrastructure automation code. At its core, it wraps around various providers like Vagrant, Docker, or VMWare, and provides relatively simple integration with testing providers, notably <a href="https://testinfra.readthedocs.io/en/latest/">TestInfra</a>. Molecule is a great tool, but in my opinion there are not enough resources, by way of examples, to provide an adequate getting started guide. This post is meant to help fill that void.</p>
<p>You will need molecule, vagrant, VirtualBox, and Ansible installed on your machine to participate in the following exercise.</p>
<h3 id="installing-java-11-using-ansible">Installing Java 11 Using Ansible</h3>
<p>In a previous post, I showed a way to <a href="https://nickolasfisher.com/blog/How-to-Provision-a-Server-with-Java-using-Ansible">install any version of Java using Ansible</a>. However, I think the end result of that was not very modular. For example, I hardcoded several paths to directories, as well as output files that would be downloaded. For that simple example, it would probably be easy enough for me to refactor it and verify by hand, i.e. by ssh-ing into the VM and then running the appropriate commands. But that is not scalable. For code to properly evolve as requirements change and are refined, and for bugs to be fettered out successfully, automated tests reduce errors and improve time to delivery. So I went looking for a solution to automate the testing of ansible roles, and I stumbled upon Molecule.</p>
<p>First, navigate to the directory you want your Ansible role to reside, and initialize an Ansible role with a Molecule wrapper:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule init role -d vagrant -r test-driven-development-with-molecule
</span></span></code></pre></div><p>As you can see, this example will use Vagrant as the provider. Molecule, as of this writing, defaults to Docker, which is a valid choice as well, however we'll focus on one thing at at time and work with a VM (even though it is slower) for now. The command above will simplify your life by providing boilerplate code that installs python on your target VM, which is required by Ansible. You <em>might</em> have to modify the created VM in the platforms section of your <strong>molecule/default/molecule.yml</strong> instance like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">platforms</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">name</span>: instance
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">box</span>: ubuntu/xenial64
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">memory</span>: <span style="color:#bd93f9">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">provider_raw_config_args</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">&amp;#34;customize</span> [<span style="color:#ff79c6">&amp;#39;modifyvm&amp;#39;,</span> :id, &amp;#39;--uartmode1&amp;#39;, &amp;#39;disconnected&amp;#39;]&amp;#34;
</span></span></code></pre></div><p>You will also want to update your <strong>molecule/default/playbook.yml</strong> to use <strong>:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">become</span>: <span style="color:#ff79c6">yes</span>
</span></span></code></pre></div><p>I want to <a href="https://jdk.java.net/11/">install the latest OpenJDK version 11 from the tarball</a> on the official JDK release page. What does a finished install look like for me? Well, I can think of basically three things that constitute a valid Java install:</p>
<ul>
<li>Java is available on my PATH and $ java -version outputs a valid java runtime.</li>
<li>Javac is available on the PATH and ﻿$ javac -version ﻿outputs a valid java compiler.</li>
<li>JAVA_HOME is set properly.</li>
</ul>
<p>To stick with test driven development, I'll write a test for the java runtime using test infra first. Paste this code into your <strong>molecule/default/tests/test_default.py</strong> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> testinfra.utils.ansible_runner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>testinfra_hosts <span style="color:#ff79c6">=</span> testinfra<span style="color:#ff79c6">.</span>utils<span style="color:#ff79c6">.</span>ansible_runner<span style="color:#ff79c6">.</span>AnsibleRunner(
</span></span><span style="display:flex;"><span>    os<span style="color:#ff79c6">.</span>environ[<span style="color:#ff79c6">&amp;</span><span style="color:#6272a4">#39;MOLECULE_INVENTORY_FILE&amp;#39;]).get_hosts(&amp;#39;all&amp;#39;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># validate java runtime</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_java_runtime</span>(host):
</span></span><span style="display:flex;"><span>    cmd <span style="color:#ff79c6">=</span> host<span style="color:#ff79c6">.</span>run(<span style="color:#ff79c6">&amp;</span><span style="color:#6272a4">#34;java -version&amp;#34;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">assert</span> cmd<span style="color:#ff79c6">.</span>rc <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">assert</span> cmd<span style="color:#ff79c6">.</span>stderr<span style="color:#ff79c6">.</span>find(<span style="color:#ff79c6">&amp;</span><span style="color:#6272a4">#34;11.0&amp;#34;)</span>
</span></span></code></pre></div><p>You can run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule create
</span></span></code></pre></div><p>To create the local Vagrant VM you're going to test with, and you can run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule converge
</span></span></code></pre></div><p>To run the Ansible playbook (which right now is empty) against your target machine. After running those two commands you can successfully run your test, created above, with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule verify
</span></span></code></pre></div><p>You should see the test fail, which is a good thing&ndash;that means you have a test that <em>means</em> something.</p>
<p>We can now insert some valid code to just barely pass the above test. Go to your <strong>tasks/main.yml</strong> file and add the following four tasks:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff79c6">name</span>: Get Java tarball
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">get_url</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">url</span>: https://download.java.net/java/GA/jdk11/9/GPL/openjdk-11.0.2_linux-x64_bin.tar.gz
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">dest</span>: /etc/open-jdk11.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff79c6">name</span>: make java 11 directory
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">file</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">path</span>: /usr/lib/java11
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">state</span>: directory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff79c6">name</span>: unpack tarball
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">unarchive</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">dest</span>: /usr/lib/java11
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">src</span>: /etc/open-jdk11.tar.gz
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">remote_src</span>: <span style="color:#ff79c6">yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff79c6">name</span>: update alternatives for java
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">alternatives</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">name</span>: java
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">path</span>: /usr/lib/java11/jdk-11.0.2/bin/java
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">link</span>: /usr/bin/java
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">priority</span>: <span style="color:#bd93f9">20000</span>
</span></span></code></pre></div><p>The above tasks:</p>
<ol>
<li>Downloads the OpenJDK 11.0.2 version tarball for Linux, and places the downloaded tar.gz. file under /etc/</li>
<li>Creates a directory to store the extracted java11 version</li>
<li>Unarchives (decompresses and unpacks) the tar.gz file into a directory</li>
<li>Uses the alternatives system to add java to a place that is already on our path, in this case /usr/bin</li>
</ol>
<p>You should be able to run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule converge &amp;amp;&amp;amp; molecule verify
</span></span></code></pre></div><p>And see our one test pass.</p>
<p>We can take a shortcut and create two tests for the next two requirements that successfully install Java on our target machine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_java_compiler</span>(host):
</span></span><span style="display:flex;"><span>    cmd <span style="color:#ff79c6">=</span> host<span style="color:#ff79c6">.</span>run(<span style="color:#ff79c6">&amp;</span><span style="color:#6272a4">#34;javac -version&amp;#34;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">assert</span> cmd<span style="color:#ff79c6">.</span>rc <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">assert</span> cmd<span style="color:#ff79c6">.</span>stderr<span style="color:#ff79c6">.</span>find(<span style="color:#ff79c6">&amp;</span><span style="color:#6272a4">#34;11.0&amp;#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">test_java_home_configured</span>(host):
</span></span><span style="display:flex;"><span>    f <span style="color:#ff79c6">=</span> host<span style="color:#ff79c6">.</span>file(<span style="color:#ff79c6">&amp;</span><span style="color:#6272a4">#34;/etc/environment&amp;#34;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">assert</span> f<span style="color:#ff79c6">.</span>contains(<span style="color:#ff79c6">&amp;</span><span style="color:#6272a4">#34;JAVA_HOME=/usr/lib/&amp;#34;)</span>
</span></span></code></pre></div><p>Here, I want to validate that the java compiler is on our PATH and that its version contains 11.0. I could have been more specific here, but I want the tests to be flexible enough to allow for changes and this was the compromise that I struck. In the second test, it's my goal to ensure that the <strong>/etc/environment</strong> file, which sets environment variables for every user on our system, has the JAVA_HOME variable defined&ndash;again, it's a tradeoff between being so specific that its not flexible to change and so vague that it's meaningless, so I stuck with saying that JAVA_HOME should start with /usr/lib.</p>
<p>We could also write a test that runs an ﻿$ echo $JAVA_HOME command and interprets the response, which is probably more robust in the long run.</p>
<p>You should then be able to run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule converge &amp;amp;&amp;amp; molecule verify
</span></span></code></pre></div><p>And see both tests failing. We can append the following two tasks to our <strong>tasks/main.yml</strong> file to make the tests pass:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff79c6">name</span>: update alternatives for javac
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">alternatives</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">name</span>: javac
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">path</span>: /usr/lib/java11/jdk-11.0.2/bin/javac
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">link</span>: /usr/bin/javac
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">priority</span>: <span style="color:#bd93f9">20000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#ff79c6">name</span>: set java home as environment variable
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">blockinfile</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">insertafter</span>: EOF
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">path</span>: /etc/environment
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">block</span>: export JAVA_HOME=/usr/lib/java11/jdk-11.0.2
</span></span></code></pre></div><p>Now, running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule converge &amp;amp;&amp;amp; molecule verify
</span></span></code></pre></div><p>Should have both tests pass.</p>
<p>Probably the most difficult part going forward will be understanding how to leverage test infra to write the appropriate tests. The best resource I've found is simply the listing of modules at <a href="https://testinfra.readthedocs.io/en/latest/modules.html,">https://testinfra.readthedocs.io/en/latest/modules.html</a>&ndash;from there I have just been tinkering with it to get used to how it all works.</p>
<p>A big reason that we write these tests is so that we can refactor our work. I would encourage you to take the code above and modularize it&ndash;e.g. change the download url, use a register to get the tar.gz location, and reuse anything that looks duplicated. Because this is focused on introducing molecule, I'll leave you here.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/vagrant/" alt="Vagrant">
          Vagrant
        </a>
      
        <a href="/tags/ansible/" alt="Ansible">
          Ansible
        </a>
      
        <a href="/tags/devops/" alt="DevOps">
          DevOps
        </a>
      
        <a href="/tags/molecule/" alt="Molecule">
          Molecule
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
