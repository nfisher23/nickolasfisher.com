<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How to do Test Driven Development on Your Ansible Roles Using Molecule</title>
<meta
  name="description"
  content="You can see the sample code for this tutorial on GitHub.
﻿ Molecule is primarily a way to manage the testing of infrastructure automation code. At its core, it wraps around various providers like Vagrant, Docker, or VMWare, and provides relatively simple integration with testing providers, notably TestInfra. Molecule is a great tool, but in my opinion there are not enough resources, by way of examples, to provide an adequate getting started guide. This post is meant to help fill that void."
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-do-test-driven-development-on-your-ansible-roles-using-molecule/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        Home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        Blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        About me
      </a>
    </li>
    
    <li>
      <a href="/categories" class="">
        Categories
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How to do Test Driven Development on Your Ansible Roles Using Molecule</h2>

    <div class="meta">
      
      <time datetime="2019-03-01 00:00:00 &#43;0000 UTC" title='Fri, Mar 1, 2019, 12:00 AM UTC'>
        01/03/2019 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>You can see the sample code for this tutorial <a href="https://github.com/nfisher23/some-ansible-examples">on GitHub.</a></p>
<p>﻿ <a href="https://molecule.readthedocs.io/en/latest/">Molecule</a> is primarily a way to manage the testing of infrastructure automation code. At its core, it wraps around various providers like Vagrant, Docker, or VMWare, and provides relatively simple integration with testing providers, notably <a href="https://testinfra.readthedocs.io/en/latest/">TestInfra</a>. Molecule is a great tool, but in my opinion there are not enough resources, by way of examples, to provide an adequate getting started guide. This post is meant to help fill that void.</p>
<p>You will need molecule, vagrant, VirtualBox, and Ansible installed on your machine to participate in the following exercise.</p>
<h3 id="installing-java-11-using-ansible">Installing Java 11 Using Ansible</h3>
<p>In a previous post, I showed a way to <a href="https://nickolasfisher.com/blog/How-to-Provision-a-Server-with-Java-using-Ansible">install any version of Java using Ansible</a>. However, I think the end result of that was not very modular. For example, I hardcoded several paths to directories, as well as output files that would be downloaded. For that simple example, it would probably be easy enough for me to refactor it and verify by hand, i.e. by ssh-ing into the VM and then running the appropriate commands. But that is not scalable. For code to properly evolve as requirements change and are refined, and for bugs to be fettered out successfully, automated tests reduce errors and improve time to delivery. So I went looking for a solution to automate the testing of ansible roles, and I stumbled upon Molecule.</p>
<p>First, navigate to the directory you want your Ansible role to reside, and initialize an Ansible role with a Molecule wrapper:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule init role -d vagrant -r test-driven-development-with-molecule
</span></span></code></pre></div><p>As you can see, this example will use Vagrant as the provider. Molecule, as of this writing, defaults to Docker, which is a valid choice as well, however we'll focus on one thing at at time and work with a VM (even though it is slower) for now. The command above will simplify your life by providing boilerplate code that installs python on your target VM, which is required by Ansible. You <em>might</em> have to modify the created VM in the platforms section of your <strong>molecule/default/molecule.yml</strong> instance like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">platforms</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ff79c6">name</span>: instance
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">box</span>: ubuntu/xenial64
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">memory</span>: <span style="color:#bd93f9">2048</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">provider_raw_config_args</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ff79c6">&amp;#34;customize</span> [<span style="color:#ff79c6">&amp;#39;modifyvm&amp;#39;,</span> :id, &amp;#39;--uartmode1&amp;#39;, &amp;#39;disconnected&amp;#39;]&amp;#34;
</span></span></code></pre></div><p>You will also want to update your <strong>molecule/default/playbook.yml</strong> to use <strong>:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">become</span>: <span style="color:#ff79c6">yes</span>
</span></span></code></pre></div><p>I want to <a href="https://jdk.java.net/11/">install the latest OpenJDK version 11 from the tarball</a> on the official JDK release page. What does a finished install look like for me? Well, I can think of basically three things that constitute a valid Java install:</p>
<ul>
<li>Java is available on my PATH and $ java -version outputs a valid java runtime.</li>
<li>Javac is available on the PATH and ﻿$ javac -version ﻿outputs a valid java compiler.</li>
<li>JAVA_HOME is set properly.</li>
</ul>
<p>To stick with test driven development, I'll write a test for the java runtime using test infra first. Paste this code into your <strong>molecule/default/tests/test_default.py</strong> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> testinfra.utils.ansible_runner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>testinfra_hosts <span style="color:#ff79c6">=</span> testinfra<span style="color:#ff79c6">.</span>utils<span style="color:#ff79c6">.</span>ansible_runner<span style="color:#ff79c6">.</span>AnsibleRunner(
</span></span><span style="display:flex;"><span>    os<span style="color:#ff79c6">.</span>environ[<span style="color:#ff79c6">&amp;</span><span style="color:#6272a4">#39;MOLECULE_INVENTORY_FILE&amp;#39;]).get_hosts(&amp;#39;all&amp;#39;)</span>
</span></span></code></pre></div></section>

  
    
  

    
  


  <footer>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
