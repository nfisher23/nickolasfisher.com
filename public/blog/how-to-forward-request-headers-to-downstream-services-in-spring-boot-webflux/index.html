<!doctype html><html lang=en-US class="scroll-smooth dark"><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>How to Forward Request Headers to Downstream Services in Spring Boot Webflux</title>
<meta name=description content="The source code for this post can be found on Github.
When you make the switch to a reactive codebase, ThreadLocal becomes effectively off limits to you, because you aren&rsquo;t guaranteed that the thread that starts the request processing remains the same, even if it&rsquo;s the same HTTP request. This has caused pain in many places: the original implementation of spring security, for example, relied very heavily on ThreadLocal variables to store state that happened in the start of the request, and then reuse the information stored in those variables later on to make access control decisions. Neflix spoke of their pain migrating to a reactive stack, when they had relied so heavily on ThreadLocal variables in most of their shared libraries."><link rel=canonical href=https://www.nickolasfisher.com/blog/how-to-forward-request-headers-to-downstream-services-in-spring-boot-webflux/><link rel=robots href=/robots.txt><link rel=icon type=image/x-icon href=/img/nficon.png><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><link rel=stylesheet href="https://www.nickolasfisher.com/css/app.min.dee9c4afb37cb95c5d39c976614ef6f95398bcba4b6e73066c44de2a3a6543ed.css"></head><body class="max-w-screen-md mx-auto px-2.5"><div class=header><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12"><div class="flex-none w-20 h-20 rounded-full overflow-hidden"><a href=https://www.nickolasfisher.com/><img srcset="/img/profile-picture_hu4241499301404582006.jpg 80w" src=/img/profile-picture.jpg width=386 height=345 alt="Nick Fisher's tech blog"></a></div><div class="flex flex-col gap-5"><a href=https://www.nickolasfisher.com/><h1 id=site-title>Nick Fisher's tech blog</h1></a><nav><ul><li><a href=/>home</a></li><li><a href=/blog>blog</a></li><li><a href=/about>about</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></header><button class=toggle-theme aria-label="Toggle Theme" title="Toggle Theme" onclick=toggleTheme()>
<span class="theme-icon light"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75.0 11-7.5.0 3.75 3.75.0 017.5.0z"/></svg> </span><span class="theme-icon dark"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718.0 0118 15.75c-5.385.0-9.75-4.365-9.75-9.75.0-1.33.266-2.597.748-3.752A9.753 9.753.0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753.0 009.002-5.998z"/></svg> </span></button>
<script>document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("theme");setTheme(!e||e==="light"?"light":e)});function setTheme(e){const t=document.querySelector("html");localStorage.setItem("theme",e),e==="light"?(t.classList.contains("dark")&&document.querySelector("html").classList.remove("dark"),document.querySelector(".theme-icon.light").style.display="none",document.querySelector(".theme-icon.dark").style.display="block"):(t.classList.contains("dark")||document.querySelector("html").classList.add("dark"),document.querySelector(".theme-icon.dark").style.display="none",document.querySelector(".theme-icon.light").style.display="block")}function toggleTheme(){const e=localStorage.getItem("theme");setTheme(e==="light"?"dark":"light")}</script></div><main id=content><article class="flex flex-col gap-10"><header class="flex flex-col gap-2"><h2 class=title-large>How to Forward Request Headers to Downstream Services in Spring Boot Webflux</h2><div class=meta><time datetime="2020-07-19 19:39:10 +0000 UTC" title='Sun, Jul 19, 2020, 7:39 PM UTC'>19/07/2020 - Estimated reading time: 5 minutes</time></div></header><section><p>The source code for this post <a href=https://github.com/nfisher23/reactive-programming-webflux/tree/master/context-api>can be found on Github</a>.</p><p>When you make the switch to a reactive codebase, <a href=https://docs.oracle.com/javase/7/docs/api/java/lang/ThreadLocal.html>ThreadLocal</a> becomes effectively off limits to you, because you aren&rsquo;t guaranteed that the thread that starts the request processing remains the same, even if it&rsquo;s the same HTTP request. This has caused pain in many places: the original implementation of spring security, for example, relied very heavily on ThreadLocal variables to store state that happened in the start of the request, and then reuse the information stored in those variables later on to make access control decisions. <a href=https://netflixtechblog.com/zuul-2-the-netflix-journey-to-asynchronous-non-blocking-systems-45947377fb5c>Neflix spoke of their pain migrating to a reactive stack</a>, when they had relied so heavily on ThreadLocal variables in most of their shared libraries.</p><p>If you need to store state through the lifecycle of a request in a reactive stack, we have to go a little bit of a different way. Thankfully, in the case of project reactor, they have come up with a nifty abstraction that is very similar to ThreadLocal: <a href=https://projectreactor.io/docs/core/release/reference/#context>Context</a>. I elected to use Context to automatically forward a known request header downstream, which is very commonly needed in a microservices architecture, for example passing around an authentication token or tracking a user span.</p><h2 id=simple-echo-server>Simple Echo Server</h2><p>To make things a little easier for me, I borrowed <a href=https://gist.github.com/huyng/814831>a really simple python server that just prints out the request and the response</a>. Note that I had to modify it slightly in order to get webflux to play nice with it and I also changed the port, the full code is here:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#6272a4>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Reflects the requests from HTTP methods GET, POST, PUT, and DELETE</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Written by Nathan Hamiel (2010)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> BaseHTTPServer <span style=color:#ff79c6>import</span> HTTPServer, BaseHTTPRequestHandler
</span></span><span style=display:flex><span><span style=color:#ff79c6>from</span> optparse <span style=color:#ff79c6>import</span> OptionParser
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>RequestHandler</span>(BaseHTTPRequestHandler):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>do_GET</span>(self):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        request_path <span style=color:#ff79c6>=</span> self<span style=color:#ff79c6>.</span>path
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>----- Request Start -----&gt;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>print</span>(request_path)
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>print</span>(self<span style=color:#ff79c6>.</span>headers)
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;&lt;----- Request End -----</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff79c6>.</span>send_response(<span style=color:#bd93f9>200</span>)
</span></span><span style=display:flex><span>        self<span style=color:#ff79c6>.</span>send_header(<span style=color:#f1fa8c>&#34;Set-Cookie&#34;</span>, <span style=color:#f1fa8c>&#34;foo=bar&#34;</span>)
</span></span><span style=display:flex><span>        self<span style=color:#ff79c6>.</span>end_headers()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>do_POST</span>(self):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        request_path <span style=color:#ff79c6>=</span> self<span style=color:#ff79c6>.</span>path
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>----- Request Start -----&gt;</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>print</span>(request_path)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        request_headers <span style=color:#ff79c6>=</span> self<span style=color:#ff79c6>.</span>headers
</span></span><span style=display:flex><span>        content_length <span style=color:#ff79c6>=</span> request_headers<span style=color:#ff79c6>.</span>getheaders(<span style=color:#f1fa8c>&#39;content-length&#39;</span>)
</span></span><span style=display:flex><span>        length <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>int</span>(content_length[<span style=color:#bd93f9>0</span>]) <span style=color:#ff79c6>if</span> content_length <span style=color:#ff79c6>else</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>print</span>(request_headers)
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>print</span>(self<span style=color:#ff79c6>.</span>rfile<span style=color:#ff79c6>.</span>read(length))
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#34;&lt;----- Request End -----</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        self<span style=color:#ff79c6>.</span>send_response(<span style=color:#bd93f9>200</span>)
</span></span><span style=display:flex><span>        self<span style=color:#ff79c6>.</span>end_headers()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    do_PUT <span style=color:#ff79c6>=</span> do_POST
</span></span><span style=display:flex><span>    do_DELETE <span style=color:#ff79c6>=</span> do_GET
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>main</span>():
</span></span><span style=display:flex><span>    port <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>9000</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>print</span>(<span style=color:#f1fa8c>&#39;Listening on localhost:</span><span style=color:#f1fa8c>%s</span><span style=color:#f1fa8c>&#39;</span> <span style=color:#ff79c6>%</span> port)
</span></span><span style=display:flex><span>    server <span style=color:#ff79c6>=</span> HTTPServer((<span style=color:#f1fa8c>&#39;&#39;</span>, port), RequestHandler)
</span></span><span style=display:flex><span>    server<span style=color:#ff79c6>.</span>serve_forever()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> __name__ <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    parser <span style=color:#ff79c6>=</span> OptionParser()
</span></span><span style=display:flex><span>    parser<span style=color:#ff79c6>.</span>usage <span style=color:#ff79c6>=</span> (<span style=color:#f1fa8c>&#34;Creates an http-server that will echo out any GET or POST parameters</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f1fa8c>&#34;Run:</span><span style=color:#f1fa8c>\n\n</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f1fa8c>&#34;   reflect&#34;</span>)
</span></span><span style=display:flex><span>    (options, args) <span style=color:#ff79c6>=</span> parser<span style=color:#ff79c6>.</span>parse_args()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    main()
</span></span></code></pre></div><p>You will want to open up a terminal and start this up while we get the spring boot code working:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python2 reflect.py
</span></span></code></pre></div><h2 id=the-spring-boot-app>The Spring Boot App</h2><p>To get this thing working in spring boot, we will need two different types of filters: A <a href=https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-client-filter>WebClient filter</a> and a <a href=https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-filters>spring boot webflux filter</a>, which you can consider very similar to a servlet filter (but obviously it is reactive). First, let&rsquo;s configure the WebFlux filter:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Component
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>WebContextFilter</span> <span style=color:#8be9fd;font-style:italic>implements</span> WebFilter {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> String X_CUSTOM_HEADER <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;X-Custom-Header&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Mono<span style=color:#ff79c6>&lt;</span>Void<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>filter</span>(ServerWebExchange serverWebExchange, WebFilterChain webFilterChain) {
</span></span><span style=display:flex><span>        List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> customHeaderValues <span style=color:#ff79c6>=</span> serverWebExchange.<span style=color:#50fa7b>getRequest</span>().<span style=color:#50fa7b>getHeaders</span>().<span style=color:#50fa7b>get</span>(X_CUSTOM_HEADER);
</span></span><span style=display:flex><span>        String singleCustomHeader <span style=color:#ff79c6>=</span> customHeaderValues <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;</span>amp;<span style=color:#ff79c6>&amp;</span>amp; customHeaderValues.<span style=color:#50fa7b>size</span>() <span style=color:#ff79c6>==</span> 1 <span style=color:#ff79c6>?</span> customHeaderValues.<span style=color:#50fa7b>get</span>(0) : <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>        serverWebExchange.<span style=color:#50fa7b>getResponse</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> webFilterChain.<span style=color:#50fa7b>filter</span>(serverWebExchange).<span style=color:#50fa7b>subscriberContext</span>(context <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> singleCustomHeader <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> context.<span style=color:#50fa7b>put</span>(X_CUSTOM_HEADER, <span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>[]</span> {singleCustomHeader}) : context;
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Forgive me for the excessive ternary operators. This piece of code, in a bit of a not obvious way, sets the subscriber context for everything <em>that comes before it</em> in the chain. Though not super easy to understand, this is roughly the same thing as setting a ThreadLocal value just before the filter and clearing it just after the filter.</p><p>We can now introduce a WebClient filter to take advantage of this Context object:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Configuration
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>WebClientConfig</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Bean
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> WebClient <span style=color:#50fa7b>webClient</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> WebClient.<span style=color:#50fa7b>builder</span>()
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>filter</span>(<span style=color:#ff79c6>new</span> ExchangeFilterFunction() {
</span></span><span style=display:flex><span>                    @Override
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>public</span> Mono<span style=color:#ff79c6>&lt;</span>ClientResponse<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>filter</span>(ClientRequest clientRequest, ExchangeFunction exchangeFunction) {
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>return</span> Mono.<span style=color:#50fa7b>subscriberContext</span>()
</span></span><span style=display:flex><span>                                .<span style=color:#50fa7b>flatMap</span>(context <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>                                    String<span style=color:#ff79c6>[]</span> customHeader <span style=color:#ff79c6>=</span> context.<span style=color:#50fa7b>get</span>(X_CUSTOM_HEADER);
</span></span><span style=display:flex><span>                                    ClientRequest clientReq <span style=color:#ff79c6>=</span> ClientRequest.<span style=color:#50fa7b>from</span>(clientRequest)
</span></span><span style=display:flex><span>                                            .<span style=color:#50fa7b>header</span>(X_CUSTOM_HEADER, customHeader)
</span></span><span style=display:flex><span>                                            .<span style=color:#50fa7b>build</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                                    <span style=color:#ff79c6>return</span> exchangeFunction.<span style=color:#50fa7b>exchange</span>(clientReq);
</span></span><span style=display:flex><span>                                });
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                })
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>baseUrl</span>(<span style=color:#f1fa8c>&#34;http://localhost:9000&#34;</span>)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here, we are assuming that there is one service downstream we need to talk to, and for the purposes of this tutorial I&rsquo;ve just hardcoded the location of this service to <strong>http://localhost:9000</strong>. As you can see, we&rsquo;re grabbing the subscriber context and pulling out our custom header, then cloning the <strong>ClientRequest</strong> and adding it to the request.</p><p>Finally, we can expose a hello-world like endpoint that will actually use this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@RestController
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>HelloController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>final</span> WebClient webClient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>HelloController</span>(WebClient webClient) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>webClient</span> <span style=color:#ff79c6>=</span> webClient;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @GetMapping(<span style=color:#f1fa8c>&#34;/hello&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Mono<span style=color:#ff79c6>&lt;</span>ResponseEntity<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;&gt;</span> <span style=color:#50fa7b>hello</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> Mono.<span style=color:#50fa7b>subscriberContext</span>()
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>flatMap</span>(context <span style=color:#ff79c6>-&gt;</span> webClient.<span style=color:#50fa7b>get</span>()
</span></span><span style=display:flex><span>                        .<span style=color:#50fa7b>uri</span>(<span style=color:#f1fa8c>&#34;/test&#34;</span>)
</span></span><span style=display:flex><span>                        .<span style=color:#50fa7b>exchange</span>()
</span></span><span style=display:flex><span>                        .<span style=color:#50fa7b>map</span>(clientResponse <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>                            String<span style=color:#ff79c6>[]</span> strings <span style=color:#ff79c6>=</span> context.<span style=color:#50fa7b>get</span>(X_CUSTOM_HEADER);
</span></span><span style=display:flex><span>                            <span style=color:#ff79c6>return</span> ResponseEntity.<span style=color:#50fa7b>status</span>(200)
</span></span><span style=display:flex><span>                                    .<span style=color:#50fa7b>header</span>(X_CUSTOM_HEADER, strings)
</span></span><span style=display:flex><span>                                    .<span style=color:#50fa7b>build</span>();
</span></span><span style=display:flex><span>                        }));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Also pretty straightforward, all this endpoint does is hit our downstream service, then responds with a 200 status code. For fun, I&rsquo;ve also echoed back the custom header that we&rsquo;re sending along.</p><p>If you start up this application and have the python echo server running above, you should be able to use a curl like this and see a similar output</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -v -H <span style=color:#f1fa8c>&#34;X-Custom-Header: definitely-my-own-header&#34;</span> localhost:8080/hello
</span></span><span style=display:flex><span>*   Trying 127.0.0.1...
</span></span><span style=display:flex><span>* TCP_NODELAY <span style=color:#8be9fd;font-style:italic>set</span>
</span></span><span style=display:flex><span>* Connected to localhost <span style=color:#ff79c6>(</span>127.0.0.1<span style=color:#ff79c6>)</span> port <span style=color:#bd93f9>8080</span> <span style=color:#ff79c6>(</span><span style=color:#6272a4>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /hello HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: localhost:8080
</span></span><span style=display:flex><span>&gt; User-Agent: curl/7.58.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt; X-Custom-Header: definitely-my-own-header
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#bd93f9>200</span> OK
</span></span><span style=display:flex><span>&lt; X-Custom-Header: definitely-my-own-header
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span>* Connection <span style=color:#6272a4>#0 to host localhost left intact</span>
</span></span></code></pre></div><p>You should be able to see the custom header in the response above, and we can go check our downstream server for it as well:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>----- Request Start -----&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/test
</span></span><span style=display:flex><span>accept-encoding: gzip
</span></span><span style=display:flex><span>user-agent: ReactorNetty/0.9.10.RELEASE
</span></span><span style=display:flex><span>host: localhost:9000
</span></span><span style=display:flex><span>accept: */*
</span></span><span style=display:flex><span>X-Custom-Header: definitely-my-own-header
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;----- Request End -----
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>127.0.0.1 - - <span style=color:#ff79c6>[</span>26/Jul/2020 15:21:33<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;GET /test HTTP/1.1&#34;</span> <span style=color:#bd93f9>200</span> -
</span></span></code></pre></div><p>Feel free to <a href=https://github.com/nfisher23/reactive-programming-webflux/tree/master/context-api>check out the source code</a> for this one as well.</p></section><footer><div class="pb-14 taxonomy-list tags-list"><a href=/tags/java/ alt=Java>Java
</a><a href=/tags/spring/ alt=Spring>Spring
</a><a href=/tags/reactive/ alt=Reactive>Reactive
</a><a href=/tags/webflux/ alt=Webflux>Webflux</a></div></footer></article></main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2"><div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">© 2018-2025 —
<a href=https://www.nickolasfisher.com/>Nick Fisher's tech blog</a></div><div class="order-1 sm:order-2"><ul class="flex sm:justify-end gap-5"><li><a href=https://www.linkedin.com/in/nick-fisher-software/ target=_blank rel="noopener noreferrer">LinkedIn</a></li><li><a href=https://github.com/nfisher23 target=_blank rel="noopener noreferrer">GitHub</a></li></ul></div></footer></body></html>