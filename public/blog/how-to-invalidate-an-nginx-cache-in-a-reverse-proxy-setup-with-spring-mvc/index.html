<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How To Invalidate an Nginx Cache In a Reverse Proxy Setup With Spring MVC</title>
<meta
  name="description"
  content="You can see the sample code associated with this post on Github.
In two previous posts, we looked at how to provision a reverse proxy using nginx and then how to add caching to the nginx reverse proxy. The implementation we ended up with at the end of the last post was a &quot;dumb&quot; cache, meaning that it doesn&#39;t know when or if any data gets updated&ndash;it just times out after 60 seconds and then asks for a new payload from the application it&#39;s acting as proxy for."
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-invalidate-an-nginx-cache-in-a-reverse-proxy-setup-with-spring-mvc/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/img/nficon.png" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How To Invalidate an Nginx Cache In a Reverse Proxy Setup With Spring MVC</h2>

    <div class="meta">
      
      <time datetime="2019-04-13 16:52:53 &#43;0000 UTC" title='Sat, Apr 13, 2019, 4:52 PM UTC'>
        13/04/2019 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>You can see the sample code associated with this post <a href="https://github.com/nfisher23/some-ansible-examples/tree/master/reverse-proxy-nginx">on Github</a>.</p>
<p>In two previous posts, we looked at how to <a href="https://nickolasfisher.com/blog/How-to-Deploy-a-Spring-MVC-Application-Behind-an-Nginx-Reverse-Proxy">provision a reverse proxy using nginx</a> and then <a href="https://nickolasfisher.com/blog/How-to-Use-Nginxs-Caching-to-Improve-Site-Responsiveness">how to add caching to the nginx reverse proxy</a>. The implementation we ended up with at the end of the last post was a &quot;dumb&quot; cache, meaning that it doesn't know when or if any data gets updated&ndash;it just times out after 60 seconds and then asks for a new payload from the application it's acting as proxy for.</p>
<p>In this post, I'll demonstrate a simple way to invalidate the cache under predefined conditions using Spring Boot. This will allow us to programmatically and selectively notify Nginx to request a new payload. This way, users will get a fast page-load time combined with up-to-date information, depending on the use case.</p>
<p>The first thing we will do is create a simple one-line bash script that &quot;invalidates&quot; the cache. For Nginx, that can simply mean removing the cache contents. In our Nginx ansible role, I'm adding a Jinja2 template in <strong>templates/invalidate_cache.sh.j2</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>rm -rf <span style="color:#ff79c6">{{</span> nginx_cache_path <span style="color:#ff79c6">}}</span>/*
</span></span></code></pre></div><p>This uses our ansible variable to recursively remove all of the contents of the nginx cache. We will also add this script to our path so any application can easily use it. Add this to our <strong>nginx</strong> role:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff79c6">name</span>: add invalidate cache script to path
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">src</span>: invalidate_cache.sh.j2
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">dest</span>: <span style="color:#ff79c6">&amp;#34;/usr/bin/{{</span> nginx_cache_invalidate_script_name }}&amp;#34;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">mode</span>: <span style="color:#bd93f9">0755</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">become</span>: <span style="color:#ff79c6">yes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">notify</span>: restart nginx
</span></span></code></pre></div><p>This also uses a variable, which we will have to add to <strong>vars/main.yml</strong> in our nginx role:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">nginx_cache_invalidate_script_name</span>: invalidate_nginx_cache
</span></span></code></pre></div><p>Now this is available for our sample application to use. In the code itself, I have elected to leverage <a href="https://docs.spring.io/spring/docs/2.5.x/reference/aop.html">Spring's Aspect Oriented Programming</a> to abstract over the cache invalidation process. We will first have to add the AOP dependency to our <strong>pom.xml</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>&amp;lt;dependency&amp;gt;
</span></span><span style="display:flex;"><span>    &amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;
</span></span><span style="display:flex;"><span>    &amp;lt;artifactId&amp;gt;spring-boot-starter-aop&amp;lt;/artifactId&amp;gt;
</span></span><span style="display:flex;"><span>    &amp;lt;version&amp;gt;2.1.3.RELEASE&amp;lt;/version&amp;gt;
</span></span><span style="display:flex;"><span>&amp;lt;/dependency&amp;gt;
</span></span></code></pre></div><p>Then, we will create an interface to decorate any method that we want to invalidate the cache <strong>(InvalidateNginxCache.java)</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.nickolasfisher.simplemvc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> @interface InvalidateNginxCache { }
</span></span></code></pre></div><p>To actually invalidate the cache, we will define our pointcut and use ProcessBuilder to execute our invalidate_nginx_cache script, which is assumed to be on the system path:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.nickolasfisher.simplemvc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.aspectj.lang.annotation.After;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.aspectj.lang.annotation.Around;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.aspectj.lang.annotation.Aspect;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.stereotype.Component;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Map;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Aspect
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">AutoCacheInvalidator</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @After(<span style="color:#ff79c6">&amp;</span>#34;execution(<span style="color:#ff79c6">*</span> <span style="color:#ff79c6">*</span>(..)) <span style="color:#ff79c6">&amp;</span>amp;<span style="color:#ff79c6">&amp;</span>amp; @annotation(InvalidateNginxCache)<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">invalidateTheCache</span>() {
</span></span><span style="display:flex;"><span>        ProcessBuilder pb <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ProcessBuilder(<span style="color:#ff79c6">&amp;</span>#34;invalidate_nginx_cache<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>            pb.<span style="color:#50fa7b">start</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#ff79c6">catch</span> (Exception ignored) {
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4">// feel free to handle this differently</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> RuntimeException(<span style="color:#ff79c6">&amp;</span>#34;Houston, <span style="color:#ff79c6">this</span> didn<span style="color:#ff79c6">&amp;</span>#39;t<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can then use this anywhere a method gets executed&ndash;after the method completes, this code will run and invalidate the cache. I've elected to demonstrate this in our <strong>SimpleController.java</strong> class:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.nickolasfisher.simplemvc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>... imports ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Controller
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">SimpleController</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> String hotValue <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>#34;starter<span style="color:#ff79c6">&amp;</span>#34;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">/</span>slow<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> ResponseEntity<span style="color:#ff79c6">&amp;</span>lt;String<span style="color:#ff79c6">&amp;</span>gt; slowEndpoint() <span style="color:#8be9fd;font-style:italic">throws</span> InterruptedException {
</span></span><span style="display:flex;"><span>        Thread.<span style="color:#50fa7b">sleep</span>(2500);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> ResponseEntity<span style="color:#ff79c6">&amp;</span>lt;<span style="color:#ff79c6">&amp;</span>gt;(<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">&amp;</span>lt;p<span style="color:#ff79c6">&amp;</span>gt;Takes a <span style="color:#ff79c6">while</span> to get: <span style="color:#ff79c6">&amp;</span>#34; <span style="color:#ff79c6">&amp;</span>#43; hotValue <span style="color:#ff79c6">&amp;</span>#43; <span style="color:#ff79c6">&amp;</span>#34; <span style="color:#ff79c6">&amp;</span>lt;<span style="color:#ff79c6">/</span>p<span style="color:#ff79c6">&amp;</span>gt;<span style="color:#ff79c6">&amp;</span>#34;, HttpStatus.<span style="color:#50fa7b">ACCEPTED</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @PostMapping(<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">/</span>api<span style="color:#ff79c6">/</span>hotValue<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>    @InvalidateNginxCache
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> RedirectView <span style="color:#50fa7b">updateHotValue</span>(@RequestBody JsonNode body) {
</span></span><span style="display:flex;"><span>        hotValue <span style="color:#ff79c6">=</span> body.<span style="color:#50fa7b">get</span>(<span style="color:#ff79c6">&amp;</span>#34;hotValue<span style="color:#ff79c6">&amp;</span>#34;).<span style="color:#50fa7b">textValue</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> RedirectView(<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">/</span>slow<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">/&amp;</span>#34;)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> ResponseEntity<span style="color:#ff79c6">&amp;</span>lt;String<span style="color:#ff79c6">&amp;</span>gt; simpleResponder() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> ResponseEntity<span style="color:#ff79c6">&amp;</span>lt;<span style="color:#ff79c6">&amp;</span>gt;(<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">&amp;</span>lt;h1<span style="color:#ff79c6">&amp;</span>gt;Welcome to my site<span style="color:#ff79c6">!&amp;</span>lt;<span style="color:#ff79c6">/</span>h1<span style="color:#ff79c6">&amp;</span>gt;<span style="color:#ff79c6">&amp;</span>#34;, HttpStatus.<span style="color:#50fa7b">ACCEPTED</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Getting the source code and running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule create &amp;amp;&amp;amp; molecule converge
</span></span></code></pre></div><p>Will then allow you to hit the <a href="http://192.168.56.202/slow">http://192.168.56.202/slow</a> endpoint. It will cache after the first request like before. If you then hit the api endpoint:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -XPOST http://192.168.56.202/api/hotValue -H &amp;<span style="color:#6272a4">#34;Content-Type: application/json&amp;#34; --data &amp;#39;{&amp;#34;hotValue&amp;#34;:&amp;#34;some new value&amp;#34;}&amp;#39;</span>
</span></span></code></pre></div><p>Then, regardless of how long the cache would have remained active, you will see the new value updated.</p>
<p><strong>Note</strong>: This did not work on Ubuntu 16. I had to upgrade the VM to Ubuntu 18. I did not investigate why, but it had something to do with the way nginx was trying to create new directories once they were invalidated.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/java/" alt="Java">
          Java
        </a>
      
        <a href="/tags/ngnix/" alt="Ngnix">
          Ngnix
        </a>
      
        <a href="/tags/aspect-oriented-programming/" alt="Aspect Oriented Programming">
          Aspect Oriented Programming
        </a>
      
        <a href="/tags/ansible/" alt="Ansible">
          Ansible
        </a>
      
        <a href="/tags/spring/" alt="Spring">
          Spring
        </a>
      
        <a href="/tags/devops/" alt="DevOps">
          DevOps
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
