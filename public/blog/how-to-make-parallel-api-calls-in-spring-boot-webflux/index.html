<!doctype html><html lang=en-US class="scroll-smooth dark"><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>How to Make Parallel API calls in Spring Boot Webflux</title>
<meta name=description content="The source code for this post can be found on Github.
Following up on the last post, which was making sequential calls to downstream services, sometimes you are in a position where you can make calls in parallel and merge the results. In this case, we want to use zip."><link rel=canonical href=https://www.nickolasfisher.com/blog/how-to-make-parallel-api-calls-in-spring-boot-webflux/><link rel=robots href=/robots.txt><link rel=icon type=image/x-icon href=/img/nficon.png><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><link rel=stylesheet href="https://www.nickolasfisher.com/css/app.min.dee9c4afb37cb95c5d39c976614ef6f95398bcba4b6e73066c44de2a3a6543ed.css"></head><body class="max-w-screen-md mx-auto px-2.5"><div class=header><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12"><div class="flex-none w-20 h-20 rounded-full overflow-hidden"><a href=https://www.nickolasfisher.com/><img srcset="/img/profile-picture_hu4241499301404582006.jpg 80w" src=/img/profile-picture.jpg width=386 height=345 alt="Nick Fisher's tech blog"></a></div><div class="flex flex-col gap-5"><a href=https://www.nickolasfisher.com/><h1 id=site-title>Nick Fisher's tech blog</h1></a><nav><ul><li><a href=/>home</a></li><li><a href=/blog>blog</a></li><li><a href=/about>about</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></header><button class=toggle-theme aria-label="Toggle Theme" title="Toggle Theme" onclick=toggleTheme()>
<span class="theme-icon light"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75.0 11-7.5.0 3.75 3.75.0 017.5.0z"/></svg> </span><span class="theme-icon dark"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718.0 0118 15.75c-5.385.0-9.75-4.365-9.75-9.75.0-1.33.266-2.597.748-3.752A9.753 9.753.0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753.0 009.002-5.998z"/></svg> </span></button>
<script>document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("theme");setTheme(!e||e==="light"?"light":e)});function setTheme(e){const t=document.querySelector("html");localStorage.setItem("theme",e),e==="light"?(t.classList.contains("dark")&&document.querySelector("html").classList.remove("dark"),document.querySelector(".theme-icon.light").style.display="none",document.querySelector(".theme-icon.dark").style.display="block"):(t.classList.contains("dark")||document.querySelector("html").classList.add("dark"),document.querySelector(".theme-icon.dark").style.display="none",document.querySelector(".theme-icon.light").style.display="block")}function toggleTheme(){const e=localStorage.getItem("theme");setTheme(e==="light"?"dark":"light")}</script></div><main id=content><article class="flex flex-col gap-10"><header class="flex flex-col gap-2"><h2 class=title-large>How to Make Parallel API calls in Spring Boot Webflux</h2><div class=meta><time datetime="2020-09-19 16:03:01 +0000 UTC" title='Sat, Sep 19, 2020, 4:03 PM UTC'>19/09/2020 - Estimated reading time: 3 minutes</time></div></header><section><p>The source code for this post <a href=https://github.com/nfisher23/reactive-programming-webflux/tree/master/api-calls-and-resilience>can be found on Github</a>.</p><p>Following up on the last post, which was making sequential calls to downstream services, sometimes you are in a position where you can make calls in parallel and merge the results. In this case, we want to use <strong>zip</strong>.</p><p>Let&rsquo;s take the framework we started in the last post and demonstrate how this might work.</p><h3 id=dtos>DTOs</h3><p>Recall we had two simple DTOs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>FirstCallDTO</span> {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> Integer fieldFromFirstCall;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Integer <span style=color:#50fa7b>getFieldFromFirstCall</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> fieldFromFirstCall;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setFieldFromFirstCall</span>(Integer fieldFromFirstCall) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>fieldFromFirstCall</span> <span style=color:#ff79c6>=</span> fieldFromFirstCall;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...<span style=color:#50fa7b>another</span> file...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>SecondCallDTO</span> {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> String fieldFromSecondCall;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>getFieldFromSecondCall</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> fieldFromSecondCall;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setFieldFromSecondCall</span>(String fieldFromSecondCall) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>fieldFromSecondCall</span> <span style=color:#ff79c6>=</span> fieldFromSecondCall;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Let&rsquo;s now add a DTO that will serve to merge the results of the these two DTOs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>MergedCallsDTO</span> {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> Integer fieldOne;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> String fieldTwo;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Integer <span style=color:#50fa7b>getFieldOne</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> fieldOne;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setFieldOne</span>(Integer fieldOne) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>fieldOne</span> <span style=color:#ff79c6>=</span> fieldOne;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>getFieldTwo</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> fieldTwo;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setFieldTwo</span>(String fieldTwo) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>fieldTwo</span> <span style=color:#ff79c6>=</span> fieldTwo;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>With that in place, let&rsquo;s follow TDD and set up a bare bones method in our <strong>CombiningCallsService</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Mono<span style=color:#ff79c6>&lt;</span>MergedCallsDTO<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>mergedCalls</span>(Integer firstEndpointParam, Integer secondEndpointParam) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span>;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Our test should:</p><ul><li>Declare expectations on mock server for two endpoints</li><li>Ensure the response matches the contract of the first two DTOs</li><li>Make assertions on the merged result</li></ul><p>That test, using mock server, can look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    @Test
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>mergedCalls_callsBothEndpointsAndMergesResults</span>() {
</span></span><span style=display:flex><span>        HttpRequest expectedFirstRequest <span style=color:#ff79c6>=</span> HttpRequest.<span style=color:#50fa7b>request</span>()
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>withMethod</span>(HttpMethod.<span style=color:#50fa7b>GET</span>.<span style=color:#50fa7b>name</span>())
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>withPath</span>(<span style=color:#f1fa8c>&#34;/first/endpoint/25&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>clientAndServer</span>.<span style=color:#50fa7b>when</span>(
</span></span><span style=display:flex><span>                expectedFirstRequest
</span></span><span style=display:flex><span>        ).<span style=color:#50fa7b>respond</span>(
</span></span><span style=display:flex><span>                HttpResponse.<span style=color:#50fa7b>response</span>()
</span></span><span style=display:flex><span>                        .<span style=color:#50fa7b>withBody</span>(<span style=color:#f1fa8c>&#34;{\&#34;fieldFromFirstCall\&#34;: 250}&#34;</span>)
</span></span><span style=display:flex><span>                        .<span style=color:#50fa7b>withContentType</span>(MediaType.<span style=color:#50fa7b>APPLICATION_JSON</span>)
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        HttpRequest expectedSecondRequest <span style=color:#ff79c6>=</span> HttpRequest.<span style=color:#50fa7b>request</span>()
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>withMethod</span>(HttpMethod.<span style=color:#50fa7b>GET</span>.<span style=color:#50fa7b>name</span>())
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>withPath</span>(<span style=color:#f1fa8c>&#34;/second/endpoint/45&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>clientAndServer</span>.<span style=color:#50fa7b>when</span>(
</span></span><span style=display:flex><span>                expectedSecondRequest
</span></span><span style=display:flex><span>        ).<span style=color:#50fa7b>respond</span>(
</span></span><span style=display:flex><span>                HttpResponse.<span style=color:#50fa7b>response</span>()
</span></span><span style=display:flex><span>                        .<span style=color:#50fa7b>withBody</span>(<span style=color:#f1fa8c>&#34;{\&#34;fieldFromSecondCall\&#34;: \&#34;something\&#34;}&#34;</span>)
</span></span><span style=display:flex><span>                        .<span style=color:#50fa7b>withContentType</span>(MediaType.<span style=color:#50fa7b>APPLICATION_JSON</span>)
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        StepVerifier.<span style=color:#50fa7b>create</span>(<span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>combiningCallsService</span>.<span style=color:#50fa7b>mergedCalls</span>(25, 45))
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>expectNextMatches</span>(mergedCallsDTO <span style=color:#ff79c6>-&gt;</span> 250 <span style=color:#ff79c6>==</span> mergedCallsDTO.<span style=color:#50fa7b>getFieldOne</span>()
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>&amp;</span>amp;<span style=color:#ff79c6>&amp;</span>amp; <span style=color:#f1fa8c>&#34;something&#34;</span>.<span style=color:#50fa7b>equals</span>(mergedCallsDTO.<span style=color:#50fa7b>getFieldTwo</span>())
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>verifyComplete</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>clientAndServer</span>.<span style=color:#50fa7b>verify</span>(expectedFirstRequest, VerificationTimes.<span style=color:#50fa7b>once</span>());
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>clientAndServer</span>.<span style=color:#50fa7b>verify</span>(expectedSecondRequest, VerificationTimes.<span style=color:#50fa7b>once</span>());
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>While pretty self explanatory, we are using the reactor test&rsquo;s <strong>StepVerifier</strong> to verify that the mono, upon completing and calling back, will return an object that matches the assertion in the <strong>expectNextMatches</strong> block.</p><p>You will, predictably, see this test fail without any code to make it pass, so let&rsquo;s write that code now:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Mono<span style=color:#ff79c6>&lt;</span>MergedCallsDTO<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>mergedCalls</span>(Integer firstEndpointParam, Integer secondEndpointParam) {
</span></span><span style=display:flex><span>        Mono<span style=color:#ff79c6>&lt;</span>FirstCallDTO<span style=color:#ff79c6>&gt;</span> firstCallDTOMono <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>serviceAWebClient</span>.<span style=color:#50fa7b>get</span>()
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>uri</span>(uriBuilder <span style=color:#ff79c6>-&gt;</span> uriBuilder.<span style=color:#50fa7b>path</span>(<span style=color:#f1fa8c>&#34;/first/endpoint/{param}&#34;</span>).<span style=color:#50fa7b>build</span>(firstEndpointParam))
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>retrieve</span>()
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>bodyToMono</span>(FirstCallDTO.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Mono<span style=color:#ff79c6>&lt;</span>SecondCallDTO<span style=color:#ff79c6>&gt;</span> secondCallDTOMono <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>serviceAWebClient</span>.<span style=color:#50fa7b>get</span>()
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>uri</span>(uriBuilder <span style=color:#ff79c6>-&gt;</span> uriBuilder.<span style=color:#50fa7b>path</span>(<span style=color:#f1fa8c>&#34;/second/endpoint/{param}&#34;</span>).<span style=color:#50fa7b>build</span>(secondEndpointParam))
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>retrieve</span>()
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>bodyToMono</span>(SecondCallDTO.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// nothing has been subscribed to, those calls above are not waiting for anything and are not subscribed to, yet</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// zipping the monos will invoke the callback in &#34;map&#34; once both of them have completed, merging the results</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// into a tuple.</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> Mono.<span style=color:#50fa7b>zip</span>(firstCallDTOMono, secondCallDTOMono)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>map</span>(objects <span style=color:#ff79c6>-&gt;</span> {
</span></span><span style=display:flex><span>                    MergedCallsDTO mergedCallsDTO <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> MergedCallsDTO();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    mergedCallsDTO.<span style=color:#50fa7b>setFieldOne</span>(objects.<span style=color:#50fa7b>getT1</span>().<span style=color:#50fa7b>getFieldFromFirstCall</span>());
</span></span><span style=display:flex><span>                    mergedCallsDTO.<span style=color:#50fa7b>setFieldTwo</span>(objects.<span style=color:#50fa7b>getT2</span>().<span style=color:#50fa7b>getFieldFromSecondCall</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>return</span> mergedCallsDTO;
</span></span><span style=display:flex><span>                });
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>As you can see in the code comments, simply making a block of code return a <strong>Mono</strong> doesn&rsquo;t actually do anything until it is subscribed to. In the case of our test, we are subscribing directly to it. If we wrote an endpoint that were invoked when someone made an http request to our application, then it would get subscribed to only at the end of the chain and we wouldn&rsquo;t ever actually write <strong>subscribe</strong> anywhere.</p><p>So, by using <strong>zip</strong>, they are both kicked off at the same time, and we wait for both of them to complete, merging the results with <strong>map</strong>. If you run the test, it will now pass.</p></section><footer><div class="pb-14 taxonomy-list tags-list"><a href=/tags/java/ alt=Java>Java
</a><a href=/tags/spring/ alt=Spring>Spring
</a><a href=/tags/reactive/ alt=Reactive>Reactive
</a><a href=/tags/webflux/ alt=Webflux>Webflux</a></div></footer></article></main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2"><div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">© 2018-2025 —
<a href=https://www.nickolasfisher.com/>Nick Fisher's tech blog</a></div><div class="order-1 sm:order-2"><ul class="flex sm:justify-end gap-5"><li><a href=https://www.linkedin.com/in/nick-fisher-software/ target=_blank rel="noopener noreferrer">LinkedIn</a></li><li><a href=https://github.com/nfisher23 target=_blank rel="noopener noreferrer">GitHub</a></li></ul></div></footer></body></html>