<!doctype html><html lang=en-US class="scroll-smooth dark"><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>How to Migrate a Real PostgreSQL Database Using Flyway with Spring Boot</title>
<meta name=description content="You can see the source code for this post on GitHub.
We spent the last post figuring out how to migrate an embedded PostgreSQL database using Spring, while trying to side-step the extra magic that comes along with the framework. Here, we are going to build on that work to migrate a real PostgreSQL instance, which we will build in a local Vagrant Virtual Machine."><link rel=canonical href=https://www.nickolasfisher.com/blog/how-to-migrate-a-real-postgresql-database-using-flyway-with-spring-boot/><link rel=robots href=/robots.txt><link rel=icon type=image/x-icon href=/img/nficon.png><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><link rel=stylesheet href="https://www.nickolasfisher.com/css/app.min.dee9c4afb37cb95c5d39c976614ef6f95398bcba4b6e73066c44de2a3a6543ed.css"></head><body class="max-w-screen-md mx-auto px-2.5"><div class=header><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12"><div class="flex-none w-20 h-20 rounded-full overflow-hidden"><a href=https://www.nickolasfisher.com/><img srcset="/img/profile-picture_hu4241499301404582006.jpg 80w" src=/img/profile-picture.jpg width=386 height=345 alt="Nick Fisher's tech blog"></a></div><div class="flex flex-col gap-5"><a href=https://www.nickolasfisher.com/><h1 id=site-title>Nick Fisher's tech blog</h1></a><nav><ul><li><a href=/>home</a></li><li><a href=/blog>blog</a></li><li><a href=/about>about</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></header><button class=toggle-theme aria-label="Toggle Theme" title="Toggle Theme" onclick=toggleTheme()>
<span class="theme-icon light"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75.0 11-7.5.0 3.75 3.75.0 017.5.0z"/></svg> </span><span class="theme-icon dark"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718.0 0118 15.75c-5.385.0-9.75-4.365-9.75-9.75.0-1.33.266-2.597.748-3.752A9.753 9.753.0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753.0 009.002-5.998z"/></svg> </span></button>
<script>document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("theme");setTheme(!e||e==="light"?"light":e)});function setTheme(e){const t=document.querySelector("html");localStorage.setItem("theme",e),e==="light"?(t.classList.contains("dark")&&document.querySelector("html").classList.remove("dark"),document.querySelector(".theme-icon.light").style.display="none",document.querySelector(".theme-icon.dark").style.display="block"):(t.classList.contains("dark")||document.querySelector("html").classList.add("dark"),document.querySelector(".theme-icon.dark").style.display="none",document.querySelector(".theme-icon.light").style.display="block")}function toggleTheme(){const e=localStorage.getItem("theme");setTheme(e==="light"?"dark":"light")}</script></div><main id=content><article class="flex flex-col gap-10"><header class="flex flex-col gap-2"><h2 class=title-large>How to Migrate a Real PostgreSQL Database Using Flyway with Spring Boot</h2><div class=meta><time datetime="2019-04-20 16:37:18 +0000 UTC" title='Sat, Apr 20, 2019, 4:37 PM UTC'>20/04/2019 - Estimated reading time: 3 minutes</time></div></header><section><p>You can see the source code for this post <a href=https://github.com/nfisher23/postgres-flyway-example>on GitHub</a>.</p><p>We spent the last post figuring out <a href=https://nickolasfisher.com/blog/How-to-Migrate-An-Embedded-PostgreSQL-Database-Using-Flyway-in-Spring-Boot>how to migrate an embedded PostgreSQL database using Spring</a>, while trying to side-step the extra magic that comes along with the framework. Here, we are going to build on that work to migrate a real PostgreSQL instance, which we will build in a local Vagrant Virtual Machine.</p><p>To do this in a maintainable way, we will want to leverage <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html>Spring Profiles</a> to allow us to retain local development as an option and switch to another setup relatively quickly. We will change our <strong>application.yml</strong> file to look like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>spring.profiles.active</span>: dev
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#ff79c6>spring.profiles</span>: dev
</span></span><span style=display:flex><span><span style=color:#ff79c6>spring.flyway.enabled</span>: <span style=color:#ff79c6>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#ff79c6>spring.profiles</span>: stage
</span></span><span style=display:flex><span><span style=color:#ff79c6>spring.flyway.enabled</span>: <span style=color:#ff79c6>false</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>spring.datasource.password</span>: postgres
</span></span><span style=display:flex><span><span style=color:#ff79c6>spring.datasource.username</span>: postgres
</span></span><span style=display:flex><span><span style=color:#ff79c6>spring.datasource.url</span>: jdbc:postgresql://192.168.56.111:5432/testdb
</span></span><span style=display:flex><span><span style=color:#ff79c6>spring.datasource.driver-class-name</span>: org.postgresql.Driver
</span></span></code></pre></div><p>Here, we are telling Spring Boot to use the &ldquo;dev&rdquo; profile by default, and if we decide to use the &ldquo;stage&rdquo; profile, then the application will attempt to connect to a PostgreSQL database at the 192.168.56.111 IP address, at port 5432. It will connect to the <strong>testdb</strong> database and use postgres/postgres as the username/password combo.</p><p><strong>Note</strong>: Never use postgres/postgres as the username/password combo for a database that you actually want to protect. This will last about five seconds on the internet.</p><p>With the work we have already done, this will ensure that our application runs the database migration scripts on application start time in an idempotent way. We just need a real database to validate this against, and I will use <a href=https://www.vagrantup.com/>Vagrant</a>. I&rsquo;ve created a <strong>postgres-vm/Vagrantfile</strong> like:</p><pre tabindex=0><code>Vagrant.configure(&#34;2&#34;) do |config|
  config.vm.box = &#34;ubuntu/bionic64&#34;

  config.vm.provider &#34;virtualbox&#34; do |v|
    v.memory = 2048
    v.cpus = 1
  end

  config.vm.provision &#34;file&#34;, source: &#34;~/.ssh/id_rsa.pub&#34;, destination: &#34;~/.ssh/me.pub&#34;
  config.vm.provision &#34;shell&#34;, inline: &#34;cat /home/vagrant/.ssh/me.pub &gt;&gt; /home/vagrant/.ssh/authorized_keys&#34;
  config.vm.provision &#34;shell&#34;, inline: &#34;mkdir -p /root &amp;amp;&amp;amp; mkdir -p /root/.ssh/ &amp;amp;&amp;amp; cat /home/vagrant/.ssh/me.pub &gt;&gt; /root/.ssh/authorized_keys&#34;
  config.vm.provision :shell, path: &#34;postgres-provision.sh&#34;
  config.vm.network &#34;private_network&#34;, ip: &#34;192.168.56.111&#34;
end
</code></pre><p>This Vagrantfile needs a <strong>postgres-provision.sh</strong> bash script in the same directory, which looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span>sudo apt-get update &amp;amp;&amp;amp; sudo apt-get -y install postgresql
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># set the default to listen to all addresses</span>
</span></span><span style=display:flex><span>sudo sed -i <span style=color:#f1fa8c>&#34;/port*/a listen_addresses = &#39;*&#39;&#34;</span> /etc/postgresql/10/main/postgresql.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># allow any authentication mechanism from any client</span>
</span></span><span style=display:flex><span>sudo sed -i <span style=color:#f1fa8c>&#34;</span>$<span style=color:#f1fa8c> a host all all all trust&#34;</span> /etc/postgresql/10/main/pg_hba.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># create db named testdb</span>
</span></span><span style=display:flex><span>sudo su postgres -c <span style=color:#f1fa8c>&#34;createdb testdb&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># restart the service to allow changes to take effect</span>
</span></span><span style=display:flex><span>sudo service postgresql restart
</span></span></code></pre></div><p>This creates a PostgreSQL database and exposes it (with no security) to the outside world, which in this case is just our local development environment.</p><p>Do:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#8be9fd;font-style:italic>cd</span> postgres-vm
</span></span><span style=display:flex><span>$ vagrant up
</span></span></code></pre></div><p>And, once the VM is up and running, you can:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#8be9fd;font-style:italic>cd</span> ..
</span></span><span style=display:flex><span>$ mvn clean install
</span></span><span style=display:flex><span>$ <span style=color:#8be9fd;font-style:italic>SPRING_PROFILES_ACTIVE</span><span style=color:#ff79c6>=</span>stage java -jar target/flywaystuff-1.0.jar
</span></span></code></pre></div><p>The application will come up and connect to our local database at this point. You can verify that the migration ran properly with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#8be9fd;font-style:italic>cd</span> ../postgres-vm
</span></span><span style=display:flex><span>$ vagrant ssh
</span></span><span style=display:flex><span>$ sudo -i -u postgres
</span></span><span style=display:flex><span>$ psql -d testdb
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>testdb</span><span style=color:#ff79c6>=</span><span style=color:#6272a4># \dt</span>
</span></span></code></pre></div><p>You should get an output like this:</p><pre tabindex=0><code>                 List of relations
 Schema |         Name          | Type  |  Owner
--------+-----------------------+-------+----------
 public | employee              | table | postgres
 public | flyway_schema_history | table | postgres
(2 rows)
</code></pre><p>And we have done it successfully.</p></section><footer><div class="pb-14 taxonomy-list tags-list"><a href=/tags/java/ alt=Java>Java
</a><a href=/tags/distributed-systems/ alt="Distributed Systems">Distributed Systems
</a><a href=/tags/vagrant/ alt=Vagrant>Vagrant
</a><a href=/tags/spring/ alt=Spring>Spring
</a><a href=/tags/devops/ alt=DevOps>DevOps
</a><a href=/tags/postgresql/ alt=PostgreSQL>PostgreSQL</a></div></footer></article></main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2"><div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">© 2018-2025 —
<a href=https://www.nickolasfisher.com/>Nick Fisher's tech blog</a></div><div class="order-1 sm:order-2"><ul class="flex sm:justify-end gap-5"><li><a href=https://www.linkedin.com/in/nick-fisher-software/ target=_blank rel="noopener noreferrer">LinkedIn</a></li><li><a href=https://github.com/nfisher23 target=_blank rel="noopener noreferrer">GitHub</a></li></ul></div></footer></body></html>