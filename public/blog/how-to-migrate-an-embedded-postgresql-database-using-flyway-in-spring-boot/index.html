<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How to Migrate An Embedded PostgreSQL Database Using Flyway in Spring Boot</title>
<meta
  name="description"
  content="The source code for this post can be found on GitHub.
Flyway is a database migration tool. Migrating a database generally means that you are making a change to the way the database currently structures its data. It could also mean you are adding stuff like custom stored procedures or indexes to help speed up queries. Either way, migrating databases is easily the most difficult part of any deployment strategy&ndash;Flyway makes this process as painless as possible because it will, by default, only run migration scripts that haven&#39;t yet run."
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-migrate-an-embedded-postgresql-database-using-flyway-in-spring-boot/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        Home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        Blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        About me
      </a>
    </li>
    
    <li>
      <a href="/categories" class="">
        Categories
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How to Migrate An Embedded PostgreSQL Database Using Flyway in Spring Boot</h2>

    <div class="meta">
      
      <time datetime="2019-04-20 16:00:34 &#43;0000 UTC" title='Sat, Apr 20, 2019, 4:00 PM UTC'>
        20/04/2019 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>The source code for this post can be found <a href="https://github.com/nfisher23/postgres-flyway-example">on GitHub</a>.</p>
<p><a href="https://flywaydb.org/">Flyway</a> is a database migration tool. <em>Migrating</em> a database generally means that you are making a change to the way the database currently structures its data. It could also mean you are adding stuff like custom stored procedures or indexes to help speed up queries. Either way, migrating databases is easily the most difficult part of any deployment strategy&ndash;Flyway makes this process as painless as possible because it will, by default, <em>only run migration scripts that haven't yet run</em>.</p>
<p>If you're also using an <a href="https://nickolasfisher.com/blog/How-to-Create-an-Embedded-PostgreSQL-Database-With-Spring-Boot">Embedded PostgreSQL database</a> to handle database parity between environments, you will then have a much, much higher level of confidence that your changes will not blow everything up, as well as your embedded database precisely representing the data in the production database. This is a huge win for productivity and for reducing errors.</p>
<p>The first thing that we will need to do is add the flyway dependency which, if you're using Maven, is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>&amp;lt;dependency&amp;gt;
</span></span><span style="display:flex;"><span>    &amp;lt;groupId&amp;gt;org.flywaydb&amp;lt;/groupId&amp;gt;
</span></span><span style="display:flex;"><span>    &amp;lt;artifactId&amp;gt;flyway-core&amp;lt;/artifactId&amp;gt;
</span></span><span style="display:flex;"><span>&amp;lt;/dependency&amp;gt;
</span></span></code></pre></div><p>While there is some <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-database-initialization.html">Spring Boot magic for running migration scripts with Flyway</a>, the magic can often make it hard to customize it (and, eventually, you will most likely need to customize it). With a bit of work we can remove the magic and get exactly what we want, using code. To prevent the magic from getting in the way of this example, be sure to add this to your <strong>application.yml</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">spring.flyway.enabled</span>: <span style="color:#ff79c6">false</span>
</span></span></code></pre></div><p>If we have our in memory database from the last post set up using a Spring Profile called &quot;dev&quot;:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.nickolasfisher.flywaystuff;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>... imports ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@ComponentScan
</span></span><span style="display:flex;"><span>@Profile(<span style="color:#ff79c6">&amp;</span>#34;dev<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">DevConfig</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    @Primary
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> DataSource <span style="color:#50fa7b">inMemoryDS</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>        DataSource embeddedPostgresDS <span style="color:#ff79c6">=</span> EmbeddedPostgres.<span style="color:#50fa7b">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">start</span>().<span style="color:#50fa7b">getPostgresDatabase</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> embeddedPostgresDS;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can use <strong>@PostConstruct</strong> to run our migration immediately after the application context wiring itself:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.nickolasfisher.flywaystuff;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>... imports ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Migrate</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    DataSource ds;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @PostConstruct
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">migrateWithFlyway</span>() {
</span></span><span style="display:flex;"><span>        Flyway flyway <span style="color:#ff79c6">=</span> Flyway.<span style="color:#50fa7b">configure</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">dataSource</span>(ds)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">locations</span>(<span style="color:#ff79c6">&amp;</span>#34;db<span style="color:#ff79c6">/</span>migration<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">load</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        flyway.<span style="color:#50fa7b">migrate</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here, any migration scripts found in our <strong>src/main/resources/db/migration</strong> directory will be run in an idempotent fashion. You can read up on the <a href="https://flywaydb.org/getstarted/how">conventions that flyway uses to decide the order of migration scripts</a>, but for this example we will add two SQL files. The first I'll call <strong>V1__init.sql</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">TABLE</span> employee (id <span style="color:#8be9fd;font-style:italic">int</span>, name <span style="color:#8be9fd;font-style:italic">text</span>);
</span></span></code></pre></div><p>The second will be <strong>V2__update.sql</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">ALTER</span> <span style="color:#ff79c6">TABLE</span> employee <span style="color:#ff79c6">ALTER</span> <span style="color:#ff79c6">COLUMN</span> id <span style="color:#ff79c6">SET</span> <span style="color:#ff79c6">NOT</span> <span style="color:#ff79c6">NULL</span>;
</span></span></code></pre></div><p>We can verify that this works with something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.nickolasfisher.flywaystuff;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>... imports ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RegularWriter</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    JdbcTemplate jdbcTemplate;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Scheduled(fixedRate <span style="color:#ff79c6">=</span> 5000)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">pollConsistently</span>() {
</span></span><span style="display:flex;"><span>        jdbcTemplate.<span style="color:#50fa7b">execute</span>(<span style="color:#ff79c6">&amp;</span>#34;INSERT INTO <span style="color:#50fa7b">employee</span> (id, name) VALUES (1, <span style="color:#ff79c6">&amp;</span>#39;jack<span style="color:#ff79c6">&amp;</span>#39;)<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>        jdbcTemplate.<span style="color:#50fa7b">query</span>(<span style="color:#ff79c6">&amp;</span>#34;SELECT <span style="color:#ff79c6">*</span> FROM employee<span style="color:#ff79c6">&amp;</span>#34;, (rs) <span style="color:#ff79c6">-&amp;</span>gt; {
</span></span><span style="display:flex;"><span>            rs.<span style="color:#50fa7b">next</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd">int</span> a <span style="color:#ff79c6">=</span> rs.<span style="color:#50fa7b">getInt</span>(<span style="color:#ff79c6">&amp;</span>#34;id<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>            System.<span style="color:#50fa7b">out</span>.<span style="color:#50fa7b">println</span>(a);
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> a;
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        System.<span style="color:#50fa7b">out</span>.<span style="color:#50fa7b">println</span>(<span style="color:#ff79c6">&amp;</span>#34;writing...<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If you run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ mvn clean install
</span></span></code></pre></div><p>And then:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ java -jar target/flywaystuff-1.0.jar
</span></span></code></pre></div><p>You will see the application come up successfully and execute/query the database in memory every 5 seconds.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/java/" alt="Java">
          Java
        </a>
      
        <a href="/tags/spring/" alt="Spring">
          Spring
        </a>
      
        <a href="/tags/devops/" alt="DevOps">
          DevOps
        </a>
      
        <a href="/tags/postgresql/" alt="PostgreSQL">
          PostgreSQL
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
