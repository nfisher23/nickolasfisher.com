<!doctype html><html lang=en-US class="scroll-smooth dark"><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>How to Provision a Standalone Consul Server with Ansible</title>
<meta name=description content="You can find the source code for this post on GitHub.
Consul is a distributed service discovery engine. It&rsquo;s primary purpose is to track and manage services that interact with it&ndash;usually via an HTTP API. It monitors the health of services in near real time, providing a more robust way of routing services to healthy and responsive nodes."><link rel=canonical href=https://www.nickolasfisher.com/blog/how-to-provision-a-standalone-consul-server-with-ansible/><link rel=robots href=/robots.txt><link rel=icon type=image/x-icon href=/img/nficon.png><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><link rel=stylesheet href="https://www.nickolasfisher.com/css/app.min.dee9c4afb37cb95c5d39c976614ef6f95398bcba4b6e73066c44de2a3a6543ed.css"></head><body class="max-w-screen-md mx-auto px-2.5"><div class=header><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12"><div class="flex-none w-20 h-20 rounded-full overflow-hidden"><a href=https://www.nickolasfisher.com/><img srcset="/img/profile-picture_hu4241499301404582006.jpg 80w" src=/img/profile-picture.jpg width=386 height=345 alt="Nick Fisher's tech blog"></a></div><div class="flex flex-col gap-5"><a href=https://www.nickolasfisher.com/><h1 id=site-title>Nick Fisher's tech blog</h1></a><nav><ul><li><a href=/>home</a></li><li><a href=/blog>blog</a></li><li><a href=/about>about</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></header><button class=toggle-theme aria-label="Toggle Theme" title="Toggle Theme" onclick=toggleTheme()>
<span class="theme-icon light"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75.0 11-7.5.0 3.75 3.75.0 017.5.0z"/></svg> </span><span class="theme-icon dark"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718.0 0118 15.75c-5.385.0-9.75-4.365-9.75-9.75.0-1.33.266-2.597.748-3.752A9.753 9.753.0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753.0 009.002-5.998z"/></svg> </span></button>
<script>document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("theme");setTheme(!e||e==="light"?"light":e)});function setTheme(e){const t=document.querySelector("html");localStorage.setItem("theme",e),e==="light"?(t.classList.contains("dark")&&document.querySelector("html").classList.remove("dark"),document.querySelector(".theme-icon.light").style.display="none",document.querySelector(".theme-icon.dark").style.display="block"):(t.classList.contains("dark")||document.querySelector("html").classList.add("dark"),document.querySelector(".theme-icon.dark").style.display="none",document.querySelector(".theme-icon.light").style.display="block")}function toggleTheme(){const e=localStorage.getItem("theme");setTheme(e==="light"?"dark":"light")}</script></div><main id=content><article class="flex flex-col gap-10"><header class="flex flex-col gap-2"><h2 class=title-large>How to Provision a Standalone Consul Server with Ansible</h2><div class=meta><time datetime="2019-04-27 19:49:14 +0000 UTC" title='Sat, Apr 27, 2019, 7:49 PM UTC'>27/04/2019 - Estimated reading time: 4 minutes</time></div></header><section><p>You can find the source code for this post <a href=https://github.com/nfisher23/some-ansible-examples/tree/master/consul-server>on GitHub</a>.</p><p><a href=https://www.consul.io/>Consul</a> is a distributed service discovery engine. It&rsquo;s primary purpose is to track and manage services that interact with it&ndash;usually via an HTTP API. It monitors the health of services in near real time, providing a more robust way of routing services to healthy and responsive nodes.</p><p>In this post, we&rsquo;ll look at provisioning a standalone consul server with Ansible. This is not recommended for production, both because this Consul Server is a single point of failure and because there is no security in this example, but it is a good starting place to Proof-of-Concept the technology.</p><p>You will need Molecule, Ansible, VirtualBox, and Vagrant for this example to work. It will be easier for you to follow along if you are already familiar with those tools.</p><h3 id=create-the-ansible-role>Create the Ansible Role</h3><p>Start by running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ molecule init role -r consul-server -d vagrant
</span></span></code></pre></div><p>This creates a new Ansible role, wrapping Molecule around it, and chooses Vagrant as the VM driver.</p><p>Consul is written using Golang&ndash;a huge draw of Golang is that it is almost always compiled ahead-of-time, to a binary executable of the target machine. To get consul to run on our machine, then, it suffices for us to figure out what the OS of that machine will be. In this example, we are using Ubuntu, which is a Linux distribution, and we can thus install consul_(version)_linux_amd64.zip (see the <a href=https://www.consul.io/downloads.html>Consul Downloads</a> page for any other distributions).</p><p>In your ansible role, modify your <strong>vars/main.yml</strong> file to look like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#6272a4># vars file for consul-server</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>consul_version</span>: <span style=color:#bd93f9>1.4.2</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>consul_zip_file</span>: consul_{{ consul_version }}_linux_amd64.zip
</span></span><span style=display:flex><span><span style=color:#ff79c6>consul_install_dir</span>: /usr/local/bin
</span></span><span style=display:flex><span><span style=color:#ff79c6>consul_config_dir</span>: /etc/consul
</span></span><span style=display:flex><span><span style=color:#ff79c6>consul_data_dir</span>: /var/data
</span></span></code></pre></div><p>We will need all of these in a moment, they are all pretty self explanatory.</p><p>While you can technically pass in a large collection of configuration parameters to consul at startup time, it is much more manageable to pass in a configuration file using <a href=https://www.consul.io/docs/agent/options.html#_config_file>-config-dir or -config-file</a>&ndash;for this example, we will do exactly that. Our Jinja2 template for our consul configuration file can go in <strong>templates/consul.config.j2</strong> and look like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;node_name&#34;</span>: <span style=color:#f1fa8c>&#34;example&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;addresses&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&#34;http&#34;</span>: <span style=color:#f1fa8c>&#34;{{ ansible_facts[&#39;all_ipv4_addresses&#39;] | last }} 127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;server&#34;</span>: <span style=color:#ff79c6>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;advertise_addr&#34;</span>: <span style=color:#f1fa8c>&#34;{{ ansible_facts[&#39;all_ipv4_addresses&#39;] | last }}&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;client_addr&#34;</span>: <span style=color:#f1fa8c>&#34;127.0.0.1 {{ ansible_facts[&#39;all_ipv4_addresses&#39;] | last }}&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;connect&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&#34;enabled&#34;</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;data_dir&#34;</span>: <span style=color:#f1fa8c>&#34;{{ consul_data_dir }}&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;bootstrap&#34;</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This tells Consul to run in Server Mode, and to bootstrap itself on startup. It also specifies the IP of the target machine using ansible_facts, and specifies the data directory with data_dir.</p><p>We can now move forward with the template for our Systemd service. In your <strong>templates/consul.service.j2</strong> file:</p><pre tabindex=0><code>[Unit]
Description=solo consul server example

[Service]
WorkingDirectory={{ consul_config_dir }}
User=root
ExecStart={{ consul_install_dir }}/consul agent -config-dir={{ consul_config_dir }}

[Install]
WantedBy=multi-user.target
</code></pre><p>This is very simple: the user running this process is root, and we are using configuration parameters from our vars/main.yml file to generate this file on the fly.</p><p>We need two more things for this role to be complete. The first is an Ansible handler to restart consul when we make critical changes that require a restart. In <strong>handlers/main.yml</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#6272a4># handlers file for consul-server</span>
</span></span><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: restart consul
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>systemd</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: consul.service
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>daemon_reload</span>: <span style=color:#ff79c6>yes</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>state</span>: restarted
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>become</span>: <span style=color:#ff79c6>yes</span>
</span></span></code></pre></div><p>Finally, we can specify the tasks that are going to carry out the installation for us. In <strong>tasks/main.yml</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#6272a4># tasks file for consul-server</span>
</span></span><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: get consul zip
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>get_url</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>dest</span>: <span style=color:#f1fa8c>&#34;/etc/{{ consul_zip_file }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>url</span>: <span style=color:#f1fa8c>&#34;https://releases.hashicorp.com/consul/{{ consul_version }}/{{ consul_zip_file }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>become</span>: <span style=color:#ff79c6>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: ensure unzip present
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>apt</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: unzip
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>update_cache</span>: <span style=color:#ff79c6>yes</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>become</span>: <span style=color:#ff79c6>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: place unzipped consul on path
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>unarchive</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>src</span>: <span style=color:#f1fa8c>&#34;/etc/{{ consul_zip_file }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>dest</span>: <span style=color:#f1fa8c>&#34;{{ consul_install_dir }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>remote_src</span>: <span style=color:#ff79c6>yes</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>become</span>: <span style=color:#ff79c6>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: ensure directories for data and config exists
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>file</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>path</span>: <span style=color:#f1fa8c>&#34;{{ item }}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>state</span>: directory
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>with_items</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f1fa8c>&#34;{{ consul_config_dir }}&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f1fa8c>&#34;{{ consul_data_dir }}&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>become</span>: <span style=color:#ff79c6>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: send consul configuration file
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>dest</span>: <span style=color:#f1fa8c>&#34;{{ consul_config_dir }}/config.json&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>src</span>: consul.config.j2
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>notify</span>: restart consul
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>become</span>: <span style=color:#ff79c6>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#ff79c6>name</span>: ensure consul service file exists
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>dest</span>: /etc/systemd/system/consul.service
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>src</span>: consul.service.j2
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>force</span>: <span style=color:#ff79c6>yes</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>mode</span>: <span style=color:#bd93f9>0644</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>notify</span>: restart consul
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>become</span>: <span style=color:#ff79c6>yes</span>
</span></span></code></pre></div><p>The critical steps here are: downloading consul, placing the unzipped binary on the path, ensuring configuration and systemd template files are up there in their appropriate location. We let the handler start Consul up for us.</p><p>Once you run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ molecule create &amp;amp;&amp;amp; molecule converge
</span></span></code></pre></div><p>And the virtual machine comes up, you should be able to hit 192.168.56.211:8500, and see ﻿Consul Agent﻿ come up.</p></section><footer><div class="pb-14 taxonomy-list tags-list"><a href=/tags/ansible/ alt=Ansible>Ansible
</a><a href=/tags/devops/ alt=DevOps>DevOps
</a><a href=/tags/consul/ alt=Consul>Consul</a></div></footer></article></main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2"><div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">© 2018-2025 —
<a href=https://www.nickolasfisher.com/>Nick Fisher's tech blog</a></div><div class="order-1 sm:order-2"><ul class="flex sm:justify-end gap-5"><li><a href=https://www.linkedin.com/in/nick-fisher-software/ target=_blank rel="noopener noreferrer">LinkedIn</a></li><li><a href=https://github.com/nfisher23 target=_blank rel="noopener noreferrer">GitHub</a></li></ul></div></footer></body></html>