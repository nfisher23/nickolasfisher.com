<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How to Run a Script on Cluster State Change Using Consul Watch</title>
<meta
  name="description"
  content="You can see the sample code for this post on Github.
Consul Watches offer a way to hook into changes to the Consul cluster state at runtime.The specific type of changes we will be looking at hooking into in this post are checks. Whenever a node or service comes online and registers to Consul, whenever an existing node or service leaves Consul, or whenever an existing node or service becomes unresponsive, Consul will emit a check event. This check event can invoke a process to monitor the health of our services, alerting human being that action might soon be necessary."
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-run-a-script-on-cluster-state-change-using-consul-watch/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        Home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        Blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        About me
      </a>
    </li>
    
    <li>
      <a href="/categories" class="">
        Categories
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How to Run a Script on Cluster State Change Using Consul Watch</h2>

    <div class="meta">
      
      <time datetime="2019-05-25 22:18:42 &#43;0000 UTC" title='Sat, May 25, 2019, 10:18 PM UTC'>
        25/05/2019 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>You can see the sample code for this post <a href="https://github.com/nfisher23/some-ansible-examples/tree/master/consul-server">on Github</a>.</p>
<p><a href="https://www.consul.io/docs/agent/watches.html">Consul Watches</a> offer a way to hook into changes to the Consul cluster state at runtime.The specific type of changes we will be looking at hooking into in this post are <a href="https://www.consul.io/docs/agent/watches.html#type-checks">checks</a>. Whenever a node or service comes online and registers to Consul, whenever an existing node or service leaves Consul, or whenever an existing node or service becomes unresponsive, Consul will emit a check event. This check event can invoke a process to monitor the health of our services, alerting human being that action might soon be necessary.</p>
<p>There are two ways to provide custom logic on an emitted check event: either run a script or have Consul call an HTTP endpoint. Running a script will require Consul to be able to to reach the script and have permissions to execute it, whereas calling an HTTP endpoint just requires that something is listening on the appropriate IP and port. However, the downside of an HTTP endpoint is that the service listening on it can't be down. This is a classic &quot;who watches the watchmen?&quot; problem. If we have monitoring logic that we rely on for all of our services, what is going to monitor the service that monitors?</p>
<p>That reason is why I prefer the script approach, and I'll show you how to accomplish this using Ansible.</p>
<h3 id="deploy-a-local-cluster">Deploy a Local Cluster</h3>
<p>In a previous post, I showed you <a href="https://nickolasfisher.com/blog/How-to-Provision-a-Consul-ClientServer-Cluster-using-Ansible">how to provision a Consul client-server cluster using Ansible</a>. Starting from that point on, we can make some sensible modifications to POC this functionality.</p>
<p>First, we'll need a basic script to invoke. Create a <strong>files/watch_script.py</strong> script and fill it with:</p>
<pre tabindex="0"><code>#!/usr/bin/python3

with open(&amp;#39;somefile.txt&amp;#39;, &amp;#39;a&amp;#39;) as file:
    file.write(&amp;#39;some new line\n&amp;#39;)
</code></pre><p>Like all python scripts, this reads pretty much like English, and we can see that we are writing &quot;some new line&quot; to a file in the same directory as the script, and we're calling the file &quot;somefile.txt&quot;.</p>
<p>Next, we'll need to drop the script on the server where Consul is provisioned. Insert the following line in the <strong>tasks/main.yml</strong> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#ff79c6">name</span>: send consul watch script
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">copy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">dest</span>: <span style="color:#ff79c6">&amp;#34;{{</span> consul_config_dir }}/watch_script.py&amp;#34;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">src</span>: watch_script.py
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">mode</span>: <span style="color:#bd93f9">0777</span> <span style="color:#6272a4"># restrict this mode more in production</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">owner</span>: root
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">become</span>: <span style="color:#ff79c6">yes</span>
</span></span></code></pre></div><p>This is just a POC, but you will want to lock down the script to be owned by Consul in a production environment, and you will also want to put it in a different directory than the configuration directory.</p>
<p>Finally, adjust your <strong>templates/consul.config.j2</strong> file to look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    &amp;#34;node_name&amp;#34;: &amp;#34;{{ node_name }}&amp;#<span style="color:#bd93f9">34</span>;,
</span></span><span style="display:flex;"><span>    &amp;#<span style="color:#bd93f9">34</span>;addresses&amp;#<span style="color:#bd93f9">34</span>;: {
</span></span><span style="display:flex;"><span>        &amp;#34;http&amp;#34;: &amp;#34;{{ ansible_facts[&amp;#39;all_ipv4_addresses&amp;#39;] | last }} <span style="color:#bd93f9">127.0</span>.<span style="color:#bd93f9">0.1</span>&amp;#<span style="color:#bd93f9">34</span>;
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    &amp;#<span style="color:#bd93f9">34</span>;server&amp;#<span style="color:#bd93f9">34</span>;: {{ is_server }},
</span></span><span style="display:flex;"><span>    &amp;#<span style="color:#bd93f9">34</span>;advertise_addr&amp;#<span style="color:#bd93f9">34</span>;: &amp;#<span style="color:#bd93f9">34</span>;{{ ansible_facts[&amp;#39;all_ipv4_addresses&amp;#39;] | last }}&amp;#<span style="color:#bd93f9">34</span>;,
</span></span><span style="display:flex;"><span>    &amp;#<span style="color:#bd93f9">34</span>;client_addr&amp;#<span style="color:#bd93f9">34</span>;: &amp;#<span style="color:#bd93f9">34</span>;<span style="color:#bd93f9">127.0</span>.<span style="color:#bd93f9">0.1</span> {{ ansible_facts[&amp;#39;all_ipv4_addresses&amp;#39;] | last }}&amp;#<span style="color:#bd93f9">34</span>;,
</span></span><span style="display:flex;"><span>    &amp;#<span style="color:#bd93f9">34</span>;connect&amp;#<span style="color:#bd93f9">34</span>;: {
</span></span><span style="display:flex;"><span>        &amp;#34;enabled&amp;#34;: true
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    &amp;#<span style="color:#bd93f9">34</span>;data_dir&amp;#<span style="color:#bd93f9">34</span>;: &amp;#<span style="color:#bd93f9">34</span>;{{ consul_data_dir }}&amp;#<span style="color:#bd93f9">34</span>;,
</span></span><span style="display:flex;"><span>    &amp;#<span style="color:#bd93f9">34</span>;watches&amp;#<span style="color:#bd93f9">34</span>;: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            &amp;#34;type&amp;#34;: &amp;#34;checks&amp;#34;,
</span></span><span style="display:flex;"><span>            &amp;#34;handler&amp;#34;: &amp;#34;{{ consul_config_dir }}/watch_script.py&amp;#<span style="color:#bd93f9">34</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>{% if is_server == &amp;#39;false&amp;#39; %}
</span></span><span style="display:flex;"><span>    &amp;#<span style="color:#bd93f9">34</span>;start_join&amp;#<span style="color:#bd93f9">34</span>;: [ &amp;#<span style="color:#bd93f9">34</span>;{{ hostvars[&amp;#39;consulServer&amp;#39;][&amp;#39;ansible_all_ipv4_addresses&amp;#39;] | last }}&amp;#<span style="color:#bd93f9">34</span>;]
</span></span><span style="display:flex;"><span>{% else %}
</span></span><span style="display:flex;"><span>    &amp;#<span style="color:#bd93f9">34</span>;bootstrap&amp;#<span style="color:#bd93f9">34</span>;: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>{% endif %}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The critical part of this is the &quot;watches&quot; section, which will be rendered by Jinja2 as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>    &amp;#<span style="color:#bd93f9">34</span>;watches&amp;#<span style="color:#bd93f9">34</span>;: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            &amp;#34;type&amp;#34;: &amp;#34;checks&amp;#34;,
</span></span><span style="display:flex;"><span>            &amp;#34;handler&amp;#34;: &amp;#34;/etc/consul/watch_script.py&amp;#34;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ],
</span></span></code></pre></div><p>Which tells Consul that, whenever there is a state changes related to nodes or services, to invoke the script at the handler path.</p>
<p>If you run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule create &amp;amp;&amp;amp; molecule converge
</span></span></code></pre></div><p>At this point, you will see the cluster come up. To prove that the file gets created and populated by our script, you can either restart one of the Consul Agents, or refer to a previous post on <a href="https://nickolasfisher.com/blog/How-to-Register-a-Spring-Boot-Service-to-a-Consul-Cluster">registering a simple java service to a consul cluster</a>. Either one will demo the functionality provided.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/vagrant/" alt="Vagrant">
          Vagrant
        </a>
      
        <a href="/tags/ansible/" alt="Ansible">
          Ansible
        </a>
      
        <a href="/tags/devops/" alt="DevOps">
          DevOps
        </a>
      
        <a href="/tags/molecule/" alt="Molecule">
          Molecule
        </a>
      
        <a href="/tags/consul/" alt="Consul">
          Consul
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
