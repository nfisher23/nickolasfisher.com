<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How to Test Latency with a Mock Server in Java</title>
<meta
  name="description"
  content="The source code for what follows can be found on Github.
Very often, you will want to test service api clients using a Mock Server [for example, testing the spring webclient with mockserver]. And since network latency is a fact of life, not something we can merely ignore, actually injecting some latency to simulate timeouts will give us greater confidence that our system will behave as expected."
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-test-latency-with-a-mock-server-in-java/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        Home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        Blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        About me
      </a>
    </li>
    
    <li>
      <a href="/categories" class="">
        Categories
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How to Test Latency with a Mock Server in Java</h2>

    <div class="meta">
      
      <time datetime="2021-05-01 18:12:45 &#43;0000 UTC" title='Sat, May 1, 2021, 6:12 PM UTC'>
        01/05/2021 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>The source code for what follows <a href="https://github.com/nfisher23/java-failure-and-resilience">can be found on Github</a>.</p>
<p>Very often, you will want to test service api clients using a <a href="https://www.mock-server.com/">Mock Server</a> [for example, <a href="https://nickolasfisher.com/blog/How-to-use-Mock-Server-to-End-to-End-Test-Any-WebClient-Calls-in-Spring-Boot-Webflux">testing the spring webclient with mockserver</a>]. And since network latency is a fact of life, not something we can merely ignore, actually injecting some latency to simulate timeouts will give us greater confidence that our system will behave as expected.</p>
<h3 id="boilerplate-for-mock-server">Boilerplate for mock server</h3>
<p>If we start by following the instructions for setting up mock server, we can leverage JUnit 5 and use annotations:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@ExtendWith(MockServerExtension.<span style="color:#50fa7b">class</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MockServerTimeoutTest</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> ClientAndServer clientAndServer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">MockServerTimeoutTest</span>(ClientAndServer clientAndServer) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">clientAndServer</span> <span style="color:#ff79c6">=</span> clientAndServer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @AfterEach
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">reset</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">clientAndServer</span>.<span style="color:#50fa7b">reset</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This automatically starts mock server for us on a random port, and the <strong>@AfterEach</strong> annotation ensures we clear the expectations for mock server, which should give us improved consistency [when one test fails, it doesn't affect the other tests].</p>
<p>A simple example test, using <strong>RestTemplate</strong>, could then look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">basicRestTemplateExample</span>() {
</span></span><span style="display:flex;"><span>        RestTemplate restTemplate <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> RestTemplateBuilder()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">rootUri</span>(<span style="color:#ff79c6">&amp;</span>#34;http:<span style="color:#6272a4">//localhost:&amp;#34; &amp;#43; clientAndServer.getPort())</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">build</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        HttpRequest expectedFirstRequest <span style="color:#ff79c6">=</span> HttpRequest.<span style="color:#50fa7b">request</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">withMethod</span>(HttpMethod.<span style="color:#50fa7b">GET</span>.<span style="color:#50fa7b">name</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">withPath</span>(<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">/</span>some<span style="color:#ff79c6">/</span>endpoint<span style="color:#ff79c6">/</span>10<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        HttpResponse mockResponse <span style="color:#ff79c6">=</span> HttpResponse.<span style="color:#50fa7b">response</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">withBody</span>(<span style="color:#ff79c6">&amp;</span>#34;{\<span style="color:#ff79c6">&amp;</span>#34;message\<span style="color:#ff79c6">&amp;</span>#34;: \<span style="color:#ff79c6">&amp;</span>#34;hello\<span style="color:#ff79c6">&amp;</span>#34;}<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">withContentType</span>(MediaType.<span style="color:#50fa7b">APPLICATION_JSON</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">withStatusCode</span>(200);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">clientAndServer</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">when</span>(expectedFirstRequest)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">respond</span>(mockResponse);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ResponseEntity<span style="color:#ff79c6">&amp;</span>lt;JsonNode<span style="color:#ff79c6">&amp;</span>gt; responseEntity <span style="color:#ff79c6">=</span> restTemplate.<span style="color:#50fa7b">getForEntity</span>(<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">/</span>some<span style="color:#ff79c6">/</span>endpoint<span style="color:#ff79c6">/</span>10<span style="color:#ff79c6">&amp;</span>#34;, JsonNode.<span style="color:#50fa7b">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        assertEquals(<span style="color:#ff79c6">&amp;</span>#34;hello<span style="color:#ff79c6">&amp;</span>#34;, responseEntity.<span style="color:#50fa7b">getBody</span>().<span style="color:#50fa7b">get</span>(<span style="color:#ff79c6">&amp;</span>#34;message<span style="color:#ff79c6">&amp;</span>#34;).<span style="color:#50fa7b">asText</span>());
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>This just makes a request to a canned endpoint <strong>&quot;/some/endpoint/10&quot;</strong> and returns a canned response. We then verify that we deserialize the response properly.</p>
<h3 id="testing-for-latency">Testing for Latency</h3>
<p>Now the question becomes, what happens when we encounter latency? Do we have our timeouts configured properly, and if so can we handle an unexpected increase in latency gracefully?</p>
<p>Instrumenting something like that with mock server is pretty straightforward, we just leverage an <a href="https://javadoc.io/static/org.mock-server/mockserver-core/5.6.1/org/mockserver/mock/action/ExpectationResponseCallback.html">ExpectationResponseCalback</a>, which allows us to run whatever code we want once we get a matching request. This is a functional interface and we can therefore write a little lambda, the condensed version of just sleeping once we get the request can look like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">clientAndServer</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">when</span>(expectedFirstRequest)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">respond</span>(httpRequest <span style="color:#ff79c6">-&amp;</span>gt; {
</span></span><span style="display:flex;"><span>                            Thread.<span style="color:#50fa7b">sleep</span>(150);
</span></span><span style="display:flex;"><span>                            <span style="color:#ff79c6">return</span> mockResponse;
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                );
</span></span></code></pre></div><p>And a full test that leverages that to prove it actually works can be like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">latencyInMockServer</span>() {
</span></span><span style="display:flex;"><span>        RestTemplate restTemplateWithSmallTimeout <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> RestTemplateBuilder()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">rootUri</span>(<span style="color:#ff79c6">&amp;</span>#34;http:<span style="color:#6272a4">//localhost:&amp;#34; &amp;#43; clientAndServer.getPort())</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">setConnectTimeout</span>(Duration.<span style="color:#50fa7b">of</span>(50, ChronoUnit.<span style="color:#50fa7b">MILLIS</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">setReadTimeout</span>(Duration.<span style="color:#50fa7b">of</span>(80, ChronoUnit.<span style="color:#50fa7b">MILLIS</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">build</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        RestTemplate restTemplateWithBigTimeout <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> RestTemplateBuilder()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">rootUri</span>(<span style="color:#ff79c6">&amp;</span>#34;http:<span style="color:#6272a4">//localhost:&amp;#34; &amp;#43; clientAndServer.getPort())</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">setConnectTimeout</span>(Duration.<span style="color:#50fa7b">of</span>(50, ChronoUnit.<span style="color:#50fa7b">MILLIS</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">setReadTimeout</span>(Duration.<span style="color:#50fa7b">of</span>(250, ChronoUnit.<span style="color:#50fa7b">MILLIS</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">build</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        HttpRequest expectedFirstRequest <span style="color:#ff79c6">=</span> HttpRequest.<span style="color:#50fa7b">request</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">withMethod</span>(HttpMethod.<span style="color:#50fa7b">GET</span>.<span style="color:#50fa7b">name</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">withPath</span>(<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">/</span>some<span style="color:#ff79c6">/</span>endpoint<span style="color:#ff79c6">/</span>10<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        HttpResponse mockResponse <span style="color:#ff79c6">=</span> HttpResponse.<span style="color:#50fa7b">response</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">withBody</span>(<span style="color:#ff79c6">&amp;</span>#34;{\<span style="color:#ff79c6">&amp;</span>#34;message\<span style="color:#ff79c6">&amp;</span>#34;: \<span style="color:#ff79c6">&amp;</span>#34;hello\<span style="color:#ff79c6">&amp;</span>#34;}<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">withContentType</span>(MediaType.<span style="color:#50fa7b">APPLICATION_JSON</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">withStatusCode</span>(200);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">clientAndServer</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">when</span>(expectedFirstRequest)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">respond</span>(httpRequest <span style="color:#ff79c6">-&amp;</span>gt; {
</span></span><span style="display:flex;"><span>                            Thread.<span style="color:#50fa7b">sleep</span>(150);
</span></span><span style="display:flex;"><span>                            <span style="color:#ff79c6">return</span> mockResponse;
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>            restTemplateWithSmallTimeout.<span style="color:#50fa7b">getForEntity</span>(<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">/</span>some<span style="color:#ff79c6">/</span>endpoint<span style="color:#ff79c6">/</span>10<span style="color:#ff79c6">&amp;</span>#34;, JsonNode.<span style="color:#50fa7b">class</span>);
</span></span><span style="display:flex;"><span>            fail(<span style="color:#ff79c6">&amp;</span>#34;We should never reach <span style="color:#ff79c6">this</span> line<span style="color:#ff79c6">!&amp;</span>#34;);
</span></span><span style="display:flex;"><span>        } <span style="color:#ff79c6">catch</span> (ResourceAccessException resourceAccessException) {
</span></span><span style="display:flex;"><span>            assertEquals(<span style="color:#ff79c6">&amp;</span>#34;Read timed out<span style="color:#ff79c6">&amp;</span>#34;, resourceAccessException.<span style="color:#50fa7b">getCause</span>().<span style="color:#50fa7b">getMessage</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ResponseEntity<span style="color:#ff79c6">&amp;</span>lt;JsonNode<span style="color:#ff79c6">&amp;</span>gt; jsonNodeResponseEntity <span style="color:#ff79c6">=</span> restTemplateWithBigTimeout
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">getForEntity</span>(<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">/</span>some<span style="color:#ff79c6">/</span>endpoint<span style="color:#ff79c6">/</span>10<span style="color:#ff79c6">&amp;</span>#34;, JsonNode.<span style="color:#50fa7b">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        assertEquals(200, jsonNodeResponseEntity.<span style="color:#50fa7b">getStatusCode</span>().<span style="color:#50fa7b">value</span>());
</span></span><span style="display:flex;"><span>        assertEquals(<span style="color:#ff79c6">&amp;</span>#34;hello<span style="color:#ff79c6">&amp;</span>#34;, jsonNodeResponseEntity.<span style="color:#50fa7b">getBody</span>().<span style="color:#50fa7b">get</span>(<span style="color:#ff79c6">&amp;</span>#34;message<span style="color:#ff79c6">&amp;</span>#34;).<span style="color:#50fa7b">asText</span>());
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>All we do here is assert that we're getting a read timeout when the timeout is lower than how long our mock server will take to respond, and that when it's bigger than the amount of time it takes to respond we are in good shape.</p>
<p>It's important to note that just bumping up the timeouts is not a recommended solution for production code, but this way we can start to test some robust resiliency mechanisms with confidence.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/java/" alt="Java">
          Java
        </a>
      
        <a href="/tags/spring/" alt="Spring">
          Spring
        </a>
      
        <a href="/tags/testing/" alt="Testing">
          Testing
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
