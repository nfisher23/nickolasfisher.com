<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How to Unit Test that a Reactor Mono was Actually Subscribed to</title>
<meta
  name="description"
  content="There&#39;s a very insidious bug that can happen when you&#39;re writing reactive code, and it basically comes down to whether an underlying Mono in a chain of operations was actually subscribed to, rather than merely observing a method invocation. I&#39;ll demonstrate with an example."
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-unit-test-that-a-reactor-mono-was-actually-subscribed-to/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/img/nficon.png" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How to Unit Test that a Reactor Mono was Actually Subscribed to</h2>

    <div class="meta">
      
      <time datetime="2021-03-13 22:35:48 &#43;0000 UTC" title='Sat, Mar 13, 2021, 10:35 PM UTC'>
        13/03/2021 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>There's a very insidious bug that can happen when you're writing reactive code, and it basically comes down to whether an underlying <strong>Mono</strong> in a chain of operations was actually <strong>subscribed to</strong>, rather than merely observing a method invocation. I'll demonstrate with an example.</p>
<p>Let's say you're writing a service that gets a piece of information, then sends that piece of information off to a downstream service for processing. Maybe you just want to record an event in some kind of crude event service, or write to that event database. In that situation, you effectively just want to ensure you successfully sent that piece of information and receive an acknowledgment of a response.</p>
<p>So you go ahead and write a test that looks something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">nothing</span>() {
</span></span><span style="display:flex;"><span>        RetryService mockRetryService <span style="color:#ff79c6">=</span> Mockito.<span style="color:#50fa7b">mock</span>(RetryService.<span style="color:#50fa7b">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Mockito.<span style="color:#50fa7b">when</span>(mockRetryService.<span style="color:#50fa7b">doAThing</span>(anyString()))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">thenReturn</span>(Mono.<span style="color:#50fa7b">empty</span>());
</span></span><span style="display:flex;"><span>        Mockito.<span style="color:#50fa7b">when</span>(mockRetryService.<span style="color:#50fa7b">getSomething</span>(anyString()))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">thenReturn</span>(Mono.<span style="color:#50fa7b">just</span>(<span style="color:#ff79c6">new</span> WelcomeMessage(<span style="color:#ff79c6">&amp;</span>#34;k<span style="color:#ff79c6">&amp;</span>#34;)));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        CachingService cachingService <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> CachingService(mockRetryService);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(cachingService.<span style="color:#50fa7b">getThenAct</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">verifyComplete</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Mockito.<span style="color:#50fa7b">verify</span>(mockRetryService).<span style="color:#50fa7b">doAThing</span>(<span style="color:#ff79c6">&amp;</span>#34;k<span style="color:#ff79c6">&amp;</span>#34;); <span style="color:#6272a4">// &amp;lt;-- this is not testing what you think</span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>As displayed in the comment, this code is not verifying that the underlying Mono that was returned was actually <em>subscribed to</em>. All you're verifying here is that the method <strong>doAThing</strong> was invoked. Because nothing happens until you <strong>subscribe</strong>, the effect your looking for is not guaranteed to happen with this test.</p>
<p>Here's an example where I pass this unit test, but the actual operation that <strong>doAThing</strong> is supposed to do when invoked does not happen:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;Void<span style="color:#ff79c6">&amp;</span>gt; getThenAct() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">retryService</span>.<span style="color:#50fa7b">getSomething</span>(<span style="color:#ff79c6">&amp;</span>#34;something<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// bug!</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">map</span>(messageDTO <span style="color:#ff79c6">-&amp;</span>gt; retryService.<span style="color:#50fa7b">doAThing</span>(messageDTO.<span style="color:#50fa7b">getMessage</span>()))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">then</span>();
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>To fix this problem, we want to track the subscription, not just the method invocation. Here's an example where we can fix our test to do that:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">nothing</span>() {
</span></span><span style="display:flex;"><span>        RetryService mockRetryService <span style="color:#ff79c6">=</span> Mockito.<span style="color:#50fa7b">mock</span>(RetryService.<span style="color:#50fa7b">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        AtomicInteger timesInvoked <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> AtomicInteger(0);
</span></span><span style="display:flex;"><span>        Mockito.<span style="color:#50fa7b">when</span>(mockRetryService.<span style="color:#50fa7b">doAThing</span>(anyString()))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">thenReturn</span>(Mono.<span style="color:#50fa7b">defer</span>(() <span style="color:#ff79c6">-&amp;</span>gt; {
</span></span><span style="display:flex;"><span>                    timesInvoked.<span style="color:#50fa7b">incrementAndGet</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">return</span> Mono.<span style="color:#50fa7b">empty</span>();
</span></span><span style="display:flex;"><span>                }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Mockito.<span style="color:#50fa7b">when</span>(mockRetryService.<span style="color:#50fa7b">getSomething</span>(anyString()))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">thenReturn</span>(Mono.<span style="color:#50fa7b">just</span>(<span style="color:#ff79c6">new</span> WelcomeMessage(<span style="color:#ff79c6">&amp;</span>#34;k<span style="color:#ff79c6">&amp;</span>#34;)));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        CachingService cachingService <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> CachingService(mockRetryService);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(cachingService.<span style="color:#50fa7b">getThenAct</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">verifyComplete</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Mockito.<span style="color:#50fa7b">verify</span>(mockRetryService).<span style="color:#50fa7b">doAThing</span>(<span style="color:#ff79c6">&amp;</span>#34;k<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>        assertEquals(1, timesInvoked.<span style="color:#50fa7b">get</span>());
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Here, we use an <strong>AtomicInteger</strong> just to get around the inability of java programs to modify captured variables [they have to be final/effectively final], but the effect is the same: we're counting the number of times the <strong>Mono</strong> that we return is actually subscribed to, rather than just verifying method signature. Then at the end of the test we assert that it was subscribed to one time.</p>
<p>If you run this test as it stands, it will fail. We can now write code to get that test to pass:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;Void<span style="color:#ff79c6">&amp;</span>gt; getThenAct() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">retryService</span>.<span style="color:#50fa7b">getSomething</span>(<span style="color:#ff79c6">&amp;</span>#34;something<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// not a bug!</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">flatMap</span>(messageDTO <span style="color:#ff79c6">-&amp;</span>gt; retryService.<span style="color:#50fa7b">doAThing</span>(messageDTO.<span style="color:#50fa7b">getMessage</span>()))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">then</span>();
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>In reactive programming, write unit tests that verify that <strong>Mono</strong>'s are actually subscribed to in this way if they return a <strong>Void</strong>, or you will regret it at some point, in the form of a bug.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/java/" alt="Java">
          Java
        </a>
      
        <a href="/tags/reactive/" alt="Reactive">
          Reactive
        </a>
      
        <a href="/tags/webflux/" alt="Webflux">
          Webflux
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
