<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How to use Embedded Redis to Test a Lettuce Client in Spring Boot Webflux</title>
<meta
  name="description"
  content="The source code for this article can be found on Github.
Lettuce is a redis client with reactive support. There is a super handy embedded redis for java project out there, and this kind of integration testing inside your service is worth its weight in gold, in my humble opinion. This post will detail how to merge both of these worlds together, and set up redis integration tests when you&#39;re using a lettuce client."
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-use-embedded-redis-to-test-a-lettuce-client-in-spring-boot-webflux/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        Home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        Blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        About me
      </a>
    </li>
    
    <li>
      <a href="/categories" class="">
        Categories
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How to use Embedded Redis to Test a Lettuce Client in Spring Boot Webflux</h2>

    <div class="meta">
      
      <time datetime="2021-03-27 21:22:32 &#43;0000 UTC" title='Sat, Mar 27, 2021, 9:22 PM UTC'>
        27/03/2021 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>The source code for this article <a href="https://github.com/nfisher23/reactive-programming-webflux/tree/master/reactive-redis">can be found on Github</a>.</p>
<p><a href="https://github.com/lettuce-io/lettuce-core">Lettuce</a> is a redis client with reactive support. There is a super handy <a href="https://github.com/kstyrc/embedded-redis">embedded redis for java project</a> out there, and this kind of integration testing inside your service is worth its weight in gold, in my humble opinion. This post will detail how to merge both of these worlds together, and set up redis integration tests when you're using a lettuce client.</p>
<p>You will want to start by ensuring that you add lettuce and embedded redis to your <strong>pom.xml</strong>[the config for gradle is analogous]:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        &amp;lt;dependency&amp;gt;
</span></span><span style="display:flex;"><span>            &amp;lt;groupId&amp;gt;org.projectlombok&amp;lt;/groupId&amp;gt;
</span></span><span style="display:flex;"><span>            &amp;lt;artifactId&amp;gt;lombok&amp;lt;/artifactId&amp;gt;
</span></span><span style="display:flex;"><span>            &amp;lt;version&amp;gt;1.18.20&amp;lt;/version&amp;gt;
</span></span><span style="display:flex;"><span>            &amp;lt;scope&amp;gt;provided&amp;lt;/scope&amp;gt;
</span></span><span style="display:flex;"><span>        &amp;lt;/dependency&amp;gt;
</span></span><span style="display:flex;"><span>        &amp;lt;dependency&amp;gt;
</span></span><span style="display:flex;"><span>            &amp;lt;groupId&amp;gt;io.lettuce&amp;lt;/groupId&amp;gt;
</span></span><span style="display:flex;"><span>            &amp;lt;artifactId&amp;gt;lettuce-core&amp;lt;/artifactId&amp;gt;
</span></span><span style="display:flex;"><span>            &amp;lt;version&amp;gt;6.1.0.RELEASE&amp;lt;/version&amp;gt;
</span></span><span style="display:flex;"><span>        &amp;lt;/dependency&amp;gt;
</span></span><span style="display:flex;"><span>        &amp;lt;dependency&amp;gt;
</span></span><span style="display:flex;"><span>            &amp;lt;groupId&amp;gt;com.github.kstyrc&amp;lt;/groupId&amp;gt;
</span></span><span style="display:flex;"><span>            &amp;lt;artifactId&amp;gt;embedded-redis&amp;lt;/artifactId&amp;gt;
</span></span><span style="display:flex;"><span>            &amp;lt;version&amp;gt;0.6&amp;lt;/version&amp;gt;
</span></span><span style="display:flex;"><span>            &amp;lt;scope&amp;gt;test&amp;lt;/scope&amp;gt;
</span></span><span style="display:flex;"><span>        &amp;lt;/dependency&amp;gt;
</span></span></code></pre></div><p>I also added lombok for convenience, as you can see.</p>
<p>Let's set up a skeleton class with a couple methods which, when implemented, will expose get and set operations for a client:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RedisDataService</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> RedisStringReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisStringReactiveCommands;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">RedisDataService</span>(RedisStringReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisStringReactiveCommands) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">redisStringReactiveCommands</span> <span style="color:#ff79c6">=</span> redisStringReactiveCommands;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;Void<span style="color:#ff79c6">&amp;</span>gt; writeThing(Thing thing) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> Mono.<span style="color:#50fa7b">empty</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;Thing<span style="color:#ff79c6">&amp;</span>gt; getThing(Integer id) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> Mono.<span style="color:#50fa7b">empty</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Where our <strong>Thing</strong> DTO is [note the lombok annotations generating code for us]:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Builder
</span></span><span style="display:flex;"><span>@Getter
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Thing</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> Integer id;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> String value;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now we can write an automated test to target the behavior that we're about to write:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RedisDataServiceTest</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> RedisServer redisServer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">getOpenPort</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd">int</span> port <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span>1;
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">try</span> (ServerSocket socket <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ServerSocket(0)) {
</span></span><span style="display:flex;"><span>                port <span style="color:#ff79c6">=</span> socket.<span style="color:#50fa7b">getLocalPort</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> port;
</span></span><span style="display:flex;"><span>        } <span style="color:#ff79c6">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> RuntimeException();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">int</span> port <span style="color:#ff79c6">=</span> getOpenPort();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> RedisDataService redisDataService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @BeforeAll
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setupRedisServer</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>        redisServer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> RedisServer(port);
</span></span><span style="display:flex;"><span>        redisServer.<span style="color:#50fa7b">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @BeforeEach
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setupRedisClient</span>() {
</span></span><span style="display:flex;"><span>        RedisClient redisClient <span style="color:#ff79c6">=</span> RedisClient.<span style="color:#50fa7b">create</span>(<span style="color:#ff79c6">&amp;</span>#34;redis:<span style="color:#6272a4">//localhost:&amp;#34; &amp;#43; port);</span>
</span></span><span style="display:flex;"><span>        redisDataService <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> RedisDataService(redisClient.<span style="color:#50fa7b">connect</span>().<span style="color:#50fa7b">reactive</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">canWriteAndReadThing</span>() {
</span></span><span style="display:flex;"><span>        Mono<span style="color:#ff79c6">&amp;</span>lt;Void<span style="color:#ff79c6">&amp;</span>gt; writeMono <span style="color:#ff79c6">=</span> redisDataService.<span style="color:#50fa7b">writeThing</span>(Thing.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">id</span>(1).<span style="color:#50fa7b">value</span>(<span style="color:#ff79c6">&amp;</span>#34;hello<span style="color:#ff79c6">-</span>redis<span style="color:#ff79c6">&amp;</span>#34;).<span style="color:#50fa7b">build</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(writeMono).<span style="color:#50fa7b">verifyComplete</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(redisDataService.<span style="color:#50fa7b">getThing</span>(1))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">expectNextMatches</span>(thing <span style="color:#ff79c6">-&amp;</span>gt;
</span></span><span style="display:flex;"><span>                    thing.<span style="color:#50fa7b">getId</span>() <span style="color:#ff79c6">==</span> 1 <span style="color:#ff79c6">&amp;</span>amp;<span style="color:#ff79c6">&amp;</span>amp;
</span></span><span style="display:flex;"><span>                        <span style="color:#ff79c6">&amp;</span>#34;hello<span style="color:#ff79c6">-</span>redis<span style="color:#ff79c6">&amp;</span>#34;.<span style="color:#50fa7b">equals</span>(thing.<span style="color:#50fa7b">getValue</span>())
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">verifyComplete</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @AfterAll
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">teardownRedisServer</span>() {
</span></span><span style="display:flex;"><span>        redisServer.<span style="color:#50fa7b">stop</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The framework for setting up embedded redis and testing it looks like so:</p>
<ol>
<li>Before the entire test class runs, we grab a random, free open port</li>
<li>We tell our embedded redis to start on that port</li>
<li>Before each test runs, we create a redis client and tell it to connect to that port</li>
<li>We pass in that redis client [ensuring it's reactive] to our class under test</li>
</ol>
<p>As far as the test itself, we are just persisting to and reading from redis and letting the service abstraction handle it for us. Obviously, since we've written no code yet, this will fail. To make it pass we can implement the code like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RedisDataService</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> RedisStringReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisStringReactiveCommands;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">RedisDataService</span>(RedisStringReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisStringReactiveCommands) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">redisStringReactiveCommands</span> <span style="color:#ff79c6">=</span> redisStringReactiveCommands;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;Void<span style="color:#ff79c6">&amp;</span>gt; writeThing(Thing thing) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">redisStringReactiveCommands</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">set</span>(thing.<span style="color:#50fa7b">getId</span>().<span style="color:#50fa7b">toString</span>(), thing.<span style="color:#50fa7b">getValue</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">then</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;Thing<span style="color:#ff79c6">&amp;</span>gt; getThing(Integer id) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">redisStringReactiveCommands</span>.<span style="color:#50fa7b">get</span>(id.<span style="color:#50fa7b">toString</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">map</span>(response <span style="color:#ff79c6">-&amp;</span>gt; Thing.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">id</span>(id).<span style="color:#50fa7b">value</span>(response).<span style="color:#50fa7b">build</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This code is pretty straightforward: write to redis using a simple key/value <strong>set</strong>, and read from redis using a key/value <strong>get</strong>. Once you get the value out of redis, throw it into a data structure for the client.</p>
<p>Remember to <a href="https://github.com/nfisher23/reactive-programming-webflux/tree/master/reactive-redis">check out the source code on Github</a>.</p>
</section>

  
    
  

    
  


  <footer>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
