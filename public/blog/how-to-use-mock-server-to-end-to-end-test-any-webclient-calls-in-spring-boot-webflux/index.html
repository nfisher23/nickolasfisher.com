<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How to use Mock Server to End to End Test Any WebClient Calls in Spring Boot Webflux</title>
<meta
  name="description"
  content="The source code for this post can be found on Github.
Mock Server is a really simple and straightforward way to actually let your application make downstream calls and intercept them. That level of abstraction is really nice to have, and gives at least me much more confidence that my code is actually working in a microservices environment."
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-use-mock-server-to-end-to-end-test-any-webclient-calls-in-spring-boot-webflux/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/img/nficon.png" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How to use Mock Server to End to End Test Any WebClient Calls in Spring Boot Webflux</h2>

    <div class="meta">
      
      <time datetime="2020-08-08 22:44:14 &#43;0000 UTC" title='Sat, Aug 8, 2020, 10:44 PM UTC'>
        08/08/2020 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>The source code for this post <a href="https://github.com/nfisher23/reactive-programming-webflux/tree/master/mocking-and-unit-testing">can be found on Github</a>.</p>
<p><a href="https://www.mock-server.com">Mock Server</a> is a really simple and straightforward way to actually let your application make downstream calls and intercept them. That level of abstraction is really nice to have, and gives at least me much more confidence that my code is actually working in a microservices environment.</p>
<p>There are a few different ways to <a href="https://www.mock-server.com/mock_server/running_mock_server.html">run MockServer with junit</a>, depending on the junit version and how much manual work you want to do. I&rsquo;ll go with the most portable setup for this tutorial.</p>
<h2 id="the-service-using-webclient">The Service, Using WebClient</h2>
<p>I&rsquo;m going to reuse code from my last blog post on <a href="https://nickolasfisher.com/blog/How-to-Mock-Dependencies-and-Unit-Test-in-Spring-Boot-Webflux">mocking dependencies and unit testing in webflux</a>. If you recall, we had a really simple service with basically no logic:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.nickolasfisher.testing.service;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.nickolasfisher.testing.dto.DownstreamResponseDTO;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.nickolasfisher.testing.dto.PersonDTO;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.stereotype.Service;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.web.reactive.function.client.WebClient;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> reactor.core.publisher.Flux;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Service
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MyService</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> WebClient webClient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">MyService</span>(WebClient webClient) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">webClient</span> <span style="color:#ff79c6">=</span> webClient;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Flux<span style="color:#ff79c6">&lt;</span>DownstreamResponseDTO<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">getAllPeople</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">webClient</span>.<span style="color:#50fa7b">get</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">uri</span>(<span style="color:#f1fa8c">&#34;/legacy/persons&#34;</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">retrieve</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">bodyToFlux</span>(DownstreamResponseDTO.<span style="color:#50fa7b">class</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>To write a test for this, let&rsquo;s first get mock server setting up properly. You will want to add the mock server dependency to your <strong>pom.xml</strong> if you&rsquo;re using maven, or your <strong>build.gradle</strong> if you&rsquo;re using gradle:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;groupId&gt;</span>org.mock-server<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;artifactId&gt;</span>mockserver-netty<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;version&gt;</span>5.11.1<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>And create the test class somewhere in <strong>src/test/&hellip;</strong>. We will start and stop mock server as boilerplate:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MyServiceTest</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> ClientAndServer mockServer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @BeforeEach
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setupMockServer</span>() {
</span></span><span style="display:flex;"><span>        mockServer <span style="color:#ff79c6">=</span> ClientAndServer.<span style="color:#50fa7b">startClientAndServer</span>(2001);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @AfterEach
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">tearDownServer</span>() {
</span></span><span style="display:flex;"><span>        mockServer.<span style="color:#50fa7b">stop</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I picked a static port in this case, but it&rsquo;s probably more robust to have java find you an available TCP port. Since we&rsquo;re using Spring Boot, you should check out <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/util/SocketUtils.html#findAvailableTcpPort">SocketUtils to find an available TCP port</a> for you.</p>
<p>There are two things we would want to assert in a happy path test: first, that we are actually making the request and second, we are deserializing the response properly and it is making it into the <strong>Flux</strong>. One way to do this is by forcing the downstream call to block for us:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MyServiceTest</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> ClientAndServer mockServer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> MyService myService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> ObjectMapper serializer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectMapper();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @BeforeEach
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setupMockServer</span>() {
</span></span><span style="display:flex;"><span>        mockServer <span style="color:#ff79c6">=</span> ClientAndServer.<span style="color:#50fa7b">startClientAndServer</span>(2001);
</span></span><span style="display:flex;"><span>        myService <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> MyService(WebClient.<span style="color:#50fa7b">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">baseUrl</span>(<span style="color:#f1fa8c">&#34;http://localhost:&#34;</span> <span style="color:#ff79c6">+</span> mockServer.<span style="color:#50fa7b">getLocalPort</span>()).<span style="color:#50fa7b">build</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @AfterEach
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">tearDownServer</span>() {
</span></span><span style="display:flex;"><span>        mockServer.<span style="color:#50fa7b">stop</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">testTheThing</span>() <span style="color:#8be9fd;font-style:italic">throws</span> JsonProcessingException {
</span></span><span style="display:flex;"><span>        String responseBody <span style="color:#ff79c6">=</span> getDownstreamResponseDTOAsString();
</span></span><span style="display:flex;"><span>        mockServer.<span style="color:#50fa7b">when</span>(
</span></span><span style="display:flex;"><span>                request()
</span></span><span style="display:flex;"><span>                    .<span style="color:#50fa7b">withMethod</span>(HttpMethod.<span style="color:#50fa7b">GET</span>.<span style="color:#50fa7b">name</span>())
</span></span><span style="display:flex;"><span>                    .<span style="color:#50fa7b">withPath</span>(<span style="color:#f1fa8c">&#34;/legacy/persons&#34;</span>)
</span></span><span style="display:flex;"><span>        ).<span style="color:#50fa7b">respond</span>(
</span></span><span style="display:flex;"><span>                response()
</span></span><span style="display:flex;"><span>                    .<span style="color:#50fa7b">withStatusCode</span>(HttpStatus.<span style="color:#50fa7b">OK</span>.<span style="color:#50fa7b">value</span>())
</span></span><span style="display:flex;"><span>                    .<span style="color:#50fa7b">withContentType</span>(MediaType.<span style="color:#50fa7b">APPLICATION_JSON</span>)
</span></span><span style="display:flex;"><span>                    .<span style="color:#50fa7b">withBody</span>(responseBody)
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        List<span style="color:#ff79c6">&lt;</span>DownstreamResponseDTO<span style="color:#ff79c6">&gt;</span> responses <span style="color:#ff79c6">=</span> myService.<span style="color:#50fa7b">getAllPeople</span>().<span style="color:#50fa7b">collectList</span>().<span style="color:#50fa7b">block</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        assertEquals(1, responses.<span style="color:#50fa7b">size</span>());
</span></span><span style="display:flex;"><span>        assertEquals(<span style="color:#f1fa8c">&#34;first&#34;</span>, responses.<span style="color:#50fa7b">get</span>(0).<span style="color:#50fa7b">getFirstName</span>());
</span></span><span style="display:flex;"><span>        assertEquals(<span style="color:#f1fa8c">&#34;last&#34;</span>, responses.<span style="color:#50fa7b">get</span>(0).<span style="color:#50fa7b">getLastName</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        mockServer.<span style="color:#50fa7b">verify</span>(
</span></span><span style="display:flex;"><span>                request().<span style="color:#50fa7b">withMethod</span>(HttpMethod.<span style="color:#50fa7b">GET</span>.<span style="color:#50fa7b">name</span>())
</span></span><span style="display:flex;"><span>                    .<span style="color:#50fa7b">withPath</span>(<span style="color:#f1fa8c">&#34;/legacy/persons&#34;</span>)
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> String <span style="color:#50fa7b">getDownstreamResponseDTOAsString</span>() <span style="color:#8be9fd;font-style:italic">throws</span> JsonProcessingException {
</span></span><span style="display:flex;"><span>        DownstreamResponseDTO downstreamResponseDTO <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DownstreamResponseDTO();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        downstreamResponseDTO.<span style="color:#50fa7b">setLastName</span>(<span style="color:#f1fa8c">&#34;last&#34;</span>);
</span></span><span style="display:flex;"><span>        downstreamResponseDTO.<span style="color:#50fa7b">setFirstName</span>(<span style="color:#f1fa8c">&#34;first&#34;</span>);
</span></span><span style="display:flex;"><span>        downstreamResponseDTO.<span style="color:#50fa7b">setSsn</span>(<span style="color:#f1fa8c">&#34;123-12-1231&#34;</span>);
</span></span><span style="display:flex;"><span>        downstreamResponseDTO.<span style="color:#50fa7b">setDeepesetFear</span>(<span style="color:#f1fa8c">&#34;alligators&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> serializer.<span style="color:#50fa7b">writeValueAsString</span>(Arrays.<span style="color:#50fa7b">asList</span>(downstreamResponseDTO));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We are verifying that at least part of the response got loaded into our POJO properly with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>assertEquals(1, responses.<span style="color:#50fa7b">size</span>());
</span></span><span style="display:flex;"><span>assertEquals(<span style="color:#f1fa8c">&#34;first&#34;</span>, responses.<span style="color:#50fa7b">get</span>(0).<span style="color:#50fa7b">getFirstName</span>());
</span></span><span style="display:flex;"><span>assertEquals(<span style="color:#f1fa8c">&#34;last&#34;</span>, responses.<span style="color:#50fa7b">get</span>(0).<span style="color:#50fa7b">getLastName</span>());
</span></span></code></pre></div><p>And we are verifying the request was made with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>mockServer.<span style="color:#50fa7b">verify</span>(
</span></span><span style="display:flex;"><span>        request().<span style="color:#50fa7b">withMethod</span>(HttpMethod.<span style="color:#50fa7b">GET</span>.<span style="color:#50fa7b">name</span>())
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">withPath</span>(<span style="color:#f1fa8c">&#34;/legacy/persons&#34;</span>)
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>Note that you would never want to use those blocking methods in any production code, but for testing it helps simplify our life and gives us a high degree of confidence we are doing things properly.</p>
<p>As a reminder, you can <a href="https://github.com/nfisher23/reactive-programming-webflux/tree/master/mocking-and-unit-testing">checkout and use this code on Github</a>.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/java/" alt="Java">
          Java
        </a>
      
        <a href="/tags/spring/" alt="Spring">
          Spring
        </a>
      
        <a href="/tags/reactive/" alt="Reactive">
          Reactive
        </a>
      
        <a href="/tags/testing/" alt="Testing">
          Testing
        </a>
      
        <a href="/tags/webflux/" alt="Webflux">
          Webflux
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
