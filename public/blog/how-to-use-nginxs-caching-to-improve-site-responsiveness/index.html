<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How to Use Nginx&#39;s Caching to Improve Site Responsiveness</title>
<meta
  name="description"
  content="The source code for this post can be found on Github.
In my last post, I provided an example for how to set up an Nginx Reverse Proxy for a Spring MVC application. One such reason to set up a reverse proxy is to utilize caching of resources. If you have dynamically generated content that doesn&rsquo;t change very often, then adding caching at the site entry point can dramatically improve site responsiveness and reduce load on critical resources."
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-use-nginxs-caching-to-improve-site-responsiveness/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/img/nficon.png" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How to Use Nginx&#39;s Caching to Improve Site Responsiveness</h2>

    <div class="meta">
      
      <time datetime="2019-04-06 17:14:30 &#43;0000 UTC" title='Sat, Apr 6, 2019, 5:14 PM UTC'>
        06/04/2019 - Estimated reading time: 4 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>The source code for this post <a href="https://github.com/nfisher23/some-ansible-examples/tree/master/reverse-proxy-nginx">can be found on Github</a>.</p>
<p>In my last post, I provided an example for <a href="https://nickolasfisher.com/blog/How-to-Deploy-a-Spring-MVC-Application-Behind-an-Nginx-Reverse-Proxy">how to set up an Nginx Reverse Proxy for a Spring MVC application</a>. One such reason to set up a reverse proxy is to utilize caching of resources. If you have dynamically generated content that doesn&rsquo;t change very often, then adding caching at the site entry point can dramatically improve site responsiveness and reduce load on critical resources.</p>
<p>You will want to be sure to have a good background in setting up a reverse proxy with nginx to get the most out of this post, and I will be building on the work that was done in the last post.</p>
<h3 id="simulating-a-long-running-process">Simulating a Long Running Process</h3>
<p>First, we&rsquo;ll add an endpoint in our Spring MVC application that simulates taking a long time to get a result. Maybe the database is overwhelmed, or maybe a GC process stops the world more often than we would like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.nickolasfisher.simplemvc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.http.HttpStatus;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.http.ResponseEntity;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.stereotype.Controller;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.web.bind.annotation.GetMapping;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Controller
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">SimpleController</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#f1fa8c">&#34;/slow&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> ResponseEntity<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">slowEndpoint</span>() <span style="color:#8be9fd;font-style:italic">throws</span> InterruptedException {
</span></span><span style="display:flex;"><span>        Thread.<span style="color:#50fa7b">sleep</span>(2500);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> ResponseEntity<span style="color:#ff79c6">&lt;&gt;</span>(<span style="color:#f1fa8c">&#34;&lt;p&gt;Well... that took awhile&lt;/p&gt;&#34;</span>, HttpStatus.<span style="color:#50fa7b">ACCEPTED</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @GetMapping(<span style="color:#f1fa8c">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> ResponseEntity<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">simpleResponder</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> ResponseEntity<span style="color:#ff79c6">&lt;&gt;</span>(<span style="color:#f1fa8c">&#34;&lt;h1&gt;Welcome to my site!&lt;/h1&gt;&#34;</span>, HttpStatus.<span style="color:#50fa7b">ACCEPTED</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here, when we hit the /slow endpoint, it will take 2.5 seconds to get a response&ndash;an eternity on the internet. That represents ~25% loss in revenue for Amazon, should its site load that slowly.</p>
<p>If you run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule create &amp;amp;&amp;amp; molecule converge
</span></span></code></pre></div><p>And request <a href="http://192.168.56.202/slow,">http://192.168.56.202/slow,</a> you will see it in action. Moreover, it will take 2.5 seconds <em>every time</em>, despite the fact that the content is not changing. This is a perfect candidate for a caching layer.</p>
<h3 id="set-up-the-cache-in-nginx">Set up the Cache in Nginx</h3>
<p>Setting up a cache is relatively straightforward. We can specify a cache with <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path">proxy_cache_path</a>. Some common parameters are max_size, levels, and the use_temp_path flag. <strong>use_temp_path</strong> should be set to <strong>off</strong>, or else there will be an unnecessary intermediate step where nginx copies files.</p>
<p>I&rsquo;ll declare a proxy_cache_path above the server block in our <strong>server.conf.j2</strong> Jinja2 template for our <strong>nginx role</strong>, which is called as a dependency in the reverse-proxy-nginx role. I will add some parameters, including a way to easily turn off the cache with a <strong>nginx_use_cache</strong> flag:</p>
<pre tabindex="0"><code>{% if nginx_use_cache %}
proxy_cache_path {{ nginx_cache_path }} levels=1:2 keys_zone={{ nginx_cache_name }}:10m max_size=10g
                 inactive=60m use_temp_path=off;
{% endif %}

server {
    ...server block...
}
</code></pre><p>Add the variables to the <strong>nginx/vars/main.yml</strong> file so it looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># vars file for nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">app_port</span>: <span style="color:#bd93f9">8080</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">site_alias</span>: my-site
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">remove_nginx_defaults</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">nginx_cache_path</span>: /etc/nginx/cache
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">nginx_cache_name</span>: my_cache
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">nginx_use_cache</span>: <span style="color:#ff79c6">true</span>
</span></span></code></pre></div><p>If you deploy this now, the parsed nginx conf file will result in a proxy_cache_path declaration looking like:</p>
<pre tabindex="0"><code>proxy_cache_path /etc/nginx/cache levels=1:2 keys_zone=my_cache:10m max_size=10g
                 inactive=60m use_temp_path=off;
</code></pre><p>However, nothing will change yet&ndash;the slow endpoint will still take 2.5 seconds, because we aren&rsquo;t using the cache yet. To start using it, we have to declare the cache in the location block, then specify how long we want it to be valid for. In our case, we will also have to ensure that the proxy_cache_bypass declaration is not in place. Because Nginx, by default, honors the Cache-Control header (which is usually used to specify that the client wants the newest version of this resource) and <em>we know the content has not changed,</em> we will also tell Nginx to ignore the Cache-Control header. Our <strong>server.conf.j2</strong> file in the nginx role can finally look like:</p>
<pre tabindex="0"><code>{% if nginx_use_cache %}
proxy_cache_path {{ nginx_cache_path }} levels=1:2 keys_zone={{ nginx_cache_name }}:10m max_size=10g
                 inactive=60m use_temp_path=off;
{% endif %}

server {
    location / {
{% if nginx_use_cache %}
        proxy_cache {{ nginx_cache_name }};
        proxy_ignore_headers Cache-Control;
        proxy_cache_valid any 60s;

{% endif %}
        proxy_pass http://localhost:{{ app_port }};
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $http_host;
{% if not nginx_use_cache %}
        proxy_cache_bypass $http_upgrade;
{% endif %}
    }
}
</code></pre><p>When you run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ molecule converge
</span></span></code></pre></div><p>You should now see the parsed Jinja file looking like:</p>
<pre tabindex="0"><code>proxy_cache_path /etc/nginx/cache levels=1:2 keys_zone=my_cache:10m max_size=10g
                 inactive=60m use_temp_path=off;

server {
    location / {
        proxy_cache my_cache;
        proxy_cache_valid any 60s;

        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $http_host;
    }
}
</code></pre><p>And, most importantly, the <a href="http:/192.168.56.202/slow">http:/192.168.56.202/slow</a> endpoint gets cached. The first time will take 2.5 seconds, but every subsequent request takes about 1ms (on my machine). The cache, in the way we have configured it, is valid for 60 seconds, then will invalidate itself.</p>
<p>Some further reading:</p>
<ul>
<li><a href="https://docs.nginx.com/nginx/admin-guide/content-cache/content-caching/">NGINX Content Caching</a></li>
<li><a href="https://www.nginx.com/blog/nginx-caching-guide/">A Guide to Caching with NGINX and NGINX Plus</a></li>
</ul>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/java/" alt="Java">
          Java
        </a>
      
        <a href="/tags/ngnix/" alt="Ngnix">
          Ngnix
        </a>
      
        <a href="/tags/vagrant/" alt="Vagrant">
          Vagrant
        </a>
      
        <a href="/tags/ansible/" alt="Ansible">
          Ansible
        </a>
      
        <a href="/tags/spring/" alt="Spring">
          Spring
        </a>
      
        <a href="/tags/devops/" alt="DevOps">
          DevOps
        </a>
      
        <a href="/tags/maven/" alt="Maven">
          Maven
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
