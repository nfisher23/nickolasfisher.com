<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>How to use Optimistic Locking in DynamoDB via the AWS CLI</title>
<meta
  name="description"
  content="Optimistic Locking is a form of concurrency control that basically aims to prevent two different threads from accidentally overwriting data that another thread has already written. I covered optimistic locking in MySQL in a previous blog post, which may or may not be easier to understand based on your background."
/>
<link rel="canonical" href="http://localhost:1313/blog/how-to-use-optimistic-locking-in-dynamodb-via-the-aws-cli/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/img/nficon.png" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">How to use Optimistic Locking in DynamoDB via the AWS CLI</h2>

    <div class="meta">
      
      <time datetime="2020-08-01 20:46:28 &#43;0000 UTC" title='Sat, Aug 1, 2020, 8:46 PM UTC'>
        01/08/2020 - Estimated reading time: 4 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>Optimistic Locking is a form of concurrency control that basically aims to prevent two different threads from accidentally overwriting data that another thread has already written. I covered <a href="https://nickolasfisher.com/blog/Optimistic-Locking-in-MySQLExplain-Like-Im-Five">optimistic locking in MySQL</a> in a previous blog post, which may or may not be easier to understand based on your background.</p>
<p>DynamoDB offers <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.ConditionExpressions.html">conditional expressions</a> that can fulfill the same purpose for us here. I&rsquo;ll demonstrate an example that should fill the gap for most common use cases.</p>
<h2 id="setup-local-environment-and-data">Setup Local Environment And Data</h2>
<p>Here&rsquo;s a dynamo local container in a docker compose file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ff79c6">version</span>: <span style="color:#f1fa8c">&#39;3.7&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">dynamodb-local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">image</span>: amazon/dynamodb-local
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">container_name</span>: dynamodb-local
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f1fa8c">&#34;8000:8000&#34;</span>
</span></span></code></pre></div><p>Start this up with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker-compose up -d
</span></span></code></pre></div><p>If you do not have any valid AWS credentials on your local, you will have to set some fake ones or the CLI will complain:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">AWS_SECRET_ACCESS_KEY</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;FAKE&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">export</span> <span style="color:#8be9fd;font-style:italic">AWS_ACCESS_KEY_ID</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;FAKE&#34;</span>
</span></span></code></pre></div><p>Now we&rsquo;ll create a table for the purposes of this tutorial, then create a sample record to work with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span>aws --endpoint-url http://localhost:8000 --region<span style="color:#ff79c6">=</span>us-west-2 dynamodb create-table <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --billing-mode PAY_PER_REQUEST <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --table-name Phones <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --attribute-definitions <span style="color:#8be9fd;font-style:italic">AttributeName</span><span style="color:#ff79c6">=</span>Company,AttributeType<span style="color:#ff79c6">=</span>S <span style="color:#8be9fd;font-style:italic">AttributeName</span><span style="color:#ff79c6">=</span>Model,AttributeType<span style="color:#ff79c6">=</span>S <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>  --key-schema <span style="color:#8be9fd;font-style:italic">AttributeName</span><span style="color:#ff79c6">=</span>Company,KeyType<span style="color:#ff79c6">=</span>HASH <span style="color:#8be9fd;font-style:italic">AttributeName</span><span style="color:#ff79c6">=</span>Model,KeyType<span style="color:#ff79c6">=</span>RANGE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">FULL_ITEM_TEMPLATE</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>cat <span style="color:#f1fa8c">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">{
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Company&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;S&#34;: &#34;%s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    },
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Model&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;S&#34;: &#34;%s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    },
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Colors&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;SS&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            &#34;Green&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            &#34;Blue&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            &#34;Orange&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        ]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    },
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Size&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;N&#34;: &#34;%s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    },
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Version&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;N&#34;: &#34;%s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">}
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>put_dynamo_local<span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">ITEM</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$1</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span>    aws --endpoint-url http://localhost:8000 --region<span style="color:#ff79c6">=</span>us-west-2 dynamodb put-item <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>      --table-name Phones <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>      --item <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$ITEM</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">MOTO_COOL</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">printf</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$FULL_ITEM_TEMPLATE</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">&#34;Motorola&#34;</span> <span style="color:#f1fa8c">&#34;Cool Phone&#34;</span> <span style="color:#f1fa8c">&#34;12&#34;</span> <span style="color:#f1fa8c">&#34;1&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>put_dynamo_local <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$MOTO_COOL</span><span style="color:#f1fa8c">&#34;</span>
</span></span></code></pre></div><p>We have created a table called <strong>Phones</strong>. This table has a partition key of <strong>Company</strong> and a range key of <strong>Model</strong>. We placed one item in this table. Critically, this
item has an attribute named <strong>Version</strong>. We will use this version attribute in the same way we use it in MySQL to accomplish our goals here.</p>
<h2 id="using-update-item">Using update-item</h2>
<p>The first operation we can demonstrate conditional updates on is <a href="https://docs.aws.amazon.com/cli/latest/reference/dynamodb/update-item.html">update-item</a>. This doesn&rsquo;t replace the entry in its entirety, but is rather meant to be used to operate on specific attributes in your item. For example, we can just execute a non-conditional update by setting the size on our record to be 100:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">KEY_TEMPLATE</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>cat <span style="color:#f1fa8c">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">{
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Company&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;S&#34;: &#34;%s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    },
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Model&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;S&#34;: &#34;%s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">}
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">MOTO_COOL_KEY</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">printf</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$KEY_TEMPLATE</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">&#34;Motorola&#34;</span> <span style="color:#f1fa8c">&#34;Cool Phone&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">SIZE_EXP_ATTR_VAL_TEMPLATE</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>cat <span style="color:#f1fa8c">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">{
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;:size&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;S&#34;: &#34;%s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">}
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">SIZE_100</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">printf</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$SIZE_EXP_ATTR_VAL_TEMPLATE</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">&#34;100&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>aws --endpoint-url http://localhost:8000 --region<span style="color:#ff79c6">=</span>us-west-2 dynamodb update-item <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --table-name Phones <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --key <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$MOTO_COOL_KEY</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --update-expression <span style="color:#f1fa8c">&#34;SET Size = :size&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --expression-attribute-values <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$SIZE_100</span><span style="color:#f1fa8c">&#34;</span>
</span></span></code></pre></div><p>If we now query for the record then we will see our changes reflected. Here&rsquo;s a script I&rsquo;ve called <strong>query.sh</strong>, which you can use to verify changes at any point during this tutorial:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">EQ_TEMPLATE</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>cat <span style="color:#f1fa8c">&lt;&lt;&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">{
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Company&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;AttributeValueList&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">                &#34;S&#34;: &#34;%s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        ],
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;ComparisonOperator&#34;: &#34;EQ&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    },
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;Model&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;AttributeValueList&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">                &#34;S&#34;: &#34;%s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        ],
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;ComparisonOperator&#34;: &#34;EQ&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">}
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>query_local_dynamo<span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">ITEM</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">$1</span>
</span></span><span style="display:flex;"><span>    aws --endpoint-url http://localhost:8000 --region<span style="color:#ff79c6">=</span>us-west-2 dynamodb query <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>      --table-name Phones <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>      --key-conditions <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$ITEM</span><span style="color:#f1fa8c">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">MOTO_COOL</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">printf</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$EQ_TEMPLATE</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">&#34;Motorola&#34;</span> <span style="color:#f1fa8c">&#34;Cool Phone&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>query_local_dynamo <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$MOTO_COOL</span><span style="color:#f1fa8c">&#34;</span>
</span></span></code></pre></div><p>After the operations above, if you run <strong>query.sh</strong>, you should see this returned to you:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;Items&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&#34;Model&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&#34;S&#34;</span>: <span style="color:#f1fa8c">&#34;Cool Phone&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&#34;Company&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&#34;S&#34;</span>: <span style="color:#f1fa8c">&#34;Motorola&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&#34;Colors&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&#34;SS&#34;</span>: [
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">&#34;Blue&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">&#34;Green&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">&#34;Orange&#34;</span>
</span></span><span style="display:flex;"><span>                ]
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&#34;Version&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&#34;N&#34;</span>: <span style="color:#f1fa8c">&#34;2&#34;</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&#34;Size&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&#34;S&#34;</span>: <span style="color:#f1fa8c">&#34;200&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;Count&#34;</span>: <span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;ScannedCount&#34;</span>: <span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&#34;ConsumedCapacity&#34;</span>: <span style="color:#ff79c6">null</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can add a <strong>condition-expression</strong> to update only when our passed in condition is true. In our case, we want to both increment the version and make sure that the current version is what we assume it is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">SIZE_CURR_VERSION_TEMPLATE</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>cat <span style="color:#f1fa8c">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">{
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;:size&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;S&#34;: &#34;%s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    },
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;:curr_version&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;N&#34;: &#34;%s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    },
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#34;:new_version&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        &#34;N&#34;: &#34;%s&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">}
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># update size to 200 if version is 1, also increment version to 2</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">SIZE_200</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">printf</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$SIZE_CURR_VERSION_TEMPLATE</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">&#34;200&#34;</span> <span style="color:#f1fa8c">&#34;1&#34;</span> <span style="color:#f1fa8c">&#34;2&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>aws --endpoint-url http://localhost:8000 --region<span style="color:#ff79c6">=</span>us-west-2 dynamodb update-item <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --table-name Phones <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --key <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$MOTO_COOL_KEY</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --update-expression <span style="color:#f1fa8c">&#34;SET Size = :size, Version = :new_version&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --condition-expression <span style="color:#f1fa8c">&#34;Version = :curr_version&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --expression-attribute-values <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$SIZE_200</span><span style="color:#f1fa8c">&#34;</span>
</span></span></code></pre></div><p>You should see this reflected if you query dynamo using the script above.</p>
<p>To prove that it actually fails when it should fail, we can try to set the size to 300, but only if the version is 1. If you ran the code from above you should see this fail:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4"># ..someone else is trying to update size to 300 if the version is 1, also trying to set to version 2, fails!</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">SIZE_300</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span><span style="color:#8be9fd;font-style:italic">printf</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$SIZE_CURR_VERSION_TEMPLATE</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">&#34;300&#34;</span> <span style="color:#f1fa8c">&#34;1&#34;</span> <span style="color:#f1fa8c">&#34;2&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>aws --endpoint-url http://localhost:8000 --region<span style="color:#ff79c6">=</span>us-west-2 dynamodb update-item <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --table-name Phones <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --key <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$MOTO_COOL_KEY</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --update-expression <span style="color:#f1fa8c">&#34;SET Size = :size, Version = :new_version&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --condition-expression <span style="color:#f1fa8c">&#34;Version = :curr_version&#34;</span> <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>    --expression-attribute-values <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">$SIZE_300</span><span style="color:#f1fa8c">&#34;</span>
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>An error occurred <span style="color:#ff79c6">(</span>ConditionalCheckFailedException<span style="color:#ff79c6">)</span> when calling the UpdateItem operation: The conditional request failed
</span></span></code></pre></div><p>If you run the query, you will also see that the size is still 200 while the version remains at 2.</p>
<p>You will notice that this <strong>&ndash;condition-expression</strong> is also a parameter option on the <strong>put-item</strong> operation, thus this pattern will work for the two most common operations against a dynamo item.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/bash/" alt="Bash">
          Bash
        </a>
      
        <a href="/tags/devops/" alt="DevOps">
          DevOps
        </a>
      
        <a href="/tags/aws/" alt="Aws">
          Aws
        </a>
      
        <a href="/tags/dynamodb/" alt="Dynamodb">
          Dynamodb
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
