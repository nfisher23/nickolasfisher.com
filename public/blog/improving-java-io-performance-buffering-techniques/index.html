<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Improving Java IO Performance: Buffering Techniques </title>
<meta
  name="description"
  content="﻿You can view the sample code associated with this post on GitHub.
Now that we know how to benchmark using junit and jmh, let&#39;s put it to the test and try to optimize some basic I/O operations. While filesystem tasks are much less common in the web-enabled world, understanding the basics can help us when we move on to streams across network connections."
/>
<link rel="canonical" href="http://localhost:1313/blog/improving-java-io-performance-buffering-techniques/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">Improving Java IO Performance: Buffering Techniques </h2>

    <div class="meta">
      
      <time datetime="2018-11-10 12:45:54 &#43;0000 UTC" title='Sat, Nov 10, 2018, 12:45 PM UTC'>
        10/11/2018 - Estimated reading time: 4 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>﻿You can view the sample code associated with this post <a href="https://github.com/nfisher23/io-tuning">on GitHub</a>.</p>
<p>Now that we know <a href="https://nickolasfisher.com/blog/How-to-Benchmark-Java-Code-Using-JUnit-and-JMH">how to benchmark using junit and jmh</a>, let's put it to the test and try to optimize some basic I/O operations. While filesystem tasks are much less common in the web-enabled world, understanding the basics can help us when we move on to streams across network connections.</p>
<p>First, we'll create a file to read from. I opt to make a comma separated variable (csv) file that has 10,000 lines of 1,2,3&hellip;,8,9:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> String pathToResources <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>#34;src<span style="color:#ff79c6">/</span>test<span style="color:#ff79c6">/</span>resources<span style="color:#ff79c6">&amp;</span>#34;;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> String csvFilePath <span style="color:#ff79c6">=</span> pathToResources <span style="color:#ff79c6">&amp;</span>#43; <span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">/</span>simple<span style="color:#ff79c6">-</span>csv<span style="color:#ff79c6">-</span>file.<span style="color:#50fa7b">csv</span><span style="color:#ff79c6">&amp;</span>#34;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> numberOfNewlines <span style="color:#ff79c6">=</span> 10000;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Before
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setupFile</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    Path csvPathAsPath <span style="color:#ff79c6">=</span> Paths.<span style="color:#50fa7b">get</span>(csvFilePath);
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// run once to create the sample data we need for testing</span>
</span></span><span style="display:flex;"><span>    StringBuilder builder <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0; i <span style="color:#ff79c6">&amp;</span>lt; numberOfNewlines; i<span style="color:#ff79c6">&amp;</span>#43;<span style="color:#ff79c6">&amp;</span>#43;) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> j <span style="color:#ff79c6">=</span> 0; j <span style="color:#ff79c6">&amp;</span>lt; 10; j<span style="color:#ff79c6">&amp;</span>#43;<span style="color:#ff79c6">&amp;</span>#43;) {
</span></span><span style="display:flex;"><span>            builder.<span style="color:#50fa7b">append</span>(Integer.<span style="color:#50fa7b">toString</span>(j)).<span style="color:#50fa7b">append</span>(<span style="color:#ff79c6">&amp;</span>#34;,<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        builder.<span style="color:#50fa7b">replace</span>(builder.<span style="color:#50fa7b">length</span>() <span style="color:#ff79c6">-</span> 1, builder.<span style="color:#50fa7b">length</span>(), <span style="color:#ff79c6">&amp;</span>#34;\n<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    String csvDataToWrite <span style="color:#ff79c6">=</span> builder.<span style="color:#50fa7b">toString</span>();
</span></span><span style="display:flex;"><span>    Files.<span style="color:#50fa7b">write</span>(csvPathAsPath, csvDataToWrite.<span style="color:#50fa7b">getBytes</span>());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Then we have to configure the options we want to run the tests under, and put it inside a JUnit test so that it runs on build time:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">launchBenchmark</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    Options opt﻿ions <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> OptionsBuilder()
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">include</span>(<span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">getClass</span>().<span style="color:#50fa7b">getName</span>() <span style="color:#ff79c6">&amp;</span>#43; <span style="color:#ff79c6">&amp;</span>#34;.<span style="color:#ff79c6">*&amp;</span>#34;)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">mode</span>(Mode.<span style="color:#50fa7b">AverageTime</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">warmupTime</span>(TimeValue.<span style="color:#50fa7b">seconds</span>(1))
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">warmupIterations</span>(2)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">measurementIterations</span>(2)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">measurementTime</span>(TimeValue.<span style="color:#50fa7b">seconds</span>(1))
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4">// since we are doing read input, which is an</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4">// OS bottleneck, we have to ensure</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4">// we use one thread at a time</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">threads</span>(1)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">forks</span>(1)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">shouldFailOnError</span>(<span style="color:#ff79c6">true</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">shouldDoGC</span>(<span style="color:#ff79c6">true</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">build</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">new</span> Runner(options).<span style="color:#50fa7b">run</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now for some theory. As it turns out, when we ask for bytes from the file system, under the hood Java is asking the operating system to perform the action for us. Since OS's control files, it's not possible for Java to act any other way.</p>
<p>When we ask for bytes from the OS, it's a fairly expensive operation end to end. That is, it's expensive to <em>start</em> asking for bytes, but it's not expensive <em>while</em> we are asking for bytes. From this idea, buffering was born. Buffering is basically picking up a chunk of bytes at one time from the operating system rather than asking for one at a time, which is (in theory) much slower if you want to read a bunch of bytes.</p>
<p>This benchmarked-method asks the OS to get us a byte with each call to <code>read()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Benchmark
</span></span><span style="display:flex;"><span>@OutputTimeUnit(TimeUnit.<span style="color:#50fa7b">MILLISECONDS</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">noBuffering</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> (FileInputStream fileInputStream <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> FileInputStream(csvFilePath)) {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> count <span style="color:#ff79c6">=</span> countNewLinesUsingStream(fileInputStream);
</span></span><span style="display:flex;"><span>        assertEquals(numberOfNewlines, count);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">countNewLinesUsingStream</span>(InputStream inputStream) <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> count <span style="color:#ff79c6">=</span> 0;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> bytesRead;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">while</span> ((bytesRead <span style="color:#ff79c6">=</span> inputStream.<span style="color:#50fa7b">read</span>()) <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">-</span>1) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (bytesRead <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">&amp;</span>#39;\n<span style="color:#ff79c6">&amp;</span>#39;) {
</span></span><span style="display:flex;"><span>            count<span style="color:#ff79c6">&amp;</span>#43;<span style="color:#ff79c6">&amp;</span>#43;;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> count;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The output on the benchmark on my machine from this method is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Benchmark                                      Mode  Cnt    Score   Error  Units
</span></span><span style="display:flex;"><span>BufferingBenchmarkTests.noBuffering            avgt    <span style="color:#bd93f9">2</span>  170.308          ms/op
</span></span></code></pre></div><p>So on two tries (after the warmups) we averaged 170 milliseconds per try. Now we will use Java's built in BufferedInputStream:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Benchmark
</span></span><span style="display:flex;"><span>@OutputTimeUnit(TimeUnit.<span style="color:#50fa7b">MILLISECONDS</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">defaultJavaBuffering</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> (FileInputStream fileInputStream <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> FileInputStream(csvFilePath);
</span></span><span style="display:flex;"><span>            BufferedInputStream bufferedInputStream <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> BufferedInputStream(fileInputStream)) {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> count <span style="color:#ff79c6">=</span> countNewLinesUsingStream(bufferedInputStream);
</span></span><span style="display:flex;"><span>        assertEquals(numberOfNewlines, count);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The benchmark output on my machine is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Benchmark                                      Mode  Cnt    Score   Error  Units
</span></span><span style="display:flex;"><span>BufferingBenchmarkTests.defaultJavaBuffering   avgt    <span style="color:#bd93f9">2</span>    0.693          ms/op
</span></span></code></pre></div><p>So, by just adding a line of code (which automatically loads a chunk&ndash;8192 bytes as of this writing&ndash;of bytes at a time), we have increased our performance by ~245 times. Pretty crazy, but we can do even better. We can implement our own custom buffering code, which uses an array to store the buffered bytes in memory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Benchmark
</span></span><span style="display:flex;"><span>@OutputTimeUnit(TimeUnit.<span style="color:#50fa7b">MILLISECONDS</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">manualBufferingInCode</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> (FileInputStream fileInputStream <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> FileInputStream(csvFilePath)) {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> count <span style="color:#ff79c6">=</span> countNewLinesManually(fileInputStream, 8192);
</span></span><span style="display:flex;"><span>        assertEquals(numberOfNewlines, count);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">countNewLinesManually</span>(InputStream inputStream, <span style="color:#8be9fd">int</span> customBytesToBuffer) <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">byte</span> buff<span style="color:#ff79c6">[]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span>customBytesToBuffer<span style="color:#ff79c6">]</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> count <span style="color:#ff79c6">=</span> 0;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> bytesRead;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">while</span> ((bytesRead <span style="color:#ff79c6">=</span> inputStream.<span style="color:#50fa7b">read</span>(buff)) <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">-</span>1) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0; i <span style="color:#ff79c6">&amp;</span>lt; bytesRead; i<span style="color:#ff79c6">&amp;</span>#43;<span style="color:#ff79c6">&amp;</span>#43;) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> (buff<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">&amp;</span>#39;\n<span style="color:#ff79c6">&amp;</span>#39;) {
</span></span><span style="display:flex;"><span>                count<span style="color:#ff79c6">&amp;</span>#43;<span style="color:#ff79c6">&amp;</span>#43;;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> count;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The benchmark results are:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Benchmark                                      Mode  Cnt    Score   Error  Units
</span></span><span style="display:flex;"><span>BufferingBenchmarkTests.manualBufferingInCode  avgt    <span style="color:#bd93f9">2</span>    0.148          ms/op
</span></span></code></pre></div><p>Or a ~4.5 times performance improvement over our previous improvement, despite the fact that we used the same buffer size as is the default as of this writing (8192 bytes). We can try to make it even faster, though the results vary from machine to machine, by insisting that the buffer size be the size of the file. The obvious potential problem with this approach is that the file could be larger than the amount of available resources, which would seriously gum up the works:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Benchmark
</span></span><span style="display:flex;"><span>@OutputTimeUnit(TimeUnit.<span style="color:#50fa7b">MILLISECONDS</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">useFileSizeAsBuffer</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> lengthOfFile <span style="color:#ff79c6">=</span> (<span style="color:#8be9fd">int</span>)(<span style="color:#ff79c6">new</span> File(csvFilePath).<span style="color:#50fa7b">length</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> (FileInputStream fileInputStream <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> FileInputStream(csvFilePath)) {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> count <span style="color:#ff79c6">=</span> countNewLinesManually(fileInputStream,lengthOfFile);
</span></span><span style="display:flex;"><span>        assertEquals(numberOfNewlines, count);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The results of all these operations taken together, on my machine, look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Benchmark                                      Mode  Cnt    Score   Error  Units
</span></span><span style="display:flex;"><span>BufferingBenchmarkTests.defaultJavaBuffering   avgt    <span style="color:#bd93f9">2</span>    0.693          ms/op
</span></span><span style="display:flex;"><span>BufferingBenchmarkTests.manualBufferingInCode  avgt    <span style="color:#bd93f9">2</span>    0.148          ms/op
</span></span><span style="display:flex;"><span>BufferingBenchmarkTests.noBuffering            avgt    <span style="color:#bd93f9">2</span>  170.308          ms/op
</span></span><span style="display:flex;"><span>BufferingBenchmarkTests.useFileSizeAsBuffer    avgt    <span style="color:#bd93f9">2</span>    0.188          ms/op
</span></span></code></pre></div></section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/java/" alt="Java">
          Java
        </a>
      
        <a href="/tags/i/o/" alt="I/O">
          I/O
        </a>
      
        <a href="/tags/performance-testing/" alt="Performance Testing">
          Performance Testing
        </a>
      
        <a href="/tags/jmh/" alt="Jmh">
          Jmh
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
