<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>In-Memory Caching in Sprint Boot Webflux/Project Reactor</title>
<meta
  name="description"
  content="Sample code for this article can be found on Github.
In memory caching can significantly improve performance in a microservices environment, usually because of the tail latency involved in calling downstream services. Caching can also help with resilience, though the extent to which that matters will depend on how you&#39;re actually leveraging that caching. There are two flavors of caching that you&#39;re like to want to use, the first is using the Mono as a hot source [which is demonstrated here], and the second would be when you want to selectively cache individual key/value pairs."
/>
<link rel="canonical" href="http://localhost:1313/blog/inmemory-caching-in-sprint-boot-webfluxproject-reactor/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">In-Memory Caching in Sprint Boot Webflux/Project Reactor</h2>

    <div class="meta">
      
      <time datetime="2020-10-03 22:41:59 &#43;0000 UTC" title='Sat, Oct 3, 2020, 10:41 PM UTC'>
        03/10/2020 - Estimated reading time: 4 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>Sample code for this article <a href="https://github.com/nfisher23/reactive-programming-webflux/tree/master/api-calls-and-resilience">can be found on Github</a>.</p>
<p>In memory caching can significantly improve performance in a microservices environment, usually because of the tail latency involved in calling downstream services. Caching can also <em>help</em> with resilience, though the extent to which that matters will depend on how you're actually leveraging that caching. There are two flavors of caching that you're like to want to use, the first is using the Mono as a hot source [which is demonstrated here], and the second would be when you want to <a href="https://nickolasfisher.com/blog/How-to-use-Caffeine-Caches-Effectively-in-Spring-Boot-Webflux">selectively cache individual key/value pairs</a>.</p>
<p>Caching in reactor when using a Mono as a hot source is pretty straightforward, but there is one gotcha. I will demonstrate how to cache, and also how to write automated tests for that caching behavior, in this post.</p>
<h2 id="the-app">The App</h2>
<p>We're going to leverage some work done in a previous post here. Let's recall that we had a service that would retry on any timeout downstream:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Service
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RetryService</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> WebClient serviceAWebClient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">RetryService</span>(@Qualifier(<span style="color:#ff79c6">&amp;</span>#34;service<span style="color:#ff79c6">-</span>a<span style="color:#ff79c6">-</span>web<span style="color:#ff79c6">-</span>client<span style="color:#ff79c6">&amp;</span>#34;) WebClient serviceAWebClient) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">serviceAWebClient</span> <span style="color:#ff79c6">=</span> serviceAWebClient;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;WelcomeMessage<span style="color:#ff79c6">&amp;</span>gt; getWelcomeMessageAndHandleTimeout(String locale) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">serviceAWebClient</span>.<span style="color:#50fa7b">get</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">uri</span>(uriBuilder <span style="color:#ff79c6">-&amp;</span>gt; uriBuilder.<span style="color:#50fa7b">path</span>(<span style="color:#ff79c6">&amp;</span>#34;<span style="color:#ff79c6">/</span>locale<span style="color:#ff79c6">/</span>{locale}<span style="color:#ff79c6">/</span>message<span style="color:#ff79c6">&amp;</span>#34;).<span style="color:#50fa7b">build</span>(locale))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">retrieve</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">bodyToMono</span>(WelcomeMessage.<span style="color:#50fa7b">class</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">retryWhen</span>(
</span></span><span style="display:flex;"><span>                    Retry.<span style="color:#50fa7b">backoff</span>(2, Duration.<span style="color:#50fa7b">ofMillis</span>(25))
</span></span><span style="display:flex;"><span>                            .<span style="color:#50fa7b">filter</span>(throwable <span style="color:#ff79c6">-&amp;</span>gt; throwable <span style="color:#ff79c6">instanceof</span> TimeoutException)
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let's say for the sake of this article that the business requirements allow us to cache a welcome message that is in English for about five minutes. There is no hard requirement on welcome messages being updated immediately. Now that we already have resilience around timeouts, let's also add a cache on a successful response by creating a decorator. Because this is a tutorial, we're going to call that decorator service <strong>CachingService</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Service
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">CachingService</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> RetryService retryService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">CachingService</span>(RetryService retryService) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">retryService</span> <span style="color:#ff79c6">=</span> retryService;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;WelcomeMessage<span style="color:#ff79c6">&amp;</span>gt; getEnglishLocaleWelcomeMessage() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">retryService</span>.<span style="color:#50fa7b">getWelcomeMessageAndHandleTimeout</span>(<span style="color:#ff79c6">&amp;</span>#34;en_US<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This service currently just proxies directly to the <strong>RetryService</strong> and doesn't do anything remarkable. We're now going to add a test that verifies that the cache is working:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">CachingServiceIT</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">englishLocaleWelcomMessage_caches</span>() {
</span></span><span style="display:flex;"><span>        RetryService mockRetryService <span style="color:#ff79c6">=</span> Mockito.<span style="color:#50fa7b">mock</span>(RetryService.<span style="color:#50fa7b">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        AtomicInteger counter <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> AtomicInteger();
</span></span><span style="display:flex;"><span>        Mockito.<span style="color:#50fa7b">when</span>(mockRetryService.<span style="color:#50fa7b">getWelcomeMessageAndHandleTimeout</span>(<span style="color:#ff79c6">&amp;</span>#34;en_US<span style="color:#ff79c6">&amp;</span>#34;))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">thenReturn</span>(Mono.<span style="color:#50fa7b">defer</span>(() <span style="color:#ff79c6">-&amp;</span>gt;
</span></span><span style="display:flex;"><span>                            Mono.<span style="color:#50fa7b">just</span>(<span style="color:#ff79c6">new</span> WelcomeMessage(<span style="color:#ff79c6">&amp;</span>#34;count <span style="color:#ff79c6">&amp;</span>#34; <span style="color:#ff79c6">&amp;</span>#43; counter.<span style="color:#50fa7b">incrementAndGet</span>()))
</span></span><span style="display:flex;"><span>                        )
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        CachingService cachingService <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> CachingService(mockRetryService);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(cachingService.<span style="color:#50fa7b">getEnglishLocaleWelcomeMessage</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">expectNextMatches</span>(welcomeMessage <span style="color:#ff79c6">-&amp;</span>gt; <span style="color:#ff79c6">&amp;</span>#34;count 1<span style="color:#ff79c6">&amp;</span>#34;.<span style="color:#50fa7b">equals</span>(welcomeMessage.<span style="color:#50fa7b">getMessage</span>()))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">verifyComplete</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(cachingService.<span style="color:#50fa7b">getEnglishLocaleWelcomeMessage</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">expectNextMatches</span>(welcomeMessage <span style="color:#ff79c6">-&amp;</span>gt; <span style="color:#ff79c6">&amp;</span>#34;count 1<span style="color:#ff79c6">&amp;</span>#34;.<span style="color:#50fa7b">equals</span>(welcomeMessage.<span style="color:#50fa7b">getMessage</span>()))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">verifyComplete</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This test defers to a <strong>Supplier</strong> to return a <strong>Mono</strong> on demand. Every time this mono is subscribed to, it will call our <strong>Supplier</strong>. Under the covers, our <strong>Supplier</strong> will return basically just a count of the number of times it has been invoked.</p>
<p>One way to get this test to pass is to just call one of the <strong>cache</strong> methods on <strong>Mono</strong>. This is one of the easiest:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Service
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">CachingService</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> RetryService retryService;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> Mono<span style="color:#ff79c6">&amp;</span>lt;WelcomeMessage<span style="color:#ff79c6">&amp;</span>gt; cachedEnglishWelcomeMono;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">CachingService</span>(RetryService retryService) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">retryService</span> <span style="color:#ff79c6">=</span> retryService;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">cachedEnglishWelcomeMono</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">fallbackService</span>.<span style="color:#50fa7b">getWelcomeMessageAndHandleTimeout</span>(<span style="color:#ff79c6">&amp;</span>#34;en_US<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">cache</span>(Duration.<span style="color:#50fa7b">ofMinutes</span>(5));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;WelcomeMessage<span style="color:#ff79c6">&amp;</span>gt; getEnglishLocaleWelcomeMessage() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> cachedEnglishWelcomeMono;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now the test passes, but there is a fatal flaw with this approach: <strong>it also caches errors</strong>. So, if the <strong>RetryService</strong> ends up timing out too many times, or fails for some other reason, then we will have our <strong>CachingService</strong> constantly emitting that error for five minutes. <strong>This is almost always bad</strong> and I wish this wasn't the interface, but it is.</p>
<p>To demonstrate this in action, I'll write another test to target that:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">cachesSuccessOnly</span>() {
</span></span><span style="display:flex;"><span>        RetryService mockRetryService <span style="color:#ff79c6">=</span> Mockito.<span style="color:#50fa7b">mock</span>(RetryService.<span style="color:#50fa7b">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        AtomicInteger counter <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> AtomicInteger();
</span></span><span style="display:flex;"><span>        Mockito.<span style="color:#50fa7b">when</span>(mockRetryService.<span style="color:#50fa7b">getWelcomeMessageAndHandleTimeout</span>(<span style="color:#ff79c6">&amp;</span>#34;en_US<span style="color:#ff79c6">&amp;</span>#34;))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">thenReturn</span>(Mono.<span style="color:#50fa7b">defer</span>(() <span style="color:#ff79c6">-&amp;</span>gt; {
</span></span><span style="display:flex;"><span>                            <span style="color:#ff79c6">if</span> (counter.<span style="color:#50fa7b">incrementAndGet</span>() <span style="color:#ff79c6">&amp;</span>gt; 1) {
</span></span><span style="display:flex;"><span>                                <span style="color:#ff79c6">return</span> Mono.<span style="color:#50fa7b">just</span>(<span style="color:#ff79c6">new</span> WelcomeMessage(<span style="color:#ff79c6">&amp;</span>#34;count <span style="color:#ff79c6">&amp;</span>#34; <span style="color:#ff79c6">&amp;</span>#43; counter.<span style="color:#50fa7b">get</span>()));
</span></span><span style="display:flex;"><span>                            } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>                                <span style="color:#ff79c6">return</span> Mono.<span style="color:#50fa7b">error</span>(<span style="color:#ff79c6">new</span> RuntimeException());
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        })
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        CachingService cachingService <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> CachingService(mockRetryService);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(cachingService.<span style="color:#50fa7b">getEnglishLocaleWelcomeMessage</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">expectError</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">verify</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(cachingService.<span style="color:#50fa7b">getEnglishLocaleWelcomeMessage</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">expectNextMatches</span>(welcomeMessage <span style="color:#ff79c6">-&amp;</span>gt; <span style="color:#ff79c6">&amp;</span>#34;count 2<span style="color:#ff79c6">&amp;</span>#34;.<span style="color:#50fa7b">equals</span>(welcomeMessage.<span style="color:#50fa7b">getMessage</span>()))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">verifyComplete</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// previous result should be cached</span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(cachingService.<span style="color:#50fa7b">getEnglishLocaleWelcomeMessage</span>())
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">expectNextMatches</span>(welcomeMessage <span style="color:#ff79c6">-&amp;</span>gt; <span style="color:#ff79c6">&amp;</span>#34;count 2<span style="color:#ff79c6">&amp;</span>#34;.<span style="color:#50fa7b">equals</span>(welcomeMessage.<span style="color:#50fa7b">getMessage</span>()))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">verifyComplete</span>();
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>You will see this fail, because it will cache the error and keep emitting it. To fix that, there is a golden <strong>cache</strong> override on our Mono that allows us to specify the duration of which each type of response is cached:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Service
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">CachingService</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> RetryService retryService;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> Mono<span style="color:#ff79c6">&amp;</span>lt;WelcomeMessage<span style="color:#ff79c6">&amp;</span>gt; cachedEnglishWelcomeMono;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">CachingService</span>(RetryService retryService) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">retryService</span> <span style="color:#ff79c6">=</span> retryService;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">cachedEnglishWelcomeMono</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">retryService</span>.<span style="color:#50fa7b">getWelcomeMessageAndHandleTimeout</span>(<span style="color:#ff79c6">&amp;</span>#34;en_US<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">cache</span>(welcomeMessage <span style="color:#ff79c6">-&amp;</span>gt; Duration.<span style="color:#50fa7b">ofMinutes</span>(5),
</span></span><span style="display:flex;"><span>                        throwable <span style="color:#ff79c6">-&amp;</span>gt; Duration.<span style="color:#50fa7b">ZERO</span>,
</span></span><span style="display:flex;"><span>                        () <span style="color:#ff79c6">-&amp;</span>gt; Duration.<span style="color:#50fa7b">ZERO</span>
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Mono<span style="color:#ff79c6">&amp;</span>lt;WelcomeMessage<span style="color:#ff79c6">&amp;</span>gt; getEnglishLocaleWelcomeMessage() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> cachedEnglishWelcomeMono;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now if we run our tests again, both of them pass. By passing in <strong>Duration.ZERO</strong>, we don't cache errors or empty Monos at all, only the successful one, for five minutes.</p>
<p>Remember to checkout the <a href="https://github.com/nfisher23/reactive-programming-webflux/tree/master/api-calls-and-resilience">source code on Github</a>.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/java/" alt="Java">
          Java
        </a>
      
        <a href="/tags/spring/" alt="Spring">
          Spring
        </a>
      
        <a href="/tags/reactive/" alt="Reactive">
          Reactive
        </a>
      
        <a href="/tags/webflux/" alt="Webflux">
          Webflux
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
