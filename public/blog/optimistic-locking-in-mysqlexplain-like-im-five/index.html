<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Optimistic Locking in MySQL--Explain Like I&amp;#39;m Five</title>
<meta
  name="description"
  content="Optimistic Locking is a compromise to improve performance. If processors were infinitely fast, we wouldn&#39;t need it and it would add unnecessary complexity. But, well, they aren&#39;t."
/>
<link rel="canonical" href="http://localhost:1313/blog/optimistic-locking-in-mysqlexplain-like-im-five/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">Optimistic Locking in MySQL--Explain Like I&amp;#39;m Five</h2>

    <div class="meta">
      
      <time datetime="2020-07-26 00:00:56 &#43;0000 UTC" title='Sun, Jul 26, 2020, 12:00 AM UTC'>
        26/07/2020 - Estimated reading time: 4 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>Optimistic Locking is a compromise to improve performance. If processors were infinitely fast, we wouldn't need it and it would add unnecessary complexity. But, well, they aren't.</p>
<p>Optimistic Locking was also introduced because holding open locks on databases can cause cascading failures, bubbling up unnecessary errors to users.</p>
<p>So what is it? It's not locking at all, it's just another form of concurrency control that takes some load off of the database. You try to update a record based off some known property of the row (typically a version or datetime field) that you read as a select query at the start of a transaction. Let's set up the example with MySQL:</p>
<h4 id="1-start-a-mysql-database-i39m-using-docker-obviously">1. Start a MySQL database [I'm using docker, obviously]:</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker container run --env &amp;<span style="color:#6272a4">#34;MYSQL_ALLOW_EMPTY_PASSWORD=true&amp;#34; -d -p 3306:3306 mysql</span>
</span></span></code></pre></div><h4 id="2-setup-test-data">2. Setup test data</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ mysql --protocol tcp -u root
</span></span><span style="display:flex;"><span>CREATE SCHEMA IF NOT EXISTS myschema;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use myschema;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CREATE TABLE mytable <span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>    prim_key INT AUTO_INCREMENT PRIMARY KEY,
</span></span><span style="display:flex;"><span>    first_column VARCHAR<span style="color:#ff79c6">(</span>50<span style="color:#ff79c6">)</span>,
</span></span><span style="display:flex;"><span>    second_column VARCHAR<span style="color:#ff79c6">(</span>100<span style="color:#ff79c6">)</span>,
</span></span><span style="display:flex;"><span>    version INT DEFAULT <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">)</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>INSERT INTO mytable <span style="color:#ff79c6">(</span> first_column, second_column <span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>VALUES
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">(</span> &amp;<span style="color:#6272a4">#39;jack&amp;#39;, &amp;#39;bauer&amp;#39;);</span>
</span></span></code></pre></div><h4 id="3-actual-example-and-explanation-now">3. Actual Example and Explanation Now</h4>
<p>Open two different terminals, I'll call them <strong>T1</strong> and <strong>T2</strong> and start typing in the order specified by the comments:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4">#### T1</span>
</span></span><span style="display:flex;"><span>$ mysql --protocol tcp - u root
</span></span><span style="display:flex;"><span>USE myschema;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>START TRANSACTION;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SELECT * FROM mytable where <span style="color:#8be9fd;font-style:italic">prim_key</span> <span style="color:#ff79c6">=</span> 1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#### T2</span>
</span></span><span style="display:flex;"><span>$ mysql --protocol tcp -u root
</span></span><span style="display:flex;"><span>USE myschema;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>START TRANSACTION;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SELECT * FROM mytable where <span style="color:#8be9fd;font-style:italic">prim_key</span> <span style="color:#ff79c6">=</span> 1;
</span></span></code></pre></div><p>Notice that T2 did not block, even though we're in a transaction. What does this mean? It means that the remainder of each transaction is made with an assumption about how the data was at the start of the transaction. If both threads start marching forward and want to update that data without optimistic locking, then one will be overwriting the other one:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4">#### T1 - DON&amp;#39;T ACTUALLY EXECUTE THIS</span>
</span></span><span style="display:flex;"><span>UPDATE mytable SET <span style="color:#8be9fd;font-style:italic">second_column</span> <span style="color:#ff79c6">=</span> &amp;<span style="color:#6272a4">#39;jackson&amp;#39; where prim_key = 1;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMMIT;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#### T2 - DON&amp;#39;T ACTUALLY EXECUTE THIS</span>
</span></span><span style="display:flex;"><span>UPDATE mytable SET <span style="color:#8be9fd;font-style:italic">second_column</span> <span style="color:#ff79c6">=</span> &amp;<span style="color:#6272a4">#39;johnson&amp;#39; where prim_key = 1;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMMIT;
</span></span></code></pre></div><p>Depending on the order of these two distinct transactions, one is going to be overwriting the other without knowing that the data had changed midway through&ndash;the second_column could be either &quot;jackson&quot; or &quot;johnson&quot;. There are some use cases where this isn't that big of a deal and many others where it is <em>definitely a big deal</em>, especially if the engineer writing the application doesn't understand that this is going to happen.</p>
<h4 id="optimistic-locking---a-practice-not-a-database-feature">Optimistic Locking - A Practice, not a Database Feature</h4>
<p>Optimistic Locking &quot;fixes&quot; this problem by observing some attribute about the data that it is changing, and if that value has changed the code will roll back the transaction. This can be made atomic in two ways: first, MySQL will hold open a lock on data that is being UPDATED (not selected, by default), and second, include the piece of data in the actual update as a WHERE condition, so that if the operation fails we can see the number of rows that were updated. If the number of rows that were updated is zero, then it's an optimistic locking exception and we should roll back:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6272a4">#### T1 - Pay attention to the output</span>
</span></span><span style="display:flex;"><span>UPDATE mytable SET <span style="color:#8be9fd;font-style:italic">second_column</span> <span style="color:#ff79c6">=</span> &amp;<span style="color:#6272a4">#39;jackson&amp;#39; where prim_key = 1;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># optimistic locking check:</span>
</span></span><span style="display:flex;"><span>UPDATE mytable SET <span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> version &amp;<span style="color:#6272a4">#43; 1 WHERE prim_key = 1 AND version = 1;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMMIT;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#### T2 - Watch the output!</span>
</span></span><span style="display:flex;"><span>UPDATE mytable SET <span style="color:#8be9fd;font-style:italic">second_column</span> <span style="color:#ff79c6">=</span> &amp;<span style="color:#6272a4">#39;johnson&amp;#39; where prim_key = 1;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># optimistic locking check:</span>
</span></span><span style="display:flex;"><span>UPDATE mytable SET <span style="color:#8be9fd;font-style:italic">version</span> <span style="color:#ff79c6">=</span> version &amp;<span style="color:#6272a4">#43; 1 WHERE prim_key = 1 AND version = 1;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># ^ no rows affected! Roll back the transaction</span>
</span></span><span style="display:flex;"><span>ROLLBACK;
</span></span></code></pre></div><p>If you run each of them in the right order, you will see the UPDATE on the second terminal pause until the first terminal commits the transaction, which makes this operation concurrent safe and more performant than setting the transaction isolation level to SERIALIZABLE.</p>
</section>

  
    
  

    
  


  <footer>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
