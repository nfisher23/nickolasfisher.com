<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pre Loading a Lua Script into Redis With Lettuce</title>
<meta
  name="description"
  content="The source code for what follows can be found on Github.
In my last article on running a lua script against redis with lettuce, we just sent the entire script [that redis will execute atomically] along with the arguments every time. For very small scripts this is unlikely to be a problem, but there is definitely a more efficient way to do this, using EVALSHA."
/>
<link rel="canonical" href="http://localhost:1313/blog/pre-loading-a-lua-script-into-redis-with-lettuce/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        Home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        Blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        About me
      </a>
    </li>
    
    <li>
      <a href="/categories" class="">
        Categories
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">Pre Loading a Lua Script into Redis With Lettuce</h2>

    <div class="meta">
      
      <time datetime="2021-04-24 18:05:29 &#43;0000 UTC" title='Sat, Apr 24, 2021, 6:05 PM UTC'>
        24/04/2021 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>The source code for what follows <a href="https://github.com/nfisher23/reactive-programming-webflux">can be found on Github</a>.</p>
<p>In my last article on <a href="https://nickolasfisher.com/blog/How-to-Run-a-Lua-Script-against-Redis-using-Lettuce">running a lua script against redis with lettuce</a>, we just sent the entire script [that redis will execute atomically] along with the arguments every time. For very small scripts this is unlikely to be a problem, but there is definitely a more efficient way to do this, using <a href="https://redis.io/commands/evalsha">EVALSHA</a>.</p>
<h3 id="how-evalsha-works">How EVALSHA Works</h3>
<p>Running a lua script without evalsha means that we send the script and the arguments every time, like we have covered already:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli <span style="color:#8be9fd;font-style:italic">eval</span> &amp;<span style="color:#6272a4">#34;return redis.call(&amp;#39;set&amp;#39;,KEYS[1],ARGV[1],&amp;#39;ex&amp;#39;,ARGV[2])&amp;#34; 1 foo1 bar1 10</span>
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div><p><strong>SCRIPT LOAD</strong> allows us to tell redis &quot;this is my script, please remember it&quot;, then we can use EVALSHA to run the script that redis now remembers. For example, using the CLI:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli
</span></span><span style="display:flex;"><span>&amp;gt; SCRIPT LOAD &amp;<span style="color:#6272a4">#34;return redis.call(&amp;#39;set&amp;#39;,KEYS[1],ARGV[1],&amp;#39;ex&amp;#39;,ARGV[2])&amp;#34;</span>
</span></span><span style="display:flex;"><span>&amp;<span style="color:#6272a4">#34;cf4df3d8eb7f521ceb285c6870e5713d79e2bb0b&amp;#34;</span>
</span></span><span style="display:flex;"><span>&amp;gt; evalsha cf4df3d8eb7f521ceb285c6870e5713d79e2bb0b <span style="color:#bd93f9">1</span> foo1 bar1 <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div><p>We can verify that works with a shell script like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#8be9fd;font-style:italic">SHA</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">$(</span>redis-cli script load &amp;<span style="color:#6272a4">#34;return redis.call(&amp;#39;set&amp;#39;,KEYS[1],ARGV[1],&amp;#39;ex&amp;#39;,ARGV[2])&amp;#34;)</span>
</span></span><span style="display:flex;"><span>$ redis-cli evalsha &amp;<span style="color:#6272a4">#34;$SHA&amp;#34; 1 foo1 bar1 10; redis-cli ttl foo1; redis-cli get foo1</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">(</span>integer<span style="color:#ff79c6">)</span> <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>&amp;<span style="color:#6272a4">#34;bar1&amp;#34;</span>
</span></span></code></pre></div><p>By referencing the hash of the script [sha1 hash, to be more specific], we don't have to send the entire script. Indeed, regardless of how big a script we load, the size of the hash that represents the script will stay compact.</p>
<h3 id="evalsha-with-lettuce">EVALSHA with Lettuce</h3>
<p>EVALSHA with lettuce can work much the same way, if we want it to. Just load the script and used the returned hash [note that the SHA1 hash is represented as a hexadecimal string]:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">scriptLoadFromResponse</span>() {
</span></span><span style="display:flex;"><span>        String shaOfScript <span style="color:#ff79c6">=</span> redisReactiveCommands.<span style="color:#50fa7b">scriptLoad</span>(SAMPLE_LUA_SCRIPT).<span style="color:#50fa7b">block</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(redisReactiveCommands.<span style="color:#50fa7b">evalsha</span>(
</span></span><span style="display:flex;"><span>                shaOfScript,
</span></span><span style="display:flex;"><span>                ScriptOutputType.<span style="color:#50fa7b">BOOLEAN</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// keys as an array</span>
</span></span><span style="display:flex;"><span>                Arrays.<span style="color:#50fa7b">asList</span>(<span style="color:#ff79c6">&amp;</span>#34;foo1<span style="color:#ff79c6">&amp;</span>#34;).<span style="color:#50fa7b">toArray</span>(<span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">[</span>0<span style="color:#ff79c6">]</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// other arguments</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&amp;</span>#34;bar1<span style="color:#ff79c6">&amp;</span>#34;, <span style="color:#ff79c6">&amp;</span>#34;10<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">expectNext</span>(<span style="color:#ff79c6">true</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">verifyComplete</span>();
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>If you want to generate the hash of the script yourself, there are several libraries available to you. Just get the SHA1 hash of the script [assuming UTF-8 encoding, which java strings are], then encode the output into a hex string. We can see that the response from redis and our code generate the same sha:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">scriptLoadFromDigest</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>        MessageDigest md <span style="color:#ff79c6">=</span> MessageDigest.<span style="color:#50fa7b">getInstance</span>(<span style="color:#ff79c6">&amp;</span>#34;SHA<span style="color:#ff79c6">-</span>1<span style="color:#ff79c6">&amp;</span>#34;);
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> digestAsBytes <span style="color:#ff79c6">=</span> md.<span style="color:#50fa7b">digest</span>(SAMPLE_LUA_SCRIPT.<span style="color:#50fa7b">getBytes</span>(StandardCharsets.<span style="color:#50fa7b">UTF_8</span>));
</span></span><span style="display:flex;"><span>        String hexadecimalStringOfScriptSha1 <span style="color:#ff79c6">=</span> Hex.<span style="color:#50fa7b">encodeHexString</span>(digestAsBytes);
</span></span><span style="display:flex;"><span>        String hexStringFromRedis <span style="color:#ff79c6">=</span> redisReactiveCommands.<span style="color:#50fa7b">scriptLoad</span>(SAMPLE_LUA_SCRIPT).<span style="color:#50fa7b">block</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// they&amp;#39;re the same</span>
</span></span><span style="display:flex;"><span>        assertEquals(hexadecimalStringOfScriptSha1, hexStringFromRedis);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(redisReactiveCommands.<span style="color:#50fa7b">evalsha</span>(
</span></span><span style="display:flex;"><span>                hexadecimalStringOfScriptSha1,
</span></span><span style="display:flex;"><span>                ScriptOutputType.<span style="color:#50fa7b">BOOLEAN</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// keys as an array</span>
</span></span><span style="display:flex;"><span>                Arrays.<span style="color:#50fa7b">asList</span>(<span style="color:#ff79c6">&amp;</span>#34;foo1<span style="color:#ff79c6">&amp;</span>#34;).<span style="color:#50fa7b">toArray</span>(<span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">[</span>0<span style="color:#ff79c6">]</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// other arguments</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&amp;</span>#34;bar1<span style="color:#ff79c6">&amp;</span>#34;, <span style="color:#ff79c6">&amp;</span>#34;10<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">expectNext</span>(<span style="color:#ff79c6">true</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">verifyComplete</span>();
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Note that I'm using an apache commons library to take the byte array and encode it to hex in this case. The internet has <a href="https://stackoverflow.com/questions/9655181/how-to-convert-a-byte-array-to-a-hex-string-in-java">several suggestions for how you can encode a byte array to a hex string yourself</a> if you don't like the way I've done it here.</p>
<p>Remember that the primary benefit here is that you don't have to send the script over the wire and have redis decode it every single time, which can be significant if used frequently.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/java/" alt="Java">
          Java
        </a>
      
        <a href="/tags/spring/" alt="Spring">
          Spring
        </a>
      
        <a href="/tags/reactive/" alt="Reactive">
          Reactive
        </a>
      
        <a href="/tags/webflux/" alt="Webflux">
          Webflux
        </a>
      
        <a href="/tags/lettuce/" alt="Lettuce">
          Lettuce
        </a>
      
        <a href="/tags/redis/" alt="Redis">
          Redis
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
