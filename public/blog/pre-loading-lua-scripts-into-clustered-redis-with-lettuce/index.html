<!doctype html><html lang=en-US class="scroll-smooth dark"><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Pre Loading Lua Scripts into Clustered Redis with Lettuce</title>
<meta name=description content="The source code for what follows can be found on github.
In a previous article, we showed how to efficiently execute a lua script in redis using lettuce. To really scale our caching solution horizontally [and elegantly deal with many scaling headaches], we will also want to make sure we can execute our lua scripts against clustered redis, which as we&rsquo;ll see here is pretty straightforward."><link rel=canonical href=https://www.nickolasfisher.com/blog/pre-loading-lua-scripts-into-clustered-redis-with-lettuce/><link rel=robots href=/robots.txt><link rel=icon type=image/x-icon href=/img/nficon.png><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><link rel=stylesheet href="https://www.nickolasfisher.com/css/app.min.dee9c4afb37cb95c5d39c976614ef6f95398bcba4b6e73066c44de2a3a6543ed.css"></head><body class="max-w-screen-md mx-auto px-2.5"><div class=header><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12"><div class="flex-none w-20 h-20 rounded-full overflow-hidden"><a href=https://www.nickolasfisher.com/><img srcset="/img/profile-picture_hu4241499301404582006.jpg 80w" src=/img/profile-picture.jpg width=386 height=345 alt="Nick Fisher's tech blog"></a></div><div class="flex flex-col gap-5"><a href=https://www.nickolasfisher.com/><h1 id=site-title>Nick Fisher's tech blog</h1></a><nav><ul><li><a href=/>home</a></li><li><a href=/blog>blog</a></li><li><a href=/about>about</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></header><button class=toggle-theme aria-label="Toggle Theme" title="Toggle Theme" onclick=toggleTheme()>
<span class="theme-icon light"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75.0 11-7.5.0 3.75 3.75.0 017.5.0z"/></svg> </span><span class="theme-icon dark"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718.0 0118 15.75c-5.385.0-9.75-4.365-9.75-9.75.0-1.33.266-2.597.748-3.752A9.753 9.753.0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753.0 009.002-5.998z"/></svg> </span></button>
<script>document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("theme");setTheme(!e||e==="light"?"light":e)});function setTheme(e){const t=document.querySelector("html");localStorage.setItem("theme",e),e==="light"?(t.classList.contains("dark")&&document.querySelector("html").classList.remove("dark"),document.querySelector(".theme-icon.light").style.display="none",document.querySelector(".theme-icon.dark").style.display="block"):(t.classList.contains("dark")||document.querySelector("html").classList.add("dark"),document.querySelector(".theme-icon.dark").style.display="none",document.querySelector(".theme-icon.light").style.display="block")}function toggleTheme(){const e=localStorage.getItem("theme");setTheme(e==="light"?"dark":"light")}</script></div><main id=content><article class="flex flex-col gap-10"><header class="flex flex-col gap-2"><h2 class=title-large>Pre Loading Lua Scripts into Clustered Redis with Lettuce</h2><div class=meta><time datetime="2021-04-25 17:37:07 +0000 UTC" title='Sun, Apr 25, 2021, 5:37 PM UTC'>25/04/2021 - Estimated reading time: 3 minutes</time></div></header><section><p>The source code for what follows <a href=https://github.com/nfisher23/reactive-programming-webflux>can be found on github</a>.</p><p>In a previous article, we showed how to <a href=https://nickolasfisher.com/blog/Pre-Loading-a-Lua-Script-into-Redis-With-Lettuce>efficiently execute a lua script in redis using lettuce</a>. To really scale our caching solution horizontally [and elegantly deal with many scaling headaches], we will also want to make sure we can execute our lua scripts against clustered redis, which as we&rsquo;ll see here is pretty straightforward.</p><h3 id=script-load-has-to-be-run-against-every-node>SCRIPT LOAD has to be run against every Node</h3><p>If you have your <a href=https://nickolasfisher.com/blog/Bootstrap-a-Local-Sharded-Redis-Cluster-in-Five-Minutes>local clustered redis solution up and running</a>, we can poke around with the cli a bit [note: this assumes your local cluster has three primary nodes with ports 30001-30003]:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>➜  ~ redis-cli -p <span style=color:#bd93f9>30001</span> -c script load <span style=color:#f1fa8c>&#34;return redis.call(&#39;set&#39;,KEYS[1],ARGV[1],&#39;ex&#39;,ARGV[2])&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f1fa8c>&#34;cf4df3d8eb7f521ceb285c6870e5713d79e2bb0b&#34;</span>
</span></span><span style=display:flex><span>➜  ~ redis-cli -p <span style=color:#bd93f9>30002</span> -c
</span></span><span style=display:flex><span>127.0.0.1:30002&gt; evalsha cf4df3d8eb7f521ceb285c6870e5713d79e2bb0b <span style=color:#bd93f9>1</span> foo1 bar1 <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>-&gt; Redirected to slot <span style=color:#ff79c6>[</span>13431<span style=color:#ff79c6>]</span> located at 127.0.0.1:30003
</span></span><span style=display:flex><span><span style=color:#ff79c6>(</span>error<span style=color:#ff79c6>)</span> NOSCRIPT No matching script. Please use EVAL.
</span></span><span style=display:flex><span>127.0.0.1:30003&gt; evalsha cf4df3d8eb7f521ceb285c6870e5713d79e2bb0b <span style=color:#bd93f9>1</span> foo2 bar1 <span style=color:#bd93f9>105</span>
</span></span><span style=display:flex><span>-&gt; Redirected to slot <span style=color:#ff79c6>[</span>1044<span style=color:#ff79c6>]</span> located at 127.0.0.1:30001
</span></span><span style=display:flex><span>OK
</span></span></code></pre></div><p>As we can see here, we loaded the script into our node with port 30001, then we tried to call the script for a key that had a hash slot which belonged to the node with port 30003. This resulted in an error because that script was not loaded onto that node. If we picked a node where the key&rsquo;s hash slot landed it on a node where we already loaded the script, then it was executed without a problem.</p><p>Put simply, <strong>you have to pre load your lua script on to each primary node</strong> or you will receive errors.</p><h3 id=using-lettuce>Using Lettuce</h3><p>Lettuce will automatically load your script into each node for you, as we should be able to see from this example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>   <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>scriptLoad</span>() {
</span></span><span style=display:flex><span>        LOG.<span style=color:#50fa7b>info</span>(<span style=color:#f1fa8c>&#34;starting script load&#34;</span>);
</span></span><span style=display:flex><span>        String hashOfScript <span style=color:#ff79c6>=</span> redisClusterReactiveCommands.<span style=color:#50fa7b>scriptLoad</span>(<span style=color:#f1fa8c>&#34;return redis.call(&#39;set&#39;,KEYS[1],ARGV[1],&#39;ex&#39;,ARGV[2])&#34;</span>)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>block</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        redisClusterReactiveCommands.<span style=color:#50fa7b>evalsha</span>(hashOfScript, ScriptOutputType.<span style=color:#50fa7b>BOOLEAN</span>, <span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>[]</span>{<span style=color:#f1fa8c>&#34;foo1&#34;</span>}, <span style=color:#f1fa8c>&#34;bar1&#34;</span>, <span style=color:#f1fa8c>&#34;10&#34;</span>).<span style=color:#50fa7b>blockLast</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        redisClusterReactiveCommands.<span style=color:#50fa7b>evalsha</span>(hashOfScript, ScriptOutputType.<span style=color:#50fa7b>BOOLEAN</span>, <span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>[]</span> {<span style=color:#f1fa8c>&#34;foo2&#34;</span>}, <span style=color:#f1fa8c>&#34;bar2&#34;</span>, <span style=color:#f1fa8c>&#34;10&#34;</span>).<span style=color:#50fa7b>blockLast</span>();
</span></span><span style=display:flex><span>        redisClusterReactiveCommands.<span style=color:#50fa7b>evalsha</span>(hashOfScript, ScriptOutputType.<span style=color:#50fa7b>BOOLEAN</span>, <span style=color:#ff79c6>new</span> String<span style=color:#ff79c6>[]</span> {<span style=color:#f1fa8c>&#34;foo4&#34;</span>}, <span style=color:#f1fa8c>&#34;bar4&#34;</span>, <span style=color:#f1fa8c>&#34;10&#34;</span>).<span style=color:#50fa7b>blockLast</span>();
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>This code will run without errors&ndash;lettuce loads the script into each node for us, we use the sha returned from redis to tell each node which script to run, and we can sanity check the keys that were set with some cli commands [note there&rsquo;s a 10 second expiry on each key&ndash;you might want to increase that]</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ redis-cli -p <span style=color:#bd93f9>30002</span> -c mget foo1
</span></span><span style=display:flex><span>1<span style=color:#ff79c6>)</span> <span style=color:#f1fa8c>&#34;bar1&#34;</span>
</span></span><span style=display:flex><span>$ redis-cli -p <span style=color:#bd93f9>30002</span> -c mget foo2
</span></span><span style=display:flex><span>1<span style=color:#ff79c6>)</span> <span style=color:#f1fa8c>&#34;bar2&#34;</span>
</span></span></code></pre></div><h3 id=a-warning>A Warning</h3><p>While that code technically works, it&rsquo;s not uncommon to need to add more nodes to a cluster. Without trying that locally myself, you will want to verify that the new nodes inherit the loaded script. If you don&rsquo;t [if redis doesn&rsquo;t, ultimately], you will probably suffer a partial outage because you&rsquo;ll be using a sha for a script that doesn&rsquo;t exist on that node.</p><p>If that does indeed happen, then ensure that your code falls back to re-uploading the script if you get that error response and you should be able to gracefully and silently recover.</p></section><footer><div class="pb-14 taxonomy-list tags-list"><a href=/tags/java/ alt=Java>Java
</a><a href=/tags/distributed-systems/ alt="Distributed Systems">Distributed Systems
</a><a href=/tags/reactive/ alt=Reactive>Reactive
</a><a href=/tags/webflux/ alt=Webflux>Webflux
</a><a href=/tags/lettuce/ alt=Lettuce>Lettuce
</a><a href=/tags/redis/ alt=Redis>Redis</a></div></footer></article></main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2"><div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">© 2018-2025 —
<a href=https://www.nickolasfisher.com/>Nick Fisher's tech blog</a></div><div class="order-1 sm:order-2"><ul class="flex sm:justify-end gap-5"><li><a href=https://www.linkedin.com/in/nick-fisher-software/ target=_blank rel="noopener noreferrer">LinkedIn</a></li><li><a href=https://github.com/nfisher23 target=_blank rel="noopener noreferrer">GitHub</a></li></ul></div></footer></body></html>