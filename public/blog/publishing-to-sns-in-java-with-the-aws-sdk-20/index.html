<!doctype html><html lang=en-US class="scroll-smooth dark"><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Publishing to SNS in Java with the AWS SDK 2.0</title>
<meta name=description content="SNS is a medium to broadcast messages to multiple subscribers. A common use case is to have multiple SQS queues subscribing to the same SNS topic&ndash;this way, the publishing application only needs to focus on events that are specific to its business use case, and subscribing applications can configure an SQS queue and consume the event independently of other services. This helps organizations scale and significantly reduces the need to communicate between teams&ndash;each team can focus on its contract and business use case."><link rel=canonical href=https://www.nickolasfisher.com/blog/publishing-to-sns-in-java-with-the-aws-sdk-20/><link rel=robots href=/robots.txt><link rel=icon type=image/x-icon href=/img/nficon.png><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><link rel=stylesheet href="https://www.nickolasfisher.com/css/app.min.dee9c4afb37cb95c5d39c976614ef6f95398bcba4b6e73066c44de2a3a6543ed.css"></head><body class="max-w-screen-md mx-auto px-2.5"><div class=header><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12"><div class="flex-none w-20 h-20 rounded-full overflow-hidden"><a href=https://www.nickolasfisher.com/><img srcset="/img/profile-picture_hu4241499301404582006.jpg 80w" src=/img/profile-picture.jpg width=386 height=345 alt="Nick Fisher's tech blog"></a></div><div class="flex flex-col gap-5"><a href=https://www.nickolasfisher.com/><h1 id=site-title>Nick Fisher's tech blog</h1></a><nav><ul><li><a href=/>home</a></li><li><a href=/blog>blog</a></li><li><a href=/about>about</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></header><button class=toggle-theme aria-label="Toggle Theme" title="Toggle Theme" onclick=toggleTheme()>
<span class="theme-icon light"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75.0 11-7.5.0 3.75 3.75.0 017.5.0z"/></svg> </span><span class="theme-icon dark"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718.0 0118 15.75c-5.385.0-9.75-4.365-9.75-9.75.0-1.33.266-2.597.748-3.752A9.753 9.753.0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753.0 009.002-5.998z"/></svg> </span></button>
<script>document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("theme");setTheme(!e||e==="light"?"light":e)});function setTheme(e){const t=document.querySelector("html");localStorage.setItem("theme",e),e==="light"?(t.classList.contains("dark")&&document.querySelector("html").classList.remove("dark"),document.querySelector(".theme-icon.light").style.display="none",document.querySelector(".theme-icon.dark").style.display="block"):(t.classList.contains("dark")||document.querySelector("html").classList.add("dark"),document.querySelector(".theme-icon.dark").style.display="none",document.querySelector(".theme-icon.light").style.display="block")}function toggleTheme(){const e=localStorage.getItem("theme");setTheme(e==="light"?"dark":"light")}</script></div><main id=content><article class="flex flex-col gap-10"><header class="flex flex-col gap-2"><h2 class=title-large>Publishing to SNS in Java with the AWS SDK 2.0</h2><div class=meta><time datetime="2020-11-28 20:16:05 +0000 UTC" title='Sat, Nov 28, 2020, 8:16 PM UTC'>28/11/2020 - Estimated reading time: 3 minutes</time></div></header><section><p>SNS is a medium to broadcast messages to multiple subscribers. A common use case is to have multiple SQS queues subscribing to the same SNS topic&ndash;this way, the <em>publishing</em> application only needs to focus on events that are specific to its business use case, and <em>subscribing</em> applications can configure an SQS queue and consume the event independently of other services. This helps organizations scale and significantly reduces the need to communicate between teams&ndash;each team can focus on its contract and business use case.</p><p>This article will show how to publish to an SNS topic with java, using the AWS SDK 2.0, which has full reactive support. The source code for this post <a href=https://github.com/nfisher23/reactive-programming-webflux>can be found on Github</a>.</p><h2 id=setup-infra>Setup Infra</h2><p>To start with, I&rsquo;ll leverage a previous article written which <a href=https://nickolasfisher.com/blog/How-to-Setup-SNS-Message-Forwarding-to-SQS-with-the-AWS-CLI>sets up a subscription for an SQS queue on an SNS topic</a>. There, we had a <strong>docker-compose.yaml</strong> file like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>version</span>: <span style=color:#f1fa8c>&#39;2.1&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>localstack</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>container_name</span>: <span style=color:#f1fa8c>&#34;${LOCALSTACK_DOCKER_NAME-localstack_main}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>image</span>: localstack/localstack
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f1fa8c>&#34;4566-4599:4566-4599&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#f1fa8c>&#34;${PORT_WEB_UI-8080}:${PORT_WEB_UI-8080}&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>environment</span>:
</span></span><span style=display:flex><span>      - SERVICES=${SERVICES- }
</span></span><span style=display:flex><span>      - DEBUG=${DEBUG- }
</span></span><span style=display:flex><span>      - DATA_DIR=${DATA_DIR- }
</span></span><span style=display:flex><span>      - PORT_WEB_UI=${PORT_WEB_UI- }
</span></span><span style=display:flex><span>      - LAMBDA_EXECUTOR=${LAMBDA_EXECUTOR- }
</span></span><span style=display:flex><span>      - KINESIS_ERROR_PROBABILITY=${KINESIS_ERROR_PROBABILITY- }
</span></span><span style=display:flex><span>      - DOCKER_HOST=unix:///var/run/docker.sock
</span></span><span style=display:flex><span>      - HOST_TMP_FOLDER=${TMPDIR}
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f1fa8c>&#34;${TMPDIR:-/tmp/localstack}:/tmp/localstack&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#f1fa8c>&#34;/var/run/docker.sock:/var/run/docker.sock&#34;</span>
</span></span></code></pre></div><p>And, our initializing script to setup the queue subscribing to the topic was:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_SECRET_ACCESS_KEY</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;FAKE&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_ACCESS_KEY_ID</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;FAKE&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>AWS_DEFAULT_REGION</span><span style=color:#ff79c6>=</span>us-east-1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>QUEUE_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;my-queue&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>TOPIC_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;my-topic&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>QUEUE_URL</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>aws --endpoint-url http://localhost:4566 sqs create-queue --queue-name <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$QUEUE_NAME</span><span style=color:#f1fa8c>&#34;</span> --output text<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;queue url: </span><span style=color:#8be9fd;font-style:italic>$QUEUE_URL</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>TOPIC_ARN</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>aws --endpoint-url http://localhost:4566 sns create-topic --output text --name <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$TOPIC_NAME</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;topic arn: </span><span style=color:#8be9fd;font-style:italic>$TOPIC_ARN</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>QUEUE_ARN</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>aws --endpoint-url http://localhost:4566 sqs get-queue-attributes --queue-url <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$QUEUE_URL</span><span style=color:#f1fa8c>&#34;</span> | jq -r <span style=color:#f1fa8c>&#34;.Attributes.QueueArn&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;queue arn: </span><span style=color:#8be9fd;font-style:italic>$QUEUE_ARN</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>SUBSCRIPTION_ARN</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>aws --endpoint-url http://localhost:4566 sns subscribe --topic-arn <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$TOPIC_ARN</span><span style=color:#f1fa8c>&#34;</span> --protocol sqs --notification-endpoint <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$QUEUE_ARN</span><span style=color:#f1fa8c>&#34;</span> --output text<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># modify to raw message delivery true</span>
</span></span><span style=display:flex><span>aws --endpoint-url http://localhost:4566 sns set-subscription-attributes <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>  --subscription-arn <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$SUBSCRIPTION_ARN</span><span style=color:#f1fa8c>&#34;</span> --attribute-name RawMessageDelivery --attribute-value <span style=color:#8be9fd;font-style:italic>true</span>
</span></span></code></pre></div><p>This configures an SQS queue named &ldquo;my-queue&rdquo; and an SNS topic named &ldquo;my-topic&rdquo;. It then sets up a subscription for the queue on the topic with &ldquo;raw message delivery&rdquo; as true.</p><p>With this in place, we can start writing code. I will again leverage work done in a previous article about <a href=https://nickolasfisher.com/blog/How-to-Setup-a-Reactive-SQS-Listener-Using-the-AWS-SDK-and-Spring-Boot>setting up a reactive SQS listener in spring boot</a>. To start with, we will add in a dependency for SNS [note that this leverages the bill of materials spec in the maven pom, which is why there is no version specified here]:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#ff79c6>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;groupId&gt;</span>software.amazon.awssdk<span style=color:#ff79c6>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&lt;artifactId&gt;</span>sns<span style=color:#ff79c6>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>This obviously imports the AWS library for SNS, which we can use to configure an sns client like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Configuration
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>AwsSnsConfig</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Bean
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> SnsAsyncClient <span style=color:#50fa7b>amazonSNSAsyncClient</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> SnsAsyncClient.<span style=color:#50fa7b>builder</span>()
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>endpointOverride</span>(URI.<span style=color:#50fa7b>create</span>(<span style=color:#f1fa8c>&#34;http://localhost:4566&#34;</span>))
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>region</span>(Region.<span style=color:#50fa7b>US_EAST_1</span>)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>credentialsProvider</span>(StaticCredentialsProvider.<span style=color:#50fa7b>create</span>(<span style=color:#ff79c6>new</span> AwsCredentials() {
</span></span><span style=display:flex><span>                    @Override
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>accessKeyId</span>() {
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;FAKE&#34;</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    @Override
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>secretAccessKey</span>() {
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;FAKE&#34;</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }))
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note that these match the access and secret key we used in the localstack initialization script. To finish this example off, we can create a <strong>PostConstruct</strong> initializing bean:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Component
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>SnsSenderBean</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>final</span> SnsAsyncClient snsAsyncClient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// ARN&#39;s are immutable. In reality, you&#39;ll want to pass this in as config per environment</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> String topicARN <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;arn:aws:sns:us-east-1:000000000000:my-topic&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>SnsSenderBean</span>(SnsAsyncClient snsAsyncClient) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.<span style=color:#50fa7b>snsAsyncClient</span> <span style=color:#ff79c6>=</span> snsAsyncClient;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @PostConstruct
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>sendHelloToSNS</span>() {
</span></span><span style=display:flex><span>        Mono.<span style=color:#50fa7b>fromFuture</span>(() <span style=color:#ff79c6>-&gt;</span> snsAsyncClient.<span style=color:#50fa7b>publish</span>(PublishRequest.<span style=color:#50fa7b>builder</span>().<span style=color:#50fa7b>topicArn</span>(topicARN).<span style=color:#50fa7b>message</span>(<span style=color:#f1fa8c>&#34;message-from-sns&#34;</span>).<span style=color:#50fa7b>build</span>()))
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>repeat</span>(3)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>subscribe</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This sends four identical messages to SNS with a body of &ldquo;message-from-sns&rdquo;. These four messages will end up in the SQS queue, forwarded by SNS.</p><p>The SQS listener already configured will pick up these messages, write some logs, then delete them off the queue. My logs look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>c.n.reactivesqs.SQSListenerBean : message body: message-from-sns
</span></span><span style=display:flex><span>c.n.reactivesqs.SQSListenerBean : message body: message-from-sns
</span></span><span style=display:flex><span>c.n.reactivesqs.SQSListenerBean : deleted message with handle nejjaylz...
</span></span><span style=display:flex><span>c.n.reactivesqs.SQSListenerBean : deleted message with handle ggpzrb....
</span></span><span style=display:flex><span>c.n.reactivesqs.SQSListenerBean : message body: message-from-sns
</span></span><span style=display:flex><span>c.n.reactivesqs.SQSListenerBean : deleted message with handle mgsaut....
</span></span><span style=display:flex><span>c.n.reactivesqs.SQSListenerBean : message body: message-from-sns
</span></span><span style=display:flex><span>c.n.reactivesqs.SQSListenerBean : deleted message with handle aouovw....
</span></span></code></pre></div><p>Remember to <a href=https://github.com/nfisher23/reactive-programming-webflux>check out the source code on github</a>.</p></section><footer><div class="pb-14 taxonomy-list tags-list"><a href=/tags/java/ alt=Java>Java
</a><a href=/tags/spring/ alt=Spring>Spring
</a><a href=/tags/reactive/ alt=Reactive>Reactive
</a><a href=/tags/aws/ alt=Aws>Aws
</a><a href=/tags/webflux/ alt=Webflux>Webflux</a></div></footer></article></main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2"><div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">© 2018-2025 —
<a href=https://www.nickolasfisher.com/>Nick Fisher's tech blog</a></div><div class="order-1 sm:order-2"><ul class="flex sm:justify-end gap-5"><li><a href=https://www.linkedin.com/in/nick-fisher-software/ target=_blank rel="noopener noreferrer">LinkedIn</a></li><li><a href=https://github.com/nfisher23 target=_blank rel="noopener noreferrer">GitHub</a></li></ul></div></footer></body></html>