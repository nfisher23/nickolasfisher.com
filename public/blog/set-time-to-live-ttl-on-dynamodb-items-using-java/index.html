<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Set Time to Live [TTL] on DynamoDB Items using Java</title>
<meta
  name="description"
  content="In this post, we&#39;ll demonstrate how expiring items in DynamoDB works in java, using the AWS SDK 2.0&#43;, which has full reactive support."
/>
<link rel="canonical" href="http://localhost:1313/blog/set-time-to-live-ttl-on-dynamodb-items-using-java/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        about
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">Set Time to Live [TTL] on DynamoDB Items using Java</h2>

    <div class="meta">
      
      <time datetime="2020-10-18 13:43:39 &#43;0000 UTC" title='Sun, Oct 18, 2020, 1:43 PM UTC'>
        18/10/2020 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>In this post, we'll demonstrate how <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/TTL.html">expiring items in DynamoDB</a> works in java, using the AWS SDK 2.0+, which has full reactive support.</p>
<p>We will leverage work done in a previous post, which <a href="https://nickolasfisher.com/blog/Configuring-an-In-Memory-DynamoDB-instance-with-Java-for-Integration-Testing">setup an embedded DynamoDB instance for integration testing</a>, and <a href="https://github.com/nfisher23/webflux-and-dynamo">the source code is available on Github</a> for this and previous posts related to this topic.</p>
<h2 id="background---how-it-works">Background - How it Works</h2>
<p>To start with, the things we'll need to understand to get TTL working are:</p>
<ul>
<li>You must first specify, at the table level, which attribute is the source of truth for when an item expires</li>
<li>The attribute must specify the unix epoch time, in seconds, that the item should expire.</li>
<li>Expiring an item, like many things in Dynamo, is a bit &quot;fuzzy&quot;&ndash;it will expire <em>around</em> the time it is supposed to.</li>
</ul>
<p>Further points and nuances can be found in the documentation for DynamoDB TTL, referenced at the start of this post.</p>
<h2 id="table-setup">Table Setup</h2>
<p>For this example, we'll start by setting up our table in the same way that we have in previous posts:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">testTTL</span>() <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>        String currentTableName <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>#34;PhoneTTLTest<span style="color:#ff79c6">&amp;</span>#34;;
</span></span><span style="display:flex;"><span>        createTableAndWaitForComplete(currentTableName);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>This just leverages code we've already written and I won't rehash that here.</p>
<p>After our test table is created, we will need to specify that TTL is enabled, as well as what attribute dynamo should be looking at to make the decision about when to expire an individual item. Note that in real environments [e.g. production] something like this should really be done with terraform, but this is just integration testing code so all is good:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        String EXPIRE_TIME <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>#34;ExpireTime<span style="color:#ff79c6">&amp;</span>#34;;
</span></span><span style="display:flex;"><span>        dynamoDbAsyncClient.<span style="color:#50fa7b">updateTimeToLive</span>(
</span></span><span style="display:flex;"><span>            UpdateTimeToLiveRequest.<span style="color:#50fa7b">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">tableName</span>(currentTableName)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">timeToLiveSpecification</span>(
</span></span><span style="display:flex;"><span>                        TimeToLiveSpecification.<span style="color:#50fa7b">builder</span>()
</span></span><span style="display:flex;"><span>                                .<span style="color:#50fa7b">enabled</span>(<span style="color:#ff79c6">true</span>)
</span></span><span style="display:flex;"><span>                                .<span style="color:#50fa7b">attributeName</span>(EXPIRE_TIME)
</span></span><span style="display:flex;"><span>                                .<span style="color:#50fa7b">build</span>()
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">build</span>()
</span></span><span style="display:flex;"><span>        ).<span style="color:#50fa7b">get</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(Mono.<span style="color:#50fa7b">fromFuture</span>(dynamoDbAsyncClient.<span style="color:#50fa7b">describeTimeToLive</span>(
</span></span><span style="display:flex;"><span>                DescribeTimeToLiveRequest.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">tableName</span>(currentTableName).<span style="color:#50fa7b">build</span>()))
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">expectNextMatches</span>(describeTimeToLiveResponse <span style="color:#ff79c6">-&amp;</span>gt;
</span></span><span style="display:flex;"><span>                describeTimeToLiveResponse
</span></span><span style="display:flex;"><span>                    .<span style="color:#50fa7b">timeToLiveDescription</span>()
</span></span><span style="display:flex;"><span>                    .<span style="color:#50fa7b">timeToLiveStatus</span>().<span style="color:#50fa7b">equals</span>(TimeToLiveStatus.<span style="color:#50fa7b">ENABLED</span>)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">verifyComplete</span>();
</span></span></code></pre></div><p>This chunk of code just sets the TTL specification, enabling TTL on this table and saying that the attribute of &quot;ExpireTime&quot; should be the source of truth for when an attribute should be expired. We then make a follow up call to verify that the settings we have specified on this table have actually taken effect.</p>
<p>Now let's put an item into this table, specify that it should expire soon, and see dynamo clear it out:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        String partitionKey <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>#34;Google<span style="color:#ff79c6">&amp;</span>#34;;
</span></span><span style="display:flex;"><span>        String rangeKey <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>#34;Pixel 1<span style="color:#ff79c6">&amp;</span>#34;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#ff79c6">&amp;</span>lt;String, AttributeValue<span style="color:#ff79c6">&amp;</span>gt; pixel1ItemAttributes <span style="color:#ff79c6">=</span> getMapWith(partitionKey, rangeKey);
</span></span><span style="display:flex;"><span>        pixel1ItemAttributes.<span style="color:#50fa7b">put</span>(COLOR, AttributeValue.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">s</span>(<span style="color:#ff79c6">&amp;</span>#34;Blue<span style="color:#ff79c6">&amp;</span>#34;).<span style="color:#50fa7b">build</span>());
</span></span><span style="display:flex;"><span>        pixel1ItemAttributes.<span style="color:#50fa7b">put</span>(YEAR, AttributeValue.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">n</span>(<span style="color:#ff79c6">&amp;</span>#34;2012<span style="color:#ff79c6">&amp;</span>#34;).<span style="color:#50fa7b">build</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// expire about 3 seconds from now</span>
</span></span><span style="display:flex;"><span>        String expireTime <span style="color:#ff79c6">=</span> Long.<span style="color:#50fa7b">toString</span>((System.<span style="color:#50fa7b">currentTimeMillis</span>() <span style="color:#ff79c6">/</span> 1000L) <span style="color:#ff79c6">&amp;</span>#43; 3);
</span></span><span style="display:flex;"><span>        pixel1ItemAttributes.<span style="color:#50fa7b">put</span>(
</span></span><span style="display:flex;"><span>                EXPIRE_TIME,
</span></span><span style="display:flex;"><span>                AttributeValue.<span style="color:#50fa7b">builder</span>()
</span></span><span style="display:flex;"><span>                        .<span style="color:#50fa7b">n</span>(expireTime)
</span></span><span style="display:flex;"><span>                        .<span style="color:#50fa7b">build</span>()
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        PutItemRequest populateDataItemRequest <span style="color:#ff79c6">=</span> PutItemRequest.<span style="color:#50fa7b">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">tableName</span>(currentTableName)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">item</span>(pixel1ItemAttributes)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">build</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// put item with TTL into dynamo</span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(Mono.<span style="color:#50fa7b">fromFuture</span>(dynamoDbAsyncClient.<span style="color:#50fa7b">putItem</span>(populateDataItemRequest)))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">expectNextCount</span>(1)
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">verifyComplete</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#ff79c6">&amp;</span>lt;String, AttributeValue<span style="color:#ff79c6">&amp;</span>gt; currentItemKey <span style="color:#ff79c6">=</span> Map.<span style="color:#50fa7b">of</span>(
</span></span><span style="display:flex;"><span>                COMPANY, AttributeValue.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">s</span>(partitionKey).<span style="color:#50fa7b">build</span>(),
</span></span><span style="display:flex;"><span>                MODEL, AttributeValue.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">s</span>(rangeKey).<span style="color:#50fa7b">build</span>()
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// get immediately, should exist</span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(Mono.<span style="color:#50fa7b">fromFuture</span>(dynamoDbAsyncClient.<span style="color:#50fa7b">getItem</span>(
</span></span><span style="display:flex;"><span>                GetItemRequest.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">tableName</span>(currentTableName).<span style="color:#50fa7b">key</span>(currentItemKey).<span style="color:#50fa7b">build</span>()))
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">expectNextMatches</span>(getItemResponse <span style="color:#ff79c6">-&amp;</span>gt; getItemResponse.<span style="color:#50fa7b">hasItem</span>()
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">&amp;</span>amp;<span style="color:#ff79c6">&amp;</span>amp; getItemResponse.<span style="color:#50fa7b">item</span>().<span style="color:#50fa7b">get</span>(COLOR).<span style="color:#50fa7b">s</span>().<span style="color:#50fa7b">equals</span>(<span style="color:#ff79c6">&amp;</span>#34;Blue<span style="color:#ff79c6">&amp;</span>#34;))
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">verifyComplete</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// local dynamo seems to need like 10 seconds to actually clear this out</span>
</span></span><span style="display:flex;"><span>        Thread.<span style="color:#50fa7b">sleep</span>(13000);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        StepVerifier.<span style="color:#50fa7b">create</span>(Mono.<span style="color:#50fa7b">fromFuture</span>(dynamoDbAsyncClient.<span style="color:#50fa7b">getItem</span>(
</span></span><span style="display:flex;"><span>                GetItemRequest.<span style="color:#50fa7b">builder</span>()
</span></span><span style="display:flex;"><span>                        .<span style="color:#50fa7b">key</span>(currentItemKey)
</span></span><span style="display:flex;"><span>                        .<span style="color:#50fa7b">tableName</span>(currentTableName)
</span></span><span style="display:flex;"><span>                        .<span style="color:#50fa7b">build</span>())
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">expectNextMatches</span>(getItemResponse <span style="color:#ff79c6">-&amp;</span>gt; <span style="color:#ff79c6">!</span>getItemResponse.<span style="color:#50fa7b">hasItem</span>())
</span></span><span style="display:flex;"><span>            .<span style="color:#50fa7b">verifyComplete</span>();
</span></span></code></pre></div><p>Here, we set the expire time to be about 3 seconds from now on a created item, then immediately grab it from the table to verify that it exists. After a 13 second sleep [necessary in this case basically because of the behavior of embedded/local dynamo], we then verify that trying to get the same item out of the table returns an empty response.</p>
<p>Remember to <a href="https://github.com/nfisher23/webflux-and-dynamo">check out the source code</a> for this one on Github.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/java/" alt="Java">
          Java
        </a>
      
        <a href="/tags/distributed-systems/" alt="Distributed Systems">
          Distributed Systems
        </a>
      
        <a href="/tags/aws/" alt="Aws">
          Aws
        </a>
      
        <a href="/tags/dynamodb/" alt="Dynamodb">
          Dynamodb
        </a>
      
        <a href="/tags/webflux/" alt="Webflux">
          Webflux
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
