<!doctype html><html lang=en-US class="scroll-smooth dark"><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Setup and Use a DynamoDB Test Container with the AWS Java SDK 2.0</title>
<meta name=description content="The source code for this article can be found on Github.
Using embedded dynamodb for testing is, in my experience, kind of flakey and unpredictable. Because of the weird way it pulls in SQLite on a per operating system basis, it can sometimes work locally and not work on the build server. Sometimes it&rsquo;s just not working for some unexplained reason and wiping the directory that the code is in and re-cloning fixes it. Not a fun time."><link rel=canonical href=https://www.nickolasfisher.com/blog/setup-and-use-a-dynamodb-test-container-with-the-aws-java-sdk-20/><link rel=robots href=/robots.txt><link rel=icon type=image/x-icon href=/img/nficon.png><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><link rel=stylesheet href="https://www.nickolasfisher.com/css/app.min.dee9c4afb37cb95c5d39c976614ef6f95398bcba4b6e73066c44de2a3a6543ed.css"></head><body class="max-w-screen-md mx-auto px-2.5"><div class=header><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12"><div class="flex-none w-20 h-20 rounded-full overflow-hidden"><a href=https://www.nickolasfisher.com/><img srcset="/img/profile-picture_hu4241499301404582006.jpg 80w" src=/img/profile-picture.jpg width=386 height=345 alt="Nick Fisher's tech blog"></a></div><div class="flex flex-col gap-5"><a href=https://www.nickolasfisher.com/><h1 id=site-title>Nick Fisher's tech blog</h1></a><nav><ul><li><a href=/>home</a></li><li><a href=/blog>blog</a></li><li><a href=/about>about</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></header><button class=toggle-theme aria-label="Toggle Theme" title="Toggle Theme" onclick=toggleTheme()>
<span class="theme-icon light"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75.0 11-7.5.0 3.75 3.75.0 017.5.0z"/></svg> </span><span class="theme-icon dark"><svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718.0 0118 15.75c-5.385.0-9.75-4.365-9.75-9.75.0-1.33.266-2.597.748-3.752A9.753 9.753.0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753.0 009.002-5.998z"/></svg> </span></button>
<script>document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("theme");setTheme(!e||e==="light"?"light":e)});function setTheme(e){const t=document.querySelector("html");localStorage.setItem("theme",e),e==="light"?(t.classList.contains("dark")&&document.querySelector("html").classList.remove("dark"),document.querySelector(".theme-icon.light").style.display="none",document.querySelector(".theme-icon.dark").style.display="block"):(t.classList.contains("dark")||document.querySelector("html").classList.add("dark"),document.querySelector(".theme-icon.dark").style.display="none",document.querySelector(".theme-icon.light").style.display="block")}function toggleTheme(){const e=localStorage.getItem("theme");setTheme(e==="light"?"dark":"light")}</script></div><main id=content><article class="flex flex-col gap-10"><header class="flex flex-col gap-2"><h2 class=title-large>Setup and Use a DynamoDB Test Container with the AWS Java SDK 2.0</h2><div class=meta><time datetime="2021-04-10 16:13:09 +0000 UTC" title='Sat, Apr 10, 2021, 4:13 PM UTC'>10/04/2021 - Estimated reading time: 3 minutes</time></div></header><section><p>The source code for this article <a href=https://github.com/nfisher23/webflux-and-dynamo>can be found on Github</a>.</p><p>Using <a href=https://nickolasfisher.com/blog/Configuring-an-In-Memory-DynamoDB-instance-with-Java-for-Integration-Testing>embedded dynamodb for testing</a> is, in my experience, kind of flakey and unpredictable. Because of the weird way it pulls in SQLite on a per operating system basis, it can sometimes work locally and not work on the build server. Sometimes it&rsquo;s just not working for some unexplained reason and wiping the directory that the code is in and re-cloning fixes it. Not a fun time.</p><p>Enter <a href=https://www.testcontainers.org/>test containers</a>. The drawback of test containers is that you need a docker daemon running wherever you&rsquo;re building your app, but outside of that they work very well. And because docker was built specifically to handle the portability issues involved with supporting different OS flavors and versions, anytime you need a mock service or a real service it will work much more predictably. This article will walk you through how to setup a dynamodb test container and use it in java.</p><h3 id=the-example>The Example</h3><p>To start with, you&rsquo;ll need to add a couple of dependencies to your <strong>pom.xml</strong> [or your build.gradle, but I&rsquo;m using maven for this example]:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>        <span style=color:#ff79c6>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&lt;groupId&gt;</span>org.testcontainers<span style=color:#ff79c6>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&lt;artifactId&gt;</span>testcontainers<span style=color:#ff79c6>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&lt;version&gt;</span>1.15.2<span style=color:#ff79c6>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&lt;scope&gt;</span>test<span style=color:#ff79c6>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&lt;groupId&gt;</span>org.testcontainers<span style=color:#ff79c6>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&lt;artifactId&gt;</span>junit-jupiter<span style=color:#ff79c6>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&lt;version&gt;</span>1.15.2<span style=color:#ff79c6>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&lt;scope&gt;</span>test<span style=color:#ff79c6>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>Assuming you&rsquo;re using junit 5, you&rsquo;re a couple of annotations away from having what you want:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Testcontainers
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>DynamoTestContainerTest</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> DynamoDbAsyncClient dynamoDbAsyncClient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Container
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> GenericContainer genericContainer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> GenericContainer(
</span></span><span style=display:flex><span>            DockerImageName.<span style=color:#50fa7b>parse</span>(<span style=color:#f1fa8c>&#34;amazon/dynamodb-local&#34;</span>)
</span></span><span style=display:flex><span>    ).<span style=color:#50fa7b>withExposedPorts</span>(8000);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @BeforeEach
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setupDynamoClient</span>() {
</span></span><span style=display:flex><span>        dynamoDbAsyncClient <span style=color:#ff79c6>=</span> getDynamoClient();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> DynamoDbAsyncClient <span style=color:#50fa7b>getDynamoClient</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> DynamoDbAsyncClient.<span style=color:#50fa7b>builder</span>()
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>region</span>(Region.<span style=color:#50fa7b>US_EAST_1</span>)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>endpointOverride</span>(URI.<span style=color:#50fa7b>create</span>(<span style=color:#f1fa8c>&#34;http://localhost:&#34;</span> <span style=color:#ff79c6>+</span> genericContainer.<span style=color:#50fa7b>getFirstMappedPort</span>()))
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>credentialsProvider</span>(StaticCredentialsProvider.<span style=color:#50fa7b>create</span>(
</span></span><span style=display:flex><span>                        AwsBasicCredentials.<span style=color:#50fa7b>create</span>(<span style=color:#f1fa8c>&#34;FAKE&#34;</span>, <span style=color:#f1fa8c>&#34;FAKE&#34;</span>)))
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If you&rsquo;re not using junit 5, you will basically need to start the container yourself with a <strong>@BeforeEach</strong> annotation. That is relatively straightforward and there&rsquo;s a similar example [using a different container image, but everything else is the same] in a previous article on <a href=https://nickolasfisher.com/blog/How-to-use-a-Redis-Test-Container-with-LettuceSpring-Boot-Webflux>a redis test container for lettuce</a>.</p><p>With this in place, we have our container running and we can create a client ready to use it. I&rsquo;ll do a bad thing and copy-paste some code from the other test class to prove it will actually work once we use it. Here&rsquo;s the full example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>DynamoTestContainerTest</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> String COMPANY <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Company&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd;font-style:italic>final</span> String MODEL <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Model&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> DynamoDbAsyncClient dynamoDbAsyncClient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Container
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> GenericContainer genericContainer <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> GenericContainer(
</span></span><span style=display:flex><span>            DockerImageName.<span style=color:#50fa7b>parse</span>(<span style=color:#f1fa8c>&#34;amazon/dynamodb-local&#34;</span>)
</span></span><span style=display:flex><span>    ).<span style=color:#50fa7b>withExposedPorts</span>(8000);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @BeforeEach
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setupDynamoClient</span>() {
</span></span><span style=display:flex><span>        dynamoDbAsyncClient <span style=color:#ff79c6>=</span> getDynamoClient();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Test
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>testStuff</span>() <span style=color:#8be9fd;font-style:italic>throws</span> Exception {
</span></span><span style=display:flex><span>        ListTablesResponse listTablesResponse <span style=color:#ff79c6>=</span> dynamoDbAsyncClient.<span style=color:#50fa7b>listTables</span>().<span style=color:#50fa7b>get</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>int</span> totalTablesBeforeCreation <span style=color:#ff79c6>=</span> listTablesResponse.<span style=color:#50fa7b>tableNames</span>().<span style=color:#50fa7b>size</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        createTableAsync(<span style=color:#f1fa8c>&#34;Phones&#34;</span>).<span style=color:#50fa7b>get</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ListTablesResponse listTablesResponseAfterCreation <span style=color:#ff79c6>=</span> dynamoDbAsyncClient.<span style=color:#50fa7b>listTables</span>().<span style=color:#50fa7b>get</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        assertThat(listTablesResponseAfterCreation.<span style=color:#50fa7b>tableNames</span>().<span style=color:#50fa7b>size</span>()).<span style=color:#50fa7b>isEqualTo</span>(totalTablesBeforeCreation <span style=color:#ff79c6>+</span> 1);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>static</span> DynamoDbAsyncClient <span style=color:#50fa7b>getDynamoClient</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> DynamoDbAsyncClient.<span style=color:#50fa7b>builder</span>()
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>region</span>(Region.<span style=color:#50fa7b>US_EAST_1</span>)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>endpointOverride</span>(URI.<span style=color:#50fa7b>create</span>(<span style=color:#f1fa8c>&#34;http://localhost:&#34;</span> <span style=color:#ff79c6>+</span> genericContainer.<span style=color:#50fa7b>getFirstMappedPort</span>()))
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>credentialsProvider</span>(StaticCredentialsProvider.<span style=color:#50fa7b>create</span>(
</span></span><span style=display:flex><span>                        AwsBasicCredentials.<span style=color:#50fa7b>create</span>(<span style=color:#f1fa8c>&#34;FAKE&#34;</span>, <span style=color:#f1fa8c>&#34;FAKE&#34;</span>)))
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> CompletableFuture<span style=color:#ff79c6>&lt;</span>CreateTableResponse<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>createTableAsync</span>(String tableName) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> dynamoDbAsyncClient.<span style=color:#50fa7b>createTable</span>(CreateTableRequest.<span style=color:#50fa7b>builder</span>()
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>keySchema</span>(
</span></span><span style=display:flex><span>                        KeySchemaElement.<span style=color:#50fa7b>builder</span>()
</span></span><span style=display:flex><span>                                .<span style=color:#50fa7b>keyType</span>(KeyType.<span style=color:#50fa7b>HASH</span>)
</span></span><span style=display:flex><span>                                .<span style=color:#50fa7b>attributeName</span>(COMPANY)
</span></span><span style=display:flex><span>                                .<span style=color:#50fa7b>build</span>(),
</span></span><span style=display:flex><span>                        KeySchemaElement.<span style=color:#50fa7b>builder</span>()
</span></span><span style=display:flex><span>                                .<span style=color:#50fa7b>keyType</span>(KeyType.<span style=color:#50fa7b>RANGE</span>)
</span></span><span style=display:flex><span>                                .<span style=color:#50fa7b>attributeName</span>(MODEL)
</span></span><span style=display:flex><span>                                .<span style=color:#50fa7b>build</span>()
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>attributeDefinitions</span>(
</span></span><span style=display:flex><span>                        AttributeDefinition.<span style=color:#50fa7b>builder</span>()
</span></span><span style=display:flex><span>                                .<span style=color:#50fa7b>attributeName</span>(COMPANY)
</span></span><span style=display:flex><span>                                .<span style=color:#50fa7b>attributeType</span>(ScalarAttributeType.<span style=color:#50fa7b>S</span>)
</span></span><span style=display:flex><span>                                .<span style=color:#50fa7b>build</span>(),
</span></span><span style=display:flex><span>                        AttributeDefinition.<span style=color:#50fa7b>builder</span>()
</span></span><span style=display:flex><span>                                .<span style=color:#50fa7b>attributeName</span>(MODEL)
</span></span><span style=display:flex><span>                                .<span style=color:#50fa7b>attributeType</span>(ScalarAttributeType.<span style=color:#50fa7b>S</span>)
</span></span><span style=display:flex><span>                                .<span style=color:#50fa7b>build</span>()
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>provisionedThroughput</span>(ProvisionedThroughput.<span style=color:#50fa7b>builder</span>().<span style=color:#50fa7b>readCapacityUnits</span>(100L).<span style=color:#50fa7b>writeCapacityUnits</span>(100L).<span style=color:#50fa7b>build</span>())
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>tableName</span>(tableName)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>build</span>()
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And with that, you should be good to go.</p></section><footer><div class="pb-14 taxonomy-list tags-list"><a href=/tags/java/ alt=Java>Java
</a><a href=/tags/aws/ alt=Aws>Aws
</a><a href=/tags/dynamodb/ alt=Dynamodb>Dynamodb</a></div></footer></article></main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2"><div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">© 2018-2025 —
<a href=https://www.nickolasfisher.com/>Nick Fisher's tech blog</a></div><div class="order-1 sm:order-2"><ul class="flex sm:justify-end gap-5"><li><a href=https://www.linkedin.com/in/nick-fisher-software/ target=_blank rel="noopener noreferrer">LinkedIn</a></li><li><a href=https://github.com/nfisher23 target=_blank rel="noopener noreferrer">GitHub</a></li></ul></div></footer></body></html>