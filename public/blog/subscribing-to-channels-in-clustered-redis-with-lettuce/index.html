<!DOCTYPE html>
<html lang="en-US" class="scroll-smooth dark">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>

<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Subscribing to Channels in Clustered Redis With Lettuce</title>
<meta
  name="description"
  content="We already know how to subscribe to redis using lettuce when it&#39;s not running in clustered mode. If it&#39;s running in clustered mode, it&#39;s not terribly different, but I did discover one thing that is interesting, which is the subject of this article."
/>
<link rel="canonical" href="http://localhost:1313/blog/subscribing-to-channels-in-clustered-redis-with-lettuce/" />
<link rel="robots" href="/robots.txt" />

<link rel="icon" type="image/x-icon" href="/icons/favicon.ico" />



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>

<link rel="stylesheet" href="http://localhost:1313/css/app.css" /></head>

  <body class="max-w-screen-md mx-auto px-2.5">
    <div class="header">
      <header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12">
   


<div class="flex-none w-20 h-20 rounded-full overflow-hidden">
  <a href="http://localhost:1313/">
    <img
      srcset="/img/profile-picture_hu4241499301404582006.jpg 80w"
      src="/img/profile-picture.jpg"
      width="386"
      height="345"
      alt="Nick Fisher&#39;s tech blog"
    />
  </a>
</div>

  
  <div class="flex flex-col gap-5">
    <a href="http://localhost:1313/">
  <h1 id="site-title">Nick Fisher&#39;s tech blog</h1>
</a>
 
    <nav>
  <ul>
     
    
    <li>
      <a href="/" class="">
        Home
      </a>
    </li>
    
    <li>
      <a href="/blog" class="">
        Blog
      </a>
    </li>
    
    <li>
      <a href="/about" class="">
        About me
      </a>
    </li>
    
    <li>
      <a href="/categories" class="">
        Categories
      </a>
    </li>
    
    <li>
      <a href="/tags" class="">
        Tags
      </a>
    </li>
    
  </ul>
</nav>

  </div>
</header>

      <button class="toggle-theme" aria-label="Toggle Theme" title="Toggle Theme" onclick="toggleTheme()">
  <span class="theme-icon light"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg> </span>
  <span class="theme-icon dark"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg> </span>
</button>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const theme = localStorage.getItem('theme');

    if (!theme || theme === 'light') {
      setTheme('light');
    } else {
      setTheme(theme);
    }
  });

  function setTheme(theme) {
    const html = document.querySelector('html');
    localStorage.setItem('theme', theme);

    if (theme === 'light') {
      if (html.classList.contains('dark')) {
        document.querySelector('html').classList.remove('dark');
      }

      document.querySelector('.theme-icon.light').style.display = 'none';
      document.querySelector('.theme-icon.dark').style.display = 'block';
    } else {
      if (!html.classList.contains('dark')) {
        document.querySelector('html').classList.add('dark');
      }

      document.querySelector('.theme-icon.dark').style.display = 'none';
      document.querySelector('.theme-icon.light').style.display = 'block';
    }
  }

  function toggleTheme() {
    const theme = localStorage.getItem('theme');

    if (theme === 'light') {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  }
</script>
    </div>
  
    <main id="content">

<article class="flex flex-col gap-10">
  <header class="flex flex-col gap-2">
    <h2 class="title-large">Subscribing to Channels in Clustered Redis With Lettuce</h2>

    <div class="meta">
      
      <time datetime="2021-04-25 18:43:42 &#43;0000 UTC" title='Sun, Apr 25, 2021, 6:43 PM UTC'>
        25/04/2021 - Estimated reading time: 3 minutes
      </time>

       
      
    </div>
  </header>

  

  <section><p>We already know <a href="https://nickolasfisher.com/blog/Subscribing-to-Redis-Channels-with-Java-Spring-Boot-and-Lettuce">how to subscribe to redis using lettuce</a> when it's not running in clustered mode. If it's running in clustered mode, it's not terribly different, but I did discover one thing that is interesting, which is the subject of this article.</p>
<p>What follows will be much easier to grok if you have already <a href="https://nickolasfisher.com/blog/Bootstrap-a-Local-Sharded-Redis-Cluster-in-Five-Minutes">set up a locally running redis cluster</a> for testing. And the source code for everything that follows <a href="https://github.com/nfisher23/reactive-programming-webflux">can be found on github</a>.</p>
<h3 id="lettuce-configuration">Lettuce Configuration</h3>
<p>Building off a previous article where we <a href="https://nickolasfisher.com/blog/Configuring-LettuceWebflux-to-work-with-Clustered-Redis">configured a spring boot webflux application to connect to clustered redis</a>, we will need to modify our config slightly to support subscriptions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span>@ConfigurationProperties(<span style="color:#ff79c6">&amp;</span>#34;redis<span style="color:#ff79c6">-</span>cluster<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">LettuceConfig</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> String host;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">int</span> port;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...<span style="color:#50fa7b">getters</span> and setters...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean(<span style="color:#ff79c6">&amp;</span>#34;redis<span style="color:#ff79c6">-</span>cluster<span style="color:#ff79c6">-</span>commands<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> RedisClusterReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisPrimaryReactiveCommands(RedisClusterClient redisClusterClient) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> redisClusterClient.<span style="color:#50fa7b">connect</span>().<span style="color:#50fa7b">reactive</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> RedisClusterClient <span style="color:#50fa7b">redisClient</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> RedisClusterClient.<span style="color:#50fa7b">create</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// adjust things like thread pool size with client resources</span>
</span></span><span style="display:flex;"><span>                ClientResources.<span style="color:#50fa7b">builder</span>().<span style="color:#50fa7b">build</span>(),
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&amp;</span>#34;redis:<span style="color:#6272a4">//&amp;#34; &amp;#43; this.getHost() &amp;#43; &amp;#34;:&amp;#34; &amp;#43; this.getPort()</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean(<span style="color:#ff79c6">&amp;</span>#34;redis<span style="color:#ff79c6">-</span>cluster<span style="color:#ff79c6">-</span>pub<span style="color:#ff79c6">-</span>sub<span style="color:#ff79c6">&amp;</span>#34;)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> RedisClusterPubSubReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisClusterPubSub(RedisClusterClient redisClusterClient) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> redisClusterClient.<span style="color:#50fa7b">connectPubSub</span>().<span style="color:#50fa7b">reactive</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We need to add an explicit bean name for <strong>RedisClusterReactiveCommands</strong> because <strong>RedisClusterPubSubReactiveCommands</strong> implements that interface, which will lead to bean clashes in other areas of the code. Let's also modify the <strong>PostConstructExecutor</strong> to accept both types of beans appropriately:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Service
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">PostConstructExecutor</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> Logger LOG <span style="color:#ff79c6">=</span> Loggers.<span style="color:#50fa7b">getLogger</span>(PostConstructExecutor.<span style="color:#50fa7b">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> RedisClusterReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisClusterReactiveCommands;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> RedisClusterPubSubReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisClusterPubSubReactiveCommands;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">PostConstructExecutor</span>(@Qualifier(<span style="color:#ff79c6">&amp;</span>#34;redis<span style="color:#ff79c6">-</span>cluster<span style="color:#ff79c6">-</span>commands<span style="color:#ff79c6">&amp;</span>#34;) RedisClusterReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisClusterReactiveCommands,
</span></span><span style="display:flex;"><span>                                 @Qualifier(<span style="color:#ff79c6">&amp;</span>#34;redis<span style="color:#ff79c6">-</span>cluster<span style="color:#ff79c6">-</span>pub<span style="color:#ff79c6">-</span>sub<span style="color:#ff79c6">&amp;</span>#34;) RedisClusterPubSubReactiveCommands<span style="color:#ff79c6">&amp;</span>lt;String, String<span style="color:#ff79c6">&amp;</span>gt; redisClusterPubSubReactiveCommands) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">redisClusterReactiveCommands</span> <span style="color:#ff79c6">=</span> redisClusterReactiveCommands;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">redisClusterPubSubReactiveCommands</span> <span style="color:#ff79c6">=</span> redisClusterPubSubReactiveCommands;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>With that boilerplate out of the way, we can set up a subscription to any channel we want to in the cluster with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">subscribeToChannel</span>() {
</span></span><span style="display:flex;"><span>        List<span style="color:#ff79c6">&amp;</span>lt;String<span style="color:#ff79c6">&amp;</span>gt; channels <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ArrayList<span style="color:#ff79c6">&amp;</span>lt;<span style="color:#ff79c6">&amp;</span>gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 1; i <span style="color:#ff79c6">&amp;</span>lt;<span style="color:#ff79c6">=</span> 100; i<span style="color:#ff79c6">&amp;</span>#43;<span style="color:#ff79c6">&amp;</span>#43;) {
</span></span><span style="display:flex;"><span>            channels.<span style="color:#50fa7b">add</span>(<span style="color:#ff79c6">&amp;</span>#34;channel<span style="color:#ff79c6">-&amp;</span>#34; <span style="color:#ff79c6">&amp;</span>#43; i);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        redisClusterPubSubReactiveCommands.<span style="color:#50fa7b">subscribe</span>(channels.<span style="color:#50fa7b">toArray</span>(<span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">[</span>0<span style="color:#ff79c6">]</span>))
</span></span><span style="display:flex;"><span>                .<span style="color:#50fa7b">subscribe</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        redisClusterPubSubReactiveCommands.<span style="color:#50fa7b">observeChannels</span>().<span style="color:#50fa7b">doOnNext</span>(channelAndMessage <span style="color:#ff79c6">-&amp;</span>gt; {
</span></span><span style="display:flex;"><span>            LOG.<span style="color:#50fa7b">info</span>(<span style="color:#ff79c6">&amp;</span>#34;channel {}, message {}<span style="color:#ff79c6">&amp;</span>#34;, channelAndMessage.<span style="color:#50fa7b">getChannel</span>(), channelAndMessage.<span style="color:#50fa7b">getMessage</span>());
</span></span><span style="display:flex;"><span>        }).<span style="color:#50fa7b">subscribe</span>();
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>If we start up this app, we are subscribing to channels &quot; <strong>channel-1</strong>&quot;&hellip;all the way up to &quot; <strong>channel-100</strong>&quot;. We can publish to any one of these channels using the cli with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ redis-cli -p <span style="color:#bd93f9">30003</span> -c PUBLISH channel-10 msg
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">(</span>integer<span style="color:#ff79c6">)</span> <span style="color:#bd93f9">0</span>
</span></span></code></pre></div><p>And we can see in the logs of our currently running service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>INFO 22744 <span style="color:#ff79c6">---</span> <span style="color:#ff79c6">[</span>llEventLoop<span style="color:#ff79c6">-</span>5<span style="color:#ff79c6">-</span>4<span style="color:#ff79c6">]</span> c.<span style="color:#50fa7b">n</span>.<span style="color:#50fa7b">c</span>.<span style="color:#50fa7b">PostConstructExecutor</span>              : channel channel<span style="color:#ff79c6">-</span>10, message msg
</span></span></code></pre></div><p>There is one strange thing here though: why does our publish command return 0? It should return the number of subscribers that received a message, which in this case we know is at least [exactly] 1.</p>
<p>The answer is probably that lettuce is subscribing to only one node, and redis will take care of it from there. If we publish every message to the node with port 30001 on our machine, we can see that to every published channel we get back a 1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">for</span> i in <span style="color:#ff79c6">$(</span>seq <span style="color:#bd93f9">1</span> 100<span style="color:#ff79c6">)</span>; <span style="color:#ff79c6">do</span> redis-cli -p <span style="color:#bd93f9">30001</span> -c publish &amp;<span style="color:#6272a4">#34;channel-$i&amp;#34; &amp;#34;message-$i&amp;#34;; done</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">(</span>integer<span style="color:#ff79c6">)</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">(</span>integer<span style="color:#ff79c6">)</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">(</span>integer<span style="color:#ff79c6">)</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">(</span>integer<span style="color:#ff79c6">)</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>...and on and on
</span></span></code></pre></div><p>Even by changing the config of our lettuce client to first connect to node 30002 does not change this. The key takeaway: make sure your application doesn't need to know the number of publishers the received a message, or you might see strange behavior.</p>
</section>

  
    
  

    
  


  <footer>
    
      <div class="pb-14 taxonomy-list tags-list">
      
        <a href="/tags/java/" alt="Java">
          Java
        </a>
      
        <a href="/tags/spring/" alt="Spring">
          Spring
        </a>
      
        <a href="/tags/webflux/" alt="Webflux">
          Webflux
        </a>
      
        <a href="/tags/lettuce/" alt="Lettuce">
          Lettuce
        </a>
      
        <a href="/tags/redis/" alt="Redis">
          Redis
        </a>
      
      </div>
    
  </footer>
</article>


    </main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2">
    <div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">
  © 2018-2025 —
  <a href="http://localhost:1313/">Nick Fisher&#39;s tech blog</a> 
</div>

    <div class="order-1 sm:order-2">
  <ul class="flex sm:justify-end gap-5">
    
    
    <li>    
      <a href="https://www.linkedin.com/in/nick-fisher-software/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </li>
    
    <li>    
      <a href="https://github.com/nfisher23" target="_blank" rel="noopener noreferrer">GitHub</a>
    </li>
    
    
  </ul>
</div>

</footer></body>
</html>
